<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>e-RaporKu - Pendidikan Kesetaraan</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="/data_sdk.js"></script>
  <script src="/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        html, body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            height: 100%;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .sidebar-link.active {
            background-color: #1f2937;
            color: #ffffff;
            font-weight: 600;
            border-left: 4px solid #3b82f6;
            padding-left: calc(1.5rem - 4px);
        }
        
        .toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(-100%);
            opacity: 0;
            z-index: 1000;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .whatsapp-btn {
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }
        
        .whatsapp-btn:hover {
            animation: none;
            transform: scale(1.05);
        }
        
        .whatsapp-btn:hover .whatsapp-text {
            max-width: 200px;
        }
        
        .whatsapp-text {
            max-width: 0;
            overflow: hidden;
            transition: max-width 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        
        @media print {
            @page {
                size: 8.5in 13in; /* F4 size: 21.5cm x 33cm */
                margin: 0.5in;
            }
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                font-size: 10px !important;
            }
            .print-area table {
                font-size: 9px !important;
            }
            .print-area h1 {
                font-size: 16px !important;
            }
            .print-area h2 {
                font-size: 14px !important;
            }
            .print-area h3 {
                font-size: 12px !important;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-100"><!-- Toast Notification -->
  <div id="toast" class="toast fixed top-5 right-5 w-auto max-w-sm p-4 rounded-lg shadow-lg text-white"><span id="toast-message"></span>
  </div><!-- Login Page -->
  <div id="login-page" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
   <div class="max-w-md w-full space-y-8">
    <div>
     <div id="login-logo" class="mx-auto h-20 w-20 bg-blue-600 rounded-full flex items-center justify-center">
      <svg class="h-10 w-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
      </svg>
     </div>
     <h2 id="login-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">e-RaporKu</h2>
     <p class="mt-2 text-center text-sm text-gray-600">Sistem Rapor Pendidikan Kesetaraan</p>
    </div>
    <form id="login-form" class="mt-8 space-y-6" method="POST">
     <div class="rounded-md shadow-sm -space-y-px">
      <div><label for="username" class="sr-only">Username</label> <input id="username" name="username" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Username">
      </div>
      <div><label for="password" class="sr-only">Password</label> <input id="password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password">
      </div>
     </div>
     <div><button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"> Masuk </button>
     </div>
    </form>
   </div>
  </div><!-- WhatsApp Widget - Only show when logged in -->
  <div id="whatsapp-widget" class="fixed bottom-6 right-6 z-50 hidden"><button onclick="openWhatsApp()" class="whatsapp-btn bg-green-500 hover:bg-green-600 text-white rounded-full p-4 shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center group">
    <svg class="w-8 h-8" fill="currentColor" viewbox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488" />
    </svg><span class="whatsapp-text ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap"> Butuh Bantuan? </span> </button>
  </div><!-- Main Application -->
  <div id="main-app" class="hidden flex h-full"><!-- Sidebar -->
   <aside class="hidden md:flex flex-col w-64 bg-gray-800 text-gray-300">
    <div class="flex items-center justify-center h-20 bg-gray-900 border-b border-gray-700">
     <div id="sidebar-logo" class="h-10 w-10 bg-blue-600 rounded-full flex items-center justify-center mr-3">
      <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
      </svg>
     </div><span id="sidebar-title" class="text-white text-lg font-bold">e-RaporKu</span>
    </div>
    <nav class="flex-1 overflow-y-auto">
     <ul class="py-4">
      <li><a href="#" class="sidebar-link active flex items-center px-6 py-3 hover:bg-gray-700" data-target="dashboard">
        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m8 7 4-4 4 4" />
        </svg> Dashboard </a></li>
      <li><a href="#" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700" data-target="siswa">
        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
        </svg> Manajemen Siswa </a></li>
      <li><a href="#" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700" data-target="kelas">
        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
        </svg> Manajemen Kelas </a></li>
      <li><a href="#" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700" data-target="mapel">
        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg> Manajemen Mapel </a></li>
      <li><a href="#" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700" data-target="nilai">
        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
        </svg> Input Nilai </a></li>
      <li><a href="#" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700" data-target="cek-data">
        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg> Cek Data Diri Siswa </a></li>
      <li><a href="#" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700" data-target="cetak">
        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
        </svg> Cetak Rapor </a></li>
      <li><a href="#" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700" data-target="naik-kelas">
        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" />
        </svg> Naik Kelas </a></li>
      <li><a href="#" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700" data-target="ekstrakurikuler">
        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M15 14h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg> Ekstrakurikuler </a></li>
      <li><a href="#" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700" data-target="kehadiran">
        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
        </svg> Kehadiran &amp; Catatan </a></li>
      <li><a href="#" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700" data-target="legger">
        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg> Download Legger Nilai </a></li>
      <li><a href="#" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700" data-target="pengaturan">
        <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg> Pengaturan </a></li>
     </ul>
    </nav>
    <div class="p-4 border-t border-gray-700"><button id="logout-btn" class="w-full flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded-md">
      <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
      </svg> Keluar </button>
    </div>
   </aside><!-- Main Content -->
   <main class="flex-1 overflow-y-auto"><!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
     <div class="flex items-center justify-between px-6 py-4">
      <h1 id="page-title" class="text-2xl font-semibold text-gray-900">Dashboard</h1>
      <div class="flex items-center space-x-4"><span id="school-name" class="text-sm text-gray-600">PKBM/SKB</span> <span class="user-info text-sm text-gray-700 font-medium">Administrator</span>
       <div class="h-8 w-8 bg-blue-600 rounded-full flex items-center justify-center"><span class="text-white text-sm font-medium">A</span>
       </div>
      </div>
     </div>
    </header><!-- Content Area -->
    <div class="p-6"><!-- Dashboard Page -->
     <div id="page-dashboard" class="page-content">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
       <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
         <div class="p-2 bg-blue-100 rounded-lg">
          <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
          </svg>
         </div>
         <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Total Siswa</p>
          <p id="total-siswa" class="text-2xl font-semibold text-gray-900">0</p>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
         <div class="p-2 bg-green-100 rounded-lg">
          <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
         </div>
         <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Total Kelas</p>
          <p id="total-kelas" class="text-2xl font-semibold text-gray-900">0</p>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
         <div class="p-2 bg-yellow-100 rounded-lg">
          <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
          </svg>
         </div>
         <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Total Mapel</p>
          <p id="total-mapel" class="text-2xl font-semibold text-gray-900">0</p>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
         <div class="p-2 bg-purple-100 rounded-lg">
          <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
          </svg>
         </div>
         <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Rapor Selesai</p>
          <p id="total-rapor" class="text-2xl font-semibold text-gray-900">0</p>
         </div>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow">
       <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Selamat Datang di e-RaporKu</h3>
       </div>
       <div class="p-6">
        <p class="text-gray-600 mb-4">Sistem Rapor Digital untuk Pendidikan Kesetaraan yang mendukung Kurikulum Merdeka dan K-13.</p>
        <p class="text-gray-600 mb-4">Peraturan Mendikbudristek Nomor 21 Tahun 2022 tentang Standar Penilaian Pendidikan, yang diterapkan baik untuk Kurikulum 2013 maupun Kurikulum Merdeka.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
         <div class="p-4 bg-blue-50 rounded-lg">
          <h4 class="font-medium text-blue-900 mb-2">Kurikulum Merdeka</h4>
          <p class="text-sm text-blue-700">memberikan fleksibilitas kepada sekolah, guru, dan siswa dalam pembelajaran yang berpusat pada kebutuhan, minat, dan bakat siswa</p>
         </div>
         <div class="p-4 bg-green-50 rounded-lg">
          <h4 class="font-medium text-green-900 mb-2">Kurikulum 2013</h4>
          <p class="text-sm text-green-700">mengembangkan potensi siswa secara holistik dengan fokus pada pengetahuan, keterampilan, sikap, dan karakter.</p>
         </div>
        </div><!-- Panduan Akses Multi-User -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
         <h4 class="font-medium text-yellow-900 mb-3">üåê Akses Multi-User &amp; Jaringan</h4>
         <div class="space-y-3 text-sm text-yellow-800">
          <div><strong>Login Administrator:</strong>
           <ul class="ml-4 mt-1 space-y-1">
            <li>‚Ä¢ Username: <code class="bg-yellow-100 px-1 rounded">admin</code></li>
            <li>‚Ä¢ Password: <code class="bg-yellow-100 px-1 rounded">admin123</code></li>
           </ul>
          </div>
          <div><strong>Login Tutor:</strong>
           <ul class="ml-4 mt-1 space-y-1">
            <li>‚Ä¢ Username: <span class="text-yellow-700">Nama tutor (tanpa spasi, huruf kecil)</span></li>
            <li>‚Ä¢ Password: <span class="text-yellow-700">Nomor HP tutor</span></li>
            <li>‚Ä¢ Contoh: Username <code class="bg-yellow-100 px-1 rounded">budisantoso</code>, Password <code class="bg-yellow-100 px-1 rounded">081234567890</code></li>
           </ul>
          </div>
          <div><strong>Akses Jaringan Lokal:</strong>
           <ul class="ml-4 mt-1 space-y-1">
            <li>‚Ä¢ Pastikan semua perangkat terhubung ke WiFi/jaringan yang sama</li>
            <li>‚Ä¢ Buka browser dan akses alamat IP komputer server</li>
            <li>‚Ä¢ Tutor dapat login menggunakan akun masing-masing</li>
            <li>‚Ä¢ Data tersinkronisasi secara real-time</li>
           </ul>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div><!-- Manajemen Siswa Page -->
     <div id="page-siswa" class="page-content hidden">
      <div class="bg-white rounded-lg shadow">
       <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
         <h3 class="text-lg font-medium text-gray-900">Manajemen Siswa</h3>
         <div class="flex space-x-3"><label for="upload-dapodik" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium cursor-pointer">
           <svg class="h-4 w-4 inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
           </svg> Upload Data Dapodik </label> <input type="file" id="upload-dapodik" accept=".xlsx,.xls" class="hidden"> <button id="tambah-siswa-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
           <svg class="h-4 w-4 inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
           </svg> Tambah Siswa </button>
         </div>
        </div>
       </div>
       <div class="p-6">
        <div class="overflow-x-auto">
         <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIPD</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rombel</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">JK</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Naik</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
           </tr>
          </thead>
          <tbody id="siswa-table-body" class="bg-white divide-y divide-gray-200">
           <tr>
            <td colspan="8" class="px-6 py-4 text-center text-gray-500">Belum ada data siswa. Upload data dapodik atau tambah siswa manual.</td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div><!-- Manajemen Kelas Page -->
     <div id="page-kelas" class="page-content hidden">
      <div class="bg-white rounded-lg shadow">
       <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
         <h3 class="text-lg font-medium text-gray-900">Manajemen Kelas</h3><button id="tambah-kelas-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
          <svg class="h-4 w-4 inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg> Tambah Kelas </button>
        </div>
       </div>
       <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="kelas-grid">
         <div class="text-center text-gray-500 col-span-full">
          Belum ada kelas. Klik "Tambah Kelas" untuk membuat kelas baru.
         </div>
        </div>
       </div>
      </div>
     </div><!-- Manajemen Mapel Page -->
     <div id="page-mapel" class="page-content hidden">
      <div class="bg-white rounded-lg shadow">
       <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
         <h3 class="text-lg font-medium text-gray-900">Manajemen Mata Pelajaran</h3><button id="tambah-mapel-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
          <svg class="h-4 w-4 inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg> Tambah Mapel </button>
        </div>
       </div>
       <div class="p-6">
        <div class="mb-4">
         <div class="flex space-x-4"><button class="kurikulum-tab active px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600" data-kurikulum="merdeka"> Kurikulum Merdeka </button> <button class="kurikulum-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-kurikulum="k13"> Kurikulum 2013 </button>
         </div>
        </div>
        <div class="overflow-x-auto">
         <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Mapel</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Mata Pelajaran</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kurikulum</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
           </tr>
          </thead>
          <tbody id="mapel-table-body" class="bg-white divide-y divide-gray-200">
           <tr>
            <td colspan="5" class="px-6 py-4 text-center text-gray-500">Belum ada mata pelajaran. Klik "Tambah Mapel" untuk menambah mata pelajaran.</td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div><!-- Input Nilai Page -->
     <div id="page-nilai" class="page-content hidden">
      <div class="bg-white rounded-lg shadow">
       <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Input Nilai Siswa</h3>
       </div>
       <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label> <select id="select-kelas-nilai" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Kelas --</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Mata Pelajaran</label> <select id="select-mapel-nilai" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Mata Pelajaran --</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Kurikulum</label> <select id="select-kurikulum-nilai" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="merdeka">Kurikulum Merdeka</option> <option value="k13">Kurikulum 2013</option> </select>
         </div>
        </div>
        <div id="nilai-form-container" class="hidden">
         <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
           <thead class="bg-gray-50">
            <tr>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
             <th id="nilai-header" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
            </tr>
           </thead>
           <tbody id="nilai-table-body" class="bg-white divide-y divide-gray-200">
           </tbody>
          </table>
         </div>
         <div class="mt-6 flex justify-end"><button id="simpan-nilai-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium"> Simpan Nilai </button>
         </div>
        </div>
        <div id="nilai-empty-state" class="text-center text-gray-500 py-8">
         Pilih kelas dan mata pelajaran untuk mulai input nilai.
        </div>
       </div>
      </div>
     </div><!-- Cek Data Diri Siswa Page -->
     <div id="page-cek-data" class="page-content hidden">
      <div class="bg-white rounded-lg shadow">
       <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Cek Data Diri Siswa</h3>
       </div>
       <div class="p-6">
        <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Cari Siswa (NISN atau Nama)</label> <input type="text" id="search-siswa" placeholder="Masukkan NISN atau nama siswa..." class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div id="siswa-detail" class="hidden">
         <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><!-- Data Pribadi -->
          <div class="space-y-4">
           <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2">Data Pribadi</h4>
           <div class="space-y-3">
            <div><label class="block text-sm font-medium text-gray-700">NISN</label>
             <p id="detail-nisn" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">NIPD</label>
             <p id="detail-nipd" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
             <p id="detail-nama" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
             <p id="detail-jk" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Agama</label>
             <p id="detail-agama" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Tempat, Tanggal Lahir</label>
             <p id="detail-ttl" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">NIK</label>
             <p id="detail-nik" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Kelas</label>
             <p id="detail-kelas" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Status</label>
             <p id="detail-status" class="mt-1 text-sm text-gray-900"></p>
            </div>
           </div>
          </div><!-- Data Keluarga -->
          <div class="space-y-4">
           <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2">Data Keluarga</h4>
           <div class="space-y-3">
            <div><label class="block text-sm font-medium text-gray-700">Nama Ayah</label>
             <p id="detail-nama-ayah" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Pekerjaan Ayah</label>
             <p id="detail-pekerjaan-ayah" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Nama Ibu</label>
             <p id="detail-nama-ibu" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Pekerjaan Ibu</label>
             <p id="detail-pekerjaan-ibu" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">No. KK</label>
             <p id="detail-no-kk" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Anak Ke-</label>
             <p id="detail-anak-ke" class="mt-1 text-sm text-gray-900"></p>
            </div>
           </div>
          </div><!-- Data Alamat & Kontak -->
          <div class="space-y-4">
           <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2">Alamat &amp; Kontak</h4>
           <div class="space-y-3">
            <div><label class="block text-sm font-medium text-gray-700">Alamat Lengkap</label>
             <p id="detail-alamat" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">RT/RW</label>
             <p id="detail-rt-rw" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Desa/Kelurahan</label>
             <p id="detail-desa" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Kecamatan</label>
             <p id="detail-kecamatan" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Kabupaten/Kota</label>
             <p id="detail-kabupaten" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Provinsi</label>
             <p id="detail-provinsi" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Kode Pos</label>
             <p id="detail-kode-pos" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">No. HP/Telepon</label>
             <p id="detail-no-hp" class="mt-1 text-sm text-gray-900"></p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Email</label>
             <p id="detail-email" class="mt-1 text-sm text-gray-900"></p>
            </div>
           </div>
          </div>
         </div>
        </div>
        <div id="siswa-not-found" class="hidden text-center text-gray-500 py-8">
         Siswa tidak ditemukan. Periksa kembali NISN atau nama yang dimasukkan.
        </div>
        <div id="siswa-search-empty" class="text-center text-gray-500 py-8">
         Masukkan NISN atau nama siswa untuk mencari data.
        </div>
       </div>
      </div>
     </div><!-- Ekstrakurikuler Page -->
     <div id="page-ekstrakurikuler" class="page-content hidden">
      <div class="bg-white rounded-lg shadow">
       <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Input Ekstrakurikuler Siswa</h3>
       </div>
       <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label> <select id="select-kelas-ekskul" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Kelas --</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester</label> <select id="select-semester-ekskul" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="1">Semester 1 (Ganjil)</option> <option value="2">Semester 2 (Genap)</option> </select>
         </div>
        </div>
        <div id="ekskul-form-container" class="hidden">
         <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
           <thead class="bg-gray-50">
            <tr>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kegiatan Ekstrakurikuler</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Predikat</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
            </tr>
           </thead>
           <tbody id="ekskul-table-body" class="bg-white divide-y divide-gray-200">
           </tbody>
          </table>
         </div>
         <div class="mt-6 flex justify-end"><button id="simpan-ekskul-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium"> Simpan Ekstrakurikuler </button>
         </div>
        </div>
        <div id="ekskul-empty-state" class="text-center text-gray-500 py-8">
         Pilih kelas untuk mulai input ekstrakurikuler siswa.
        </div>
       </div>
      </div>
     </div><!-- Kehadiran & Catatan Page -->
     <div id="page-kehadiran" class="page-content hidden">
      <div class="bg-white rounded-lg shadow">
       <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Input Kehadiran &amp; Catatan Wali Kelas</h3>
       </div>
       <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label> <select id="select-kelas-kehadiran" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Kelas --</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester</label> <select id="select-semester-kehadiran" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="1">Semester 1 (Ganjil)</option> <option value="2">Semester 2 (Genap)</option> </select>
         </div>
        </div>
        <div id="kehadiran-form-container" class="hidden">
         <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
           <thead class="bg-gray-50">
            <tr>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sakit (hari)</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Izin (hari)</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanpa Keterangan (hari)</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan Wali Kelas</th>
            </tr>
           </thead>
           <tbody id="kehadiran-table-body" class="bg-white divide-y divide-gray-200">
           </tbody>
          </table>
         </div>
         <div class="mt-6 flex justify-end"><button id="simpan-kehadiran-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium"> Simpan Kehadiran &amp; Catatan </button>
         </div>
        </div>
        <div id="kehadiran-empty-state" class="text-center text-gray-500 py-8">
         Pilih kelas untuk mulai input kehadiran dan catatan siswa.
        </div>
       </div>
      </div>
     </div><!-- Naik Kelas Page -->
     <div id="page-naik-kelas" class="page-content hidden">
      <div class="bg-white rounded-lg shadow">
       <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Proses Naik Kelas Siswa</h3>
       </div>
       <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label> <select id="select-kelas-naik" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Kelas --</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester</label> <select id="select-semester-naik" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="1">Semester 1 (Ganjil)</option> <option value="2">Semester 2 (Genap)</option> </select>
         </div>
        </div>
        <div id="naik-kelas-form-container" class="hidden">
         <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
           <thead class="bg-gray-50">
            <tr>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas Saat Ini</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Naik</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas Tujuan</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
            </tr>
           </thead>
           <tbody id="naik-kelas-table-body" class="bg-white divide-y divide-gray-200">
           </tbody>
          </table>
         </div>
         <div class="mt-6 flex justify-end"><button id="simpan-semua-naik-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md text-sm font-medium"> Simpan Semua Perubahan </button>
         </div>
        </div>
        <div id="naik-kelas-empty-state" class="text-center text-gray-500 py-8">
         Pilih kelas untuk melihat daftar siswa yang akan diproses naik kelas.
        </div>
       </div>
      </div>
     </div><!-- Download Legger Nilai Page -->
     <div id="page-legger" class="page-content hidden">
      <div class="bg-white rounded-lg shadow">
       <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Download Legger Nilai</h3>
       </div>
       <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label> <select id="select-kelas-legger" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Kelas --</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Kurikulum</label> <select id="select-kurikulum-legger" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="merdeka">Kurikulum Merdeka</option> <option value="k13">Kurikulum 2013</option> </select>
         </div>
         <div class="flex items-end"><button id="download-legger-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
           <svg class="h-4 w-4 inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
           </svg> Download Excel </button>
         </div>
        </div>
        <div id="legger-preview" class="hidden">
         <div class="overflow-x-auto">
          <table id="legger-table" class="min-w-full divide-y divide-gray-200 border border-gray-300">
           <thead class="bg-gray-50">
            <tr id="legger-header"><!-- Header akan diisi dinamis -->
            </tr>
           </thead>
           <tbody id="legger-body" class="bg-white divide-y divide-gray-200"><!-- Data akan diisi dinamis -->
           </tbody>
          </table>
         </div>
        </div>
        <div id="legger-empty-state" class="text-center text-gray-500 py-8">
         Pilih kelas untuk melihat legger nilai.
        </div>
       </div>
      </div>
     </div><!-- Cetak Rapor Page -->
     <div id="page-cetak" class="page-content hidden">
      <div class="bg-white rounded-lg shadow">
       <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Cetak Rapor</h3>
       </div>
       <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Siswa</label> <select id="select-siswa-cetak" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Siswa --</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Template Rapor</label> <select id="select-template-rapor" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="merdeka">Kurikulum Merdeka</option> <option value="k13">Kurikulum 2013</option> </select>
         </div>
         <div class="flex items-end"><button id="preview-rapor-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium mr-2"> Preview </button> <button id="cetak-rapor-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium"> Cetak </button>
         </div>
        </div>
        <div id="rapor-preview" class="hidden print-area"><!-- Preview rapor akan ditampilkan di sini -->
        </div>
        <div id="rapor-empty-state" class="text-center text-gray-500 py-8">
         Pilih siswa dan template untuk melihat preview rapor.
        </div>
       </div>
      </div>
     </div><!-- Pengaturan Page -->
     <div id="page-pengaturan" class="page-content hidden">
      <div class="bg-white rounded-lg shadow">
       <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Pengaturan Aplikasi</h3>
       </div>
       <div class="p-6"><!-- Tab Navigation -->
        <div class="mb-6">
         <div class="flex space-x-4 border-b border-gray-200"><button class="pengaturan-tab active px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600" data-tab="lembaga">
           <svg class="h-4 w-4 inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
           </svg> Data Lembaga </button> <button class="pengaturan-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="akademik">
           <svg class="h-4 w-4 inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 9l2 2 4-4m6-2a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg> Data Akademik </button> <button class="pengaturan-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="tutor">
           <svg class="h-4 w-4 inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
           </svg> Manajemen Tutor </button>
         </div>
        </div><!-- Tab Content: Data Lembaga -->
        <div id="tab-lembaga" class="tab-content">
         <div class="space-y-6">
          <div class="bg-blue-50 p-4 rounded-lg">
           <h4 class="font-medium text-blue-900 mb-2">üìã Informasi Penting</h4>
           <p class="text-sm text-blue-700">Data lembaga ini akan muncul di header rapor dan seluruh dokumen resmi. Logo lembaga akan terintegrasi ke seluruh aplikasi.</p>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Logo Upload -->
           <div class="lg:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Logo Lembaga</label>
            <div class="flex items-center space-x-4">
             <div id="logo-preview" class="w-20 h-20 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300">
              <svg class="h-8 w-8 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
             </div>
             <div><label for="upload-logo" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium cursor-pointer"> Upload Logo </label> <input type="file" id="upload-logo" accept="image/*" class="hidden">
              <p class="text-xs text-gray-500 mt-1">Format: JPG, PNG, SVG (Max: 2MB)</p>
             </div>
            </div>
           </div><!-- Data Lembaga -->
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Lembaga *</label> <input type="text" id="setting-school-name" placeholder="Contoh: PKBM Maju Bersama" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">NPSN</label> <input type="text" id="setting-npsn" placeholder="Nomor Pokok Sekolah Nasional" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           <div class="lg:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Alamat Lengkap *</label> <textarea id="setting-school-address" rows="3" placeholder="Alamat lengkap lembaga..." class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Kecamatan</label> <input type="text" id="setting-kecamatan" placeholder="Nama kecamatan" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Kabupaten/Kota</label> <input type="text" id="setting-kabupaten" placeholder="Nama kabupaten/kota" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Provinsi</label> <input type="text" id="setting-provinsi" placeholder="Nama provinsi" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Kode Pos</label> <input type="text" id="setting-kode-pos" placeholder="12345" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon</label> <input type="text" id="setting-telepon" placeholder="(0321) 123456" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input type="email" id="setting-email" placeholder="info@lembaga.com" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Website</label> <input type="url" id="setting-website" placeholder="https://www.lembaga.com" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div><!-- Kepala Lembaga -->
           <div class="lg:col-span-2 border-t border-gray-200 pt-6">
            <h4 class="text-lg font-medium text-gray-900 mb-4">Data Kepala Lembaga</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
             <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Kepala Lembaga *</label> <input type="text" id="setting-headmaster" placeholder="Nama lengkap kepala lembaga" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
             </div>
             <div><label class="block text-sm font-medium text-gray-700 mb-2">NIP Kepala Lembaga</label> <input type="text" id="setting-headmaster-nip" placeholder="NIP kepala lembaga" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
             </div>
            </div>
           </div>
          </div>
          <div class="flex justify-end pt-4 border-t border-gray-200"><button id="simpan-lembaga-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium"> üíæ Simpan Data Lembaga </button>
          </div>
         </div>
        </div><!-- Tab Content: Data Akademik -->
        <div id="tab-akademik" class="tab-content hidden">
         <div class="space-y-6">
          <div class="bg-green-50 p-4 rounded-lg">
           <h4 class="font-medium text-green-900 mb-2">üìÖ Informasi Penting</h4>
           <p class="text-sm text-green-700">Data akademik ini akan muncul di rapor dan dokumen akademik. Pastikan tahun ajaran dan semester sudah benar.</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran *</label> <input type="text" id="setting-tahun-ajaran" placeholder="2024/2025" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <p class="text-xs text-gray-500 mt-1">Format: YYYY/YYYY</p>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester *</label> <select id="setting-semester" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Semester --</option> <option value="1">Semester 1 (Ganjil)</option> <option value="2">Semester 2 (Genap)</option> </select>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai Semester</label> <input type="date" id="setting-tanggal-mulai" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir Semester</label> <input type="date" id="setting-tanggal-akhir" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           <div class="md:col-span-2">
            <h4 class="text-lg font-medium text-gray-900 mb-4 border-b border-gray-200 pb-2">Penanggalan Rapor</h4>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Tempat Penerbitan Rapor</label> <input type="text" id="setting-tempat-rapor" placeholder="Jombang" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Penerbitan Rapor</label> <input type="date" id="setting-tanggal-rapor" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Kriteria Ketuntasan Minimal (KKM)</label> <input type="number" id="setting-kkm" min="50" max="100" placeholder="75" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <p class="text-xs text-gray-500 mt-1">Nilai minimal untuk mencapai kompetensi (50-100)</p>
           </div>
           <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Catatan Akademik</label> <textarea id="setting-catatan-akademik" rows="3" placeholder="Catatan khusus untuk periode akademik ini..." class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
           </div>
          </div>
          <div class="flex justify-end pt-4 border-t border-gray-200"><button id="simpan-akademik-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md text-sm font-medium"> üìÖ Simpan Data Akademik </button>
          </div>
         </div>
        </div><!-- Tab Content: Manajemen Tutor -->
        <div id="tab-tutor" class="tab-content hidden">
         <div class="space-y-6">
          <div class="bg-purple-50 p-4 rounded-lg">
           <h4 class="font-medium text-purple-900 mb-2">üë®‚Äçüè´ Informasi Penting</h4>
           <p class="text-sm text-purple-700">Data tutor akan terintegrasi ke rapor dan dapat dipilih sebagai wali kelas. TTD tutor akan muncul di rapor.</p>
          </div>
          <div class="flex justify-between items-center">
           <h4 class="text-lg font-medium text-gray-900">Daftar Tutor</h4><button id="tambah-tutor-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-medium">
            <svg class="h-4 w-4 inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg> Tambah Tutor </button>
          </div>
          <div class="overflow-x-auto">
           <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
             <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Tutor</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIP</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. HP</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
             </tr>
            </thead>
            <tbody id="tutor-table-body" class="bg-white divide-y divide-gray-200">
             <tr>
              <td colspan="6" class="px-6 py-4 text-center text-gray-500">Belum ada data tutor. Klik "Tambah Tutor" untuk menambah tutor.</td>
             </tr>
            </tbody>
           </table>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div><!-- Modal Forms --> <!-- Modal Tambah Siswa -->
  <div id="modal-siswa" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
   <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-screen overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
     <h3 class="text-lg font-medium text-gray-900">Tambah Siswa Baru</h3>
    </div>
    <form id="form-siswa" class="p-6 space-y-4 max-h-96 overflow-y-auto"><!-- Data Utama Siswa -->
     <div class="border-b border-gray-200 pb-4">
      <h4 class="text-md font-medium text-gray-900 mb-3">Data Utama Siswa</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-1">NISN <span class="text-xs text-gray-500">(opsional)</span></label> <input type="text" name="nisn" placeholder="Kosongkan jika belum ada NISN" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">NIPD</label> <input type="text" name="nipd" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label> <input type="text" name="nama" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin *</label> <select name="jk" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih --</option> <option value="L">Laki-laki</option> <option value="P">Perempuan</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Agama</label> <select name="agama" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih --</option> <option value="Islam">Islam</option> <option value="Kristen">Kristen</option> <option value="Katolik">Katolik</option> <option value="Hindu">Hindu</option> <option value="Buddha">Buddha</option> <option value="Konghucu">Konghucu</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Tempat Lahir</label> <input type="text" name="tempat_lahir" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Lahir</label> <input type="date" name="tanggal_lahir" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">NIK</label> <input type="text" name="nik" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Rombel</label> <select name="kelas" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Rombel --</option> </select>
       </div>
      </div>
     </div><!-- Data Keluarga -->
     <div class="border-b border-gray-200 pb-4">
      <h4 class="text-md font-medium text-gray-900 mb-3">Data Keluarga</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Nama Ayah</label> <input type="text" name="nama_ayah" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Nama Ibu</label> <input type="text" name="nama_ibu" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Pekerjaan Ayah</label> <input type="text" name="pekerjaan_ayah" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Pekerjaan Ibu</label> <input type="text" name="pekerjaan_ibu" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">No. KK</label> <input type="text" name="no_kk" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Anak Ke-</label> <input type="number" name="anak_ke" min="1" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
      </div>
     </div><!-- Data Alamat -->
     <div class="border-b border-gray-200 pb-4">
      <h4 class="text-md font-medium text-gray-900 mb-3">Data Alamat</h4>
      <div class="space-y-3">
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Alamat Lengkap</label> <textarea name="alamat" rows="2" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
       </div>
       <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">RT</label> <input type="text" name="rt" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">RW</label> <input type="text" name="rw" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">Desa/Kelurahan</label> <input type="text" name="desa" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">Kode Pos</label> <input type="text" name="kode_pos" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">Kecamatan</label> <input type="text" name="kecamatan" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">Kabupaten/Kota</label> <input type="text" name="kabupaten" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">Provinsi</label> <input type="text" name="provinsi" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
       </div>
      </div>
     </div><!-- Data Kontak -->
     <div class="pb-4">
      <h4 class="text-md font-medium text-gray-900 mb-3">Data Kontak</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-1">No. HP/Telepon</label> <input type="text" name="no_hp" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Email</label> <input type="email" name="email" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
      </div>
     </div>
     <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200"><button type="button" id="batal-siswa-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md"> Batal </button> <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md"> Simpan </button>
     </div>
    </form>
   </div>
  </div><!-- Modal Tambah Kelas -->
  <div id="modal-kelas" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
   <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
    <div class="px-6 py-4 border-b border-gray-200">
     <h3 class="text-lg font-medium text-gray-900">Tambah Kelas Baru</h3>
    </div>
    <form id="form-kelas" class="p-6 space-y-4">
     <div><label class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label> <input type="text" name="nama_kelas" required placeholder="Contoh: Paket A, Paket B, Paket C" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-1">Tingkat</label> <select name="tingkat" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Tingkat --</option> <option value="Paket A">Paket A (Setara SD)</option> <option value="Paket B">Paket B (Setara SMP)</option> <option value="Paket C">Paket C (Setara SMA)</option> </select>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-1">Wali Kelas</label> <input type="text" name="wali_kelas" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
     </div>
     <div class="flex justify-end space-x-3 pt-4"><button type="button" id="batal-kelas-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md"> Batal </button> <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md"> Simpan </button>
     </div>
    </form>
   </div>
  </div><!-- Modal Tambah Mapel -->
  <div id="modal-mapel" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
   <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
    <div class="px-6 py-4 border-b border-gray-200">
     <h3 class="text-lg font-medium text-gray-900">Tambah Mata Pelajaran</h3>
    </div>
    <form id="form-mapel" class="p-6 space-y-4">
     <div><label class="block text-sm font-medium text-gray-700 mb-1">Kode Mata Pelajaran</label> <input type="text" name="kode_mapel" required placeholder="Contoh: MTK, IPA, IPS" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-1">Nama Mata Pelajaran</label> <input type="text" name="nama_mapel" required placeholder="Contoh: Matematika, IPA, IPS" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-1">Kurikulum</label> <select name="kurikulum" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Kurikulum --</option> <option value="merdeka">Kurikulum Merdeka</option> <option value="k13">Kurikulum 2013</option> </select>
     </div>
     <div class="flex justify-end space-x-3 pt-4"><button type="button" id="batal-mapel-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md"> Batal </button> <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md"> Simpan </button>
     </div>
    </form>
   </div>
  </div><!-- Modal Atur Kelas -->
  <div id="modal-atur-kelas" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
   <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
     <h3 class="text-lg font-medium text-gray-900">Atur Kelas</h3>
    </div>
    <div class="p-6 max-h-96 overflow-y-auto">
     <div class="space-y-6"><!-- Info Kelas -->
      <div class="bg-gray-50 p-4 rounded-lg">
       <h4 class="font-medium text-gray-900 mb-2">Informasi Kelas</h4>
       <div class="grid grid-cols-2 gap-4 text-sm">
        <div><span class="font-medium text-gray-700">Nama Kelas:</span> <span id="atur-nama-kelas" class="ml-2 text-gray-900"></span>
        </div>
        <div><span class="font-medium text-gray-700">Tingkat:</span> <span id="atur-tingkat-kelas" class="ml-2 text-gray-900"></span>
        </div>
       </div>
      </div><!-- Form Pengaturan -->
      <form id="form-atur-kelas" class="space-y-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Kurikulum yang Digunakan</label> <select name="kurikulum" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Kurikulum --</option> <option value="merdeka">Kurikulum Merdeka</option> <option value="k13">Kurikulum 2013</option> </select>
        <p class="text-xs text-gray-500 mt-1">Kurikulum ini akan mempengaruhi format penilaian dan rapor</p>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Wali Kelas</label> <select name="wali_kelas" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Tutor sebagai Wali Kelas --</option> </select>
        <p class="text-xs text-gray-500 mt-1">Pilih dari daftar tutor yang sudah terdaftar</p>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label> <input type="text" name="tahun_ajaran" placeholder="Contoh: 2024/2025" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester</label> <select name="semester" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Semester --</option> <option value="1">Semester 1 (Ganjil)</option> <option value="2">Semester 2 (Genap)</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Keterangan Tambahan</label> <textarea name="keterangan" rows="3" placeholder="Keterangan khusus untuk kelas ini (opsional)" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
       </div>
      </form><!-- Statistik Kelas -->
      <div class="bg-blue-50 p-4 rounded-lg">
       <h4 class="font-medium text-blue-900 mb-2">Statistik Kelas</h4>
       <div class="grid grid-cols-2 gap-4 text-sm">
        <div><span class="font-medium text-blue-700">Total Siswa:</span> <span id="atur-total-siswa" class="ml-2 text-blue-900"></span>
        </div>
        <div><span class="font-medium text-blue-700">Laki-laki:</span> <span id="atur-siswa-l" class="ml-2 text-blue-900"></span>
        </div>
        <div><span class="font-medium text-blue-700">Perempuan:</span> <span id="atur-siswa-p" class="ml-2 text-blue-900"></span>
        </div>
        <div><span class="font-medium text-blue-700">Status:</span> <span class="ml-2 text-blue-900">Aktif</span>
        </div>
       </div>
      </div>
     </div>
    </div>
    <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3"><button type="button" id="batal-atur-kelas-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md"> Batal </button> <button type="button" id="simpan-atur-kelas-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md"> Simpan Pengaturan </button>
    </div>
   </div>
  </div><!-- Modal Naik Kelas -->
  <div id="modal-naik-kelas" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
   <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
    <div class="px-6 py-4 border-b border-gray-200">
     <h3 class="text-lg font-medium text-gray-900">Naik Kelas</h3>
    </div>
    <form id="form-naik-kelas" class="p-6 space-y-4">
     <div class="bg-blue-50 p-4 rounded-lg mb-4">
      <h4 class="font-medium text-blue-900 mb-2">Informasi Siswa</h4>
      <div class="text-sm text-blue-800">
       <p><span class="font-medium">Nama:</span> <span id="naik-nama-siswa"></span></p>
       <p><span class="font-medium">NISN:</span> <span id="naik-nisn-siswa"></span></p>
       <p><span class="font-medium">Kelas Saat Ini:</span> <span id="naik-kelas-saat-ini"></span></p>
      </div>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Status Kenaikan Kelas</label> <select name="status_naik" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Status --</option> <option value="naik">Naik Kelas</option> <option value="tidak_naik">Tidak Naik Kelas</option> <option value="lulus">Lulus</option> </select>
     </div>
     <div id="kelas-tujuan-container" class="hidden"><label class="block text-sm font-medium text-gray-700 mb-2">Kelas Tujuan</label> <select name="kelas_tujuan" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Kelas Tujuan --</option> </select>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Catatan (Opsional)</label> <textarea name="catatan_naik" rows="3" placeholder="Catatan kenaikan kelas..." class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
     </div>
     <div class="flex justify-end space-x-3 pt-4"><button type="button" id="batal-naik-kelas-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md"> Batal </button> <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md"> Proses Naik Kelas </button>
     </div>
    </form>
   </div>
  </div><!-- Modal Tambah Tutor -->
  <div id="modal-tutor" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
   <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
     <h3 class="text-lg font-medium text-gray-900">Tambah Tutor Baru</h3>
    </div>
    <form id="form-tutor" class="p-6 space-y-4 max-h-96 overflow-y-auto">
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap Tutor *</label> <input type="text" name="nama_tutor" required placeholder="Nama lengkap tutor" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">NIP</label> <input type="text" name="nip" placeholder="NIP tutor (opsional)" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin</label> <select name="jenis_kelamin" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih --</option> <option value="L">Laki-laki</option> <option value="P">Perempuan</option> </select>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Tempat Lahir</label> <input type="text" name="tempat_lahir" placeholder="Tempat lahir" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Lahir</label> <input type="date" name="tanggal_lahir" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Pendidikan Terakhir</label> <select name="pendidikan" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih --</option> <option value="SMA/SMK">SMA/SMK</option> <option value="D3">D3</option> <option value="S1">S1</option> <option value="S2">S2</option> <option value="S3">S3</option> </select>
      </div>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-1">Alamat Lengkap</label> <textarea name="alamat" rows="2" placeholder="Alamat lengkap tutor" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-1">No. HP/Telepon *</label> <input type="text" name="no_hp" required placeholder="08xxxxxxxxxx" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Email</label> <input type="email" name="email" placeholder="email@tutor.com" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-1">Upload Tanda Tangan</label>
      <div class="flex items-center space-x-4">
       <div id="ttd-preview" class="w-32 h-16 bg-gray-100 rounded border-2 border-dashed border-gray-300 flex items-center justify-center"><span class="text-xs text-gray-500">TTD Preview</span>
       </div>
       <div><label for="upload-ttd" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-md text-sm font-medium cursor-pointer"> Upload TTD </label> <input type="file" id="upload-ttd" accept="image/*" class="hidden">
        <p class="text-xs text-gray-500 mt-1">Format: PNG, JPG (Max: 1MB)</p>
       </div>
      </div>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-1">Status</label> <select name="status" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="Aktif">Aktif</option> <option value="Tidak Aktif">Tidak Aktif</option> <option value="Cuti">Cuti</option> </select>
     </div>
     <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200"><button type="button" id="batal-tutor-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md"> Batal </button> <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-md"> Simpan Tutor </button>
     </div>
    </form>
   </div>
  </div>
  <script>
        // Default configuration
        const defaultConfig = {
            app_title: "e-RaporKu",
            school_name: "PKBM/SKB"
        };

        // Configuration object
        let currentConfig = { ...defaultConfig };

        // Initialize Element SDK
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig: defaultConfig,
                onConfigChange: async (newConfig) => {
                    // Update UI elements based on config
                    document.getElementById('login-title').textContent = newConfig.app_title || defaultConfig.app_title;
                    document.getElementById('sidebar-title').textContent = newConfig.app_title || defaultConfig.app_title;
                    document.getElementById('school-name').textContent = newConfig.school_name || defaultConfig.school_name;
                    
                    // Update settings form
                    document.getElementById('setting-app-name').value = newConfig.app_title || defaultConfig.app_title;
                    document.getElementById('setting-school-name').value = newConfig.school_name || defaultConfig.school_name;
                },
                mapToCapabilities: (config) => ({
                    recolorables: [],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["app_title", config.app_title || defaultConfig.app_title],
                    ["school_name", config.school_name || defaultConfig.school_name]
                ])
            });
        }

        // Data storage
        let appData = {
            siswa: [],
            kelas: [],
            mapel: [],
            nilai: [],
            tutor: [],
            ekstrakurikuler: [],
            kehadiran: [],
            settings: {
                // Data Lembaga
                app_name: "e-RaporKu",
                school_name: "PKBM/SKB",
                npsn: "",
                school_address: "",
                kecamatan: "",
                kabupaten: "",
                provinsi: "",
                kode_pos: "",
                telepon: "",
                email: "",
                website: "",
                headmaster: "",
                headmaster_nip: "",
                logo_url: "",
                
                // Data Akademik
                tahun_ajaran: "",
                semester: "",
                tanggal_mulai: "",
                tanggal_akhir: "",
                tempat_rapor: "",
                tanggal_rapor: "",
                catatan_akademik: "",
                kkm: "75"
            }
        };

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('eraporku_data');
            if (saved) {
                appData = { ...appData, ...JSON.parse(saved) };
            }
            updateDashboardStats();
            loadSettingsForm();
            
            // Load logo if exists
            if (appData.settings.logo_url) {
                updateAppLogo(appData.settings.logo_url);
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('eraporku_data', JSON.stringify(appData));
            updateDashboardStats();
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const messageEl = document.getElementById('toast-message');
            
            messageEl.textContent = message;
            toast.className = `toast fixed top-5 right-5 w-auto max-w-sm p-4 rounded-lg shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // User session management
        let currentUser = {
            username: '',
            level: '',
            tutor_id: '',
            nama: ''
        };

        // Authentication
        function checkAuth() {
            const userData = localStorage.getItem('eraporku_user');
            if (userData) {
                currentUser = JSON.parse(userData);
                showMainApp();
                setupUserInterface();
                document.getElementById('whatsapp-widget').classList.remove('hidden');
            } else {
                showLoginPage();
            }
        }

        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('whatsapp-widget').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('whatsapp-widget').classList.remove('hidden');
            loadData();
        }

        // Setup UI based on user level
        function setupUserInterface() {
            const isAdmin = currentUser.level === 'admin';
            const isTutor = currentUser.level === 'tutor';
            
            // Hide admin-only menu items for tutors
            const adminMenus = ['siswa', 'kelas', 'mapel', 'pengaturan'];
            adminMenus.forEach(menu => {
                const menuItem = document.querySelector(`[data-target="${menu}"]`);
                if (menuItem) {
                    if (isAdmin) {
                        menuItem.parentElement.style.display = 'block';
                    } else {
                        menuItem.parentElement.style.display = 'none';
                    }
                }
            });

            // Update user info in header
            const userInfo = document.querySelector('.user-info');
            if (userInfo) {
                userInfo.textContent = `${currentUser.nama} (${currentUser.level === 'admin' ? 'Administrator' : 'Tutor'})`;
            }

            // Show appropriate default page
            if (isTutor) {
                // Redirect tutor to dashboard
                document.querySelector('[data-target="dashboard"]').click();
            }
        }

        // Enhanced login form handler
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.toLowerCase().trim();
            const password = document.getElementById('password').value.trim();
            
            // Check admin login
            if (username === 'admin' && password === 'admin123') {
                currentUser = {
                    username: 'admin',
                    level: 'admin',
                    tutor_id: '',
                    nama: 'Administrator'
                };
                localStorage.setItem('eraporku_user', JSON.stringify(currentUser));
                showMainApp();
                setupUserInterface();
                showToast('Login berhasil! Selamat datang Administrator');
                return;
            }
            
            // Check tutor login
            const tutor = appData.tutor.find(t => {
                const tutorUsername = t.nama_tutor.toLowerCase().replace(/\s+/g, '');
                return tutorUsername === username && t.no_hp === password && t.status === 'Aktif';
            });
            
            if (tutor) {
                currentUser = {
                    username: username,
                    level: 'tutor',
                    tutor_id: tutor.id,
                    nama: tutor.nama_tutor
                };
                localStorage.setItem('eraporku_user', JSON.stringify(currentUser));
                showMainApp();
                setupUserInterface();
                showToast(`Selamat datang, ${tutor.nama_tutor}!`);
                return;
            }
            
            showToast('Username atau password salah!', 'error');
        });

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', function() {
            localStorage.removeItem('eraporku_user');
            currentUser = { username: '', level: '', tutor_id: '', nama: '' };
            showLoginPage();
            showToast('Anda telah keluar dari sistem');
        });

        // Navigation
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all links
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                
                // Add active class to clicked link
                this.classList.add('active');
                
                // Hide all pages
                document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
                
                // Show target page
                const target = this.dataset.target;
                document.getElementById('page-' + target).classList.remove('hidden');
                
                // Update page title
                const titles = {
                    'dashboard': 'Dashboard',
                    'siswa': 'Manajemen Siswa',
                    'kelas': 'Manajemen Kelas',
                    'mapel': 'Manajemen Mata Pelajaran',
                    'nilai': 'Input Nilai',
                    'cek-data': 'Cek Data Diri Siswa',
                    'naik-kelas': 'Naik Kelas',
                    'ekstrakurikuler': 'Ekstrakurikuler',
                    'kehadiran': 'Kehadiran & Catatan',
                    'legger': 'Download Legger Nilai',
                    'cetak': 'Cetak Rapor',
                    'pengaturan': 'Pengaturan'
                };
                document.getElementById('page-title').textContent = titles[target] || 'Dashboard';
                
                // Load specific page data
                if (target === 'siswa') loadSiswaTable();
                if (target === 'kelas') loadKelasGrid();
                if (target === 'mapel') loadMapelTable();
                if (target === 'nilai') loadNilaiSelectors();
                if (target === 'naik-kelas') loadNaikKelasSelectors();
                if (target === 'ekstrakurikuler') loadEkskulSelectors();
                if (target === 'kehadiran') loadKehadiranSelectors();
                if (target === 'legger') loadLeggerSelectors();
                if (target === 'cetak') loadCetakSelectors();
            });
        });

        // Update dashboard statistics
        function updateDashboardStats() {
            document.getElementById('total-siswa').textContent = appData.siswa.length;
            document.getElementById('total-kelas').textContent = appData.kelas.length;
            document.getElementById('total-mapel').textContent = appData.mapel.length;
            document.getElementById('total-rapor').textContent = appData.siswa.filter(s => s.rapor_selesai).length;
        }

        // Siswa Management
        function loadSiswaTable() {
            const tbody = document.getElementById('siswa-table-body');
            
            if (appData.siswa.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Belum ada data siswa. Upload data dapodik atau tambah siswa manual.</td></tr>';
                return;
            }
            
            tbody.innerHTML = appData.siswa.map((siswa, index) => {
                const statusNaik = getStatusNaikKelas(siswa);
                const isGanjil = appData.settings.semester === '1';
                
                return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${siswa.nisn.startsWith('TEMP_') ? 
                            `<span class="text-orange-600 text-xs">NISN Kosong</span>` : 
                            siswa.nisn
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nipd || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${statusNaik.class}">${siswa.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.kelas || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.jk === 'L' ? 'L' : siswa.jk === 'P' ? 'P' : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${isGanjil ? 
                            '<span class="text-gray-500 text-xs">Semester 1</span>' : 
                            `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusNaik.badgeClass}">
                                ${statusNaik.text}
                            </span>`
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editSiswa('${siswa.nisn}')" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                        <button onclick="naikKelas('${siswa.nisn}')" class="text-green-600 hover:text-green-900 mr-2" title="Naik Kelas">
                            <svg class="h-4 w-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
                            </svg>
                        </button>
                        <button onclick="deleteSiswa('${siswa.nisn}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Load kelas options for siswa form
        function loadKelasOptions() {
            const selects = document.querySelectorAll('select[name="kelas"]');
            selects.forEach(select => {
                select.innerHTML = '<option value="">-- Pilih Kelas --</option>' +
                    appData.kelas.map(kelas => `<option value="${kelas.nama_kelas}">${kelas.nama_kelas}</option>`).join('');
            });
        }

        // Siswa form handlers
        document.getElementById('tambah-siswa-btn').addEventListener('click', function() {
            loadKelasOptions();
            document.getElementById('modal-siswa').classList.remove('hidden');
            document.getElementById('modal-siswa').classList.add('flex');
        });

        document.getElementById('batal-siswa-btn').addEventListener('click', function() {
            document.getElementById('modal-siswa').classList.add('hidden');
            document.getElementById('modal-siswa').classList.remove('flex');
            document.getElementById('form-siswa').reset();
        });

        document.getElementById('form-siswa').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const siswa = {
                // Data Utama
                nisn: formData.get('nisn'),
                nipd: formData.get('nipd') || '',
                nama: formData.get('nama'),
                jk: formData.get('jk'),
                agama: formData.get('agama'),
                tempat_lahir: formData.get('tempat_lahir'),
                tanggal_lahir: formData.get('tanggal_lahir'),
                nik: formData.get('nik'),
                kelas: formData.get('kelas'),
                
                // Data Keluarga
                nama_ayah: formData.get('nama_ayah'),
                nama_ibu: formData.get('nama_ibu'),
                pekerjaan_ayah: formData.get('pekerjaan_ayah'),
                pekerjaan_ibu: formData.get('pekerjaan_ibu'),
                no_kk: formData.get('no_kk'),
                anak_ke: formData.get('anak_ke'),
                
                // Data Alamat
                alamat: formData.get('alamat'),
                rt: formData.get('rt'),
                rw: formData.get('rw'),
                desa: formData.get('desa'),
                kecamatan: formData.get('kecamatan'),
                kabupaten: formData.get('kabupaten'),
                provinsi: formData.get('provinsi'),
                kode_pos: formData.get('kode_pos'),
                
                // Data Kontak
                no_hp: formData.get('no_hp'),
                email: formData.get('email'),
                
                status: 'Aktif'
            };
            
            // Jika NISN kosong, buat NISN sementara
            if (!siswa.nisn || siswa.nisn.trim() === '') {
                siswa.nisn = 'TEMP_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            } else {
                // Check if NISN already exists (hanya jika bukan NISN sementara)
                if (appData.siswa.find(s => s.nisn === siswa.nisn && !s.nisn.startsWith('TEMP_'))) {
                    showToast('NISN sudah ada!', 'error');
                    return;
                }
            }
            
            appData.siswa.push(siswa);
            saveData();
            loadSiswaTable();
            
            document.getElementById('modal-siswa').classList.add('hidden');
            document.getElementById('modal-siswa').classList.remove('flex');
            this.reset();
            
            showToast('Siswa berhasil ditambahkan!');
        });

        // Delete siswa
        function deleteSiswa(nisn) {
            if (confirm('Apakah Anda yakin ingin menghapus siswa ini?')) {
                appData.siswa = appData.siswa.filter(s => s.nisn !== nisn);
                saveData();
                loadSiswaTable();
                showToast('Siswa berhasil dihapus!');
            }
        }

        // Upload Dapodik Excel
        document.getElementById('upload-dapodik').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Show loading state
            showToast('Sedang memproses file Excel...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    console.log('üîÑ File loaded, processing...');
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (workbook.SheetNames.length === 0) {
                        showToast('File Excel tidak memiliki sheet data!', 'error');
                        return;
                    }
                    
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    console.log('üìä Processing sheet:', sheetName);
                    
                    // Handle merged cells - ambil data mentah dulu
                    const range = XLSX.utils.decode_range(worksheet['!ref']);
                    console.log('üìä Worksheet range:', range);
                    
                    // Check for merged cells
                    const merges = worksheet['!merges'] || [];
                    console.log('üîó Merged cells found:', merges.length);
                    
                    // Convert to JSON dengan handling merge cells
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        defval: '',
                        blankrows: false,
                        raw: false,
                        range: range
                    });
                    
                    console.log('üìà Total rows found:', jsonData.length);
                    console.log('üîç First 5 rows preview:', jsonData.slice(0, 5));
                    
                    if (jsonData.length < 2) {
                        showToast('File Excel kosong atau tidak memiliki data!', 'error');
                        return;
                    }
                    
                    // Cari header row yang sebenarnya (skip merged header rows)
                    let headerRowIndex = 0;
                    let headers = [];
                    
                    // Coba beberapa baris pertama untuk menemukan header yang valid
                    for (let i = 0; i < Math.min(5, jsonData.length); i++) {
                        const row = jsonData[i];
                        if (!row) continue;
                        
                        const potentialHeaders = row.map(h => String(h || '').trim().toLowerCase());
                        const validHeaders = potentialHeaders.filter(h => h && h.length > 0);
                        
                        console.log(`üîç Row ${i} potential headers:`, potentialHeaders);
                        console.log(`‚úÖ Valid headers count: ${validHeaders.length}`);
                        
                        // Cek apakah ini baris header yang valid (minimal 3 kolom berisi)
                        if (validHeaders.length >= 3) {
                            // Cek apakah ada kata kunci header yang dikenal
                            const knownKeywords = ['nisn', 'nama', 'kelas', 'jk', 'kelamin', 'nis', 'induk'];
                            const hasKnownKeyword = validHeaders.some(h => 
                                knownKeywords.some(keyword => h.includes(keyword))
                            );
                            
                            if (hasKnownKeyword) {
                                headerRowIndex = i;
                                headers = potentialHeaders;
                                console.log(`üéØ Header row found at index ${i}`);
                                break;
                            }
                        }
                    }
                    
                    // Jika tidak menemukan header yang valid, gunakan baris pertama
                    if (headers.length === 0) {
                        console.log('‚ö†Ô∏è No clear header found, using first row');
                        headerRowIndex = 0;
                        headers = jsonData[0].map(h => String(h || '').trim().toLowerCase());
                    }
                    
                    console.log('üìã Final headers detected:', headers);
                    console.log('üìç Header row index:', headerRowIndex);
                    
                    // Mapping kolom yang lebih fleksibel - fokus pada NIPD, NISN, dan rombel
                    const columnMap = {
                        nisn: findFlexibleColumn(headers, ['nisn']),
                        nipd: findFlexibleColumn(headers, ['nipd']),
                        nama: findFlexibleColumn(headers, ['nama', 'nama lengkap', 'nama siswa', 'nama peserta didik']),
                        jk: findFlexibleColumn(headers, ['jk', 'jenis kelamin', 'kelamin', 'l/p', 'gender']),
                        tempat_lahir: findFlexibleColumn(headers, ['tempat lahir', 'tmp lahir', 'tempat_lahir']),
                        tanggal_lahir: findFlexibleColumn(headers, ['tanggal lahir', 'tgl lahir', 'tanggal_lahir', 'tgl_lahir']),
                        kelas: findFlexibleColumn(headers, ['rombel saat ini', 'rombel', 'kelas', 'tingkat', 'rombongan belajar']),
                        agama: findFlexibleColumn(headers, ['agama']),
                        nik: findFlexibleColumn(headers, ['nik', 'no ktp']),
                        
                        // Data Keluarga
                        nama_ayah: findFlexibleColumn(headers, ['nama ayah', 'ayah', 'nama_ayah']),
                        nama_ibu: findFlexibleColumn(headers, ['nama ibu', 'ibu', 'nama_ibu']),
                        pekerjaan_ayah: findFlexibleColumn(headers, ['pekerjaan ayah', 'kerja ayah', 'pekerjaan_ayah']),
                        pekerjaan_ibu: findFlexibleColumn(headers, ['pekerjaan ibu', 'kerja ibu', 'pekerjaan_ibu']),
                        
                        // Data Alamat
                        alamat: findFlexibleColumn(headers, ['alamat', 'alamat lengkap']),
                        rt: findFlexibleColumn(headers, ['rt']),
                        rw: findFlexibleColumn(headers, ['rw']),
                        desa: findFlexibleColumn(headers, ['desa', 'kelurahan']),
                        kecamatan: findFlexibleColumn(headers, ['kecamatan']),
                        kabupaten: findFlexibleColumn(headers, ['kabupaten', 'kota']),
                        provinsi: findFlexibleColumn(headers, ['provinsi']),
                        kode_pos: findFlexibleColumn(headers, ['kode pos', 'pos']),
                        
                        // Data Kontak
                        no_hp: findFlexibleColumn(headers, ['no hp', 'telepon', 'hp', 'no_hp']),
                        email: findFlexibleColumn(headers, ['email', 'e-mail']),
                        no_kk: findFlexibleColumn(headers, ['no kk', 'kartu keluarga', 'no_kk']),
                        anak_ke: findFlexibleColumn(headers, ['anak ke', 'anak_ke'])
                    };
                    
                    console.log('üó∫Ô∏è Column mapping result:', columnMap);
                    
                    // Cek kolom wajib
                    const requiredFound = columnMap.nisn !== -1 && columnMap.nama !== -1;
                    if (!requiredFound) {
                        console.error('‚ùå Required columns not found:', {
                            nisn_found: columnMap.nisn !== -1,
                            nama_found: columnMap.nama !== -1
                        });
                        showToast('Kolom NISN atau Nama tidak ditemukan! Periksa format file Excel.', 'error');
                        return;
                    }
                    
                    let imported = 0;
                    let updated = 0;
                    let skipped = 0;
                    let errors = [];
                    let kelasCreated = 0;
                    const kelasSet = new Set();
                    
                    console.log('üîÑ Starting data processing...');
                    
                    // Process data rows (skip header row yang sudah diidentifikasi)
                    for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        
                        // Skip completely empty rows
                        if (!row || row.every(cell => !cell || String(cell).trim() === '')) {
                            continue;
                        }
                        
                        // Extract raw values
                        const rawNisn = row[columnMap.nisn];
                        const rawNama = row[columnMap.nama];
                        
                        // Debug untuk 3 baris pertama data (setelah header)
                        if (i <= headerRowIndex + 3) {
                            console.log(`üìù Row ${i} (data row ${i - headerRowIndex}) raw data:`, {
                                nisn: rawNisn,
                                nama: rawNama,
                                nipd: columnMap.nipd !== -1 ? row[columnMap.nipd] : 'N/A',
                                nipd_cleaned: columnMap.nipd !== -1 ? (cleanNumericField(row[columnMap.nipd]) || 'KOSONG') : 'N/A',
                                rombel: columnMap.kelas !== -1 ? row[columnMap.kelas] : 'N/A',
                                jk: columnMap.jk !== -1 ? row[columnMap.jk] : 'N/A',
                                fullRow: row.slice(0, 10) // Show first 10 columns
                            });
                        }
                        
                        // Validasi dan pembersihan data yang lebih permisif
                        const cleanNisn = cleanAndValidateNisn(rawNisn);
                        const cleanNama = cleanAndValidateName(rawNama);
                        
                        // Skip hanya jika nama tidak valid (NISN boleh kosong)
                        // NISN kosong diizinkan untuk siswa yang belum memiliki NISN
                        
                        if (!cleanNama) {
                            errors.push(`Baris ${i + 1}: Nama tidak valid atau kosong (${rawNama})`);
                            skipped++;
                            continue;
                        }
                        
                        // Jika NISN kosong, buat NISN sementara berdasarkan nama dan timestamp
                        let finalNisn = cleanNisn;
                        if (!finalNisn || finalNisn.trim() === '') {
                            finalNisn = 'TEMP_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                            console.log(`üîÑ Generated temporary NISN for ${cleanNama}: ${finalNisn}`);
                        }
                        
                        // Build siswa object dengan data yang sudah dibersihkan
                        const siswa = {
                            // Data Utama
                            nisn: finalNisn,
                            nipd: columnMap.nipd !== -1 ? (cleanNumericField(row[columnMap.nipd]) || '') : '',
                            nama: cleanNama,
                            jk: normalizeJenisKelamin(row[columnMap.jk]),
                            tempat_lahir: columnMap.tempat_lahir !== -1 ? cleanTextField(row[columnMap.tempat_lahir]) : '',
                            tanggal_lahir: columnMap.tanggal_lahir !== -1 ? formatTanggal(row[columnMap.tanggal_lahir]) : '',
                            kelas: columnMap.kelas !== -1 ? cleanTextField(row[columnMap.kelas]) : '',
                            agama: columnMap.agama !== -1 ? cleanTextField(row[columnMap.agama]) : '',
                            nik: columnMap.nik !== -1 ? cleanNumericField(row[columnMap.nik]) : '',
                            
                            // Data Keluarga
                            nama_ayah: columnMap.nama_ayah !== -1 ? cleanTextField(row[columnMap.nama_ayah]) : '',
                            nama_ibu: columnMap.nama_ibu !== -1 ? cleanTextField(row[columnMap.nama_ibu]) : '',
                            pekerjaan_ayah: columnMap.pekerjaan_ayah !== -1 ? cleanTextField(row[columnMap.pekerjaan_ayah]) : '',
                            pekerjaan_ibu: columnMap.pekerjaan_ibu !== -1 ? cleanTextField(row[columnMap.pekerjaan_ibu]) : '',
                            
                            // Data Alamat
                            alamat: columnMap.alamat !== -1 ? cleanTextField(row[columnMap.alamat]) : '',
                            rt: columnMap.rt !== -1 ? cleanTextField(row[columnMap.rt]) : '',
                            rw: columnMap.rw !== -1 ? cleanTextField(row[columnMap.rw]) : '',
                            desa: columnMap.desa !== -1 ? cleanTextField(row[columnMap.desa]) : '',
                            kecamatan: columnMap.kecamatan !== -1 ? cleanTextField(row[columnMap.kecamatan]) : '',
                            kabupaten: columnMap.kabupaten !== -1 ? cleanTextField(row[columnMap.kabupaten]) : '',
                            provinsi: columnMap.provinsi !== -1 ? cleanTextField(row[columnMap.provinsi]) : '',
                            kode_pos: columnMap.kode_pos !== -1 ? cleanTextField(row[columnMap.kode_pos]) : '',
                            
                            // Data Kontak
                            no_hp: columnMap.no_hp !== -1 ? cleanTextField(row[columnMap.no_hp]) : '',
                            email: columnMap.email !== -1 ? cleanTextField(row[columnMap.email]) : '',
                            no_kk: columnMap.no_kk !== -1 ? cleanNumericField(row[columnMap.no_kk]) : '',
                            anak_ke: columnMap.anak_ke !== -1 ? cleanTextField(row[columnMap.anak_ke]) : '',
                            
                            status: 'Aktif'
                        };
                        
                        console.log(`‚úÖ Processed row ${i + 1}:`, {
                            nisn: siswa.nisn,
                            nama: siswa.nama,
                            kelas: siswa.kelas,
                            jk: siswa.jk
                        });
                        
                        // Auto-create kelas jika ada
                        if (siswa.kelas && siswa.kelas.trim() !== '' && !kelasSet.has(siswa.kelas)) {
                            const existingKelas = appData.kelas.find(k => k.nama_kelas === siswa.kelas);
                            if (!existingKelas) {
                                let tingkat = 'Paket C'; // default
                                const kelasLower = siswa.kelas.toLowerCase();
                                
                                // Deteksi berdasarkan angka romawi untuk SMP/SMA
                                if (kelasLower.includes('vii') || kelasLower.includes('viii') || kelasLower.includes('ix') || 
                                    kelasLower.includes('paket b') || kelasLower.includes('setara smp')) {
                                    tingkat = 'Paket B';
                                } else if (kelasLower.includes('x') || kelasLower.includes('xi') || kelasLower.includes('xii') || 
                                          kelasLower.includes('paket c') || kelasLower.includes('setara sma')) {
                                    tingkat = 'Paket C';
                                } else if (kelasLower.includes('paket a') || kelasLower.includes('setara sd') ||
                                          kelasLower.includes('i') || kelasLower.includes('ii') || kelasLower.includes('iii') ||
                                          kelasLower.includes('iv') || kelasLower.includes('v') || kelasLower.includes('vi')) {
                                    tingkat = 'Paket A';
                                }
                                
                                appData.kelas.push({
                                    id: Date.now().toString() + Math.random(),
                                    nama_kelas: siswa.kelas,
                                    tingkat: tingkat,
                                    wali_kelas: '',
                                    jumlah_siswa: 0
                                });
                                kelasCreated++;
                                console.log(`üè´ Kelas baru dibuat: ${siswa.kelas} (${tingkat})`);
                            }
                            kelasSet.add(siswa.kelas);
                        }
                        
                        // Check if NISN already exists (skip check for temporary NISN)
                        const existingIndex = siswa.nisn.startsWith('TEMP_') ? -1 : appData.siswa.findIndex(s => s.nisn === siswa.nisn);
                        if (existingIndex !== -1) {
                            // Update existing student
                            appData.siswa[existingIndex] = { ...appData.siswa[existingIndex], ...siswa };
                            updated++;
                            console.log(`üîÑ Updated student: ${siswa.nama}`);
                        } else {
                            // Add new student
                            appData.siswa.push(siswa);
                            imported++;
                            console.log(`‚ûï Added new student: ${siswa.nama} (NISN: ${siswa.nisn})`);
                        }
                    }
                    
                    // Save and refresh
                    saveData();
                    loadSiswaTable();
                    loadKelasGrid();
                    
                    // Show results
                    console.log('üìä Import summary:', { imported, updated, skipped, kelasCreated, errors: errors.length });
                    
                    let message = `Import selesai! `;
                    if (imported > 0) message += `Ditambah: ${imported} siswa`;
                    if (updated > 0) message += `${imported > 0 ? ', ' : ''}Diperbarui: ${updated} siswa`;
                    if (kelasCreated > 0) message += `${(imported > 0 || updated > 0) ? ', ' : ''}Kelas baru: ${kelasCreated}`;
                    if (skipped > 0) message += `${(imported > 0 || updated > 0 || kelasCreated > 0) ? ', ' : ''}Dilewati: ${skipped} siswa`;
                    
                    const totalProcessed = imported + updated;
                    showToast(message, totalProcessed > 0 ? 'success' : 'error');
                    
                    // Show errors if any
                    if (errors.length > 0 && errors.length <= 5) {
                        setTimeout(() => {
                            showToast(`Error: ${errors.join('; ')}`, 'error');
                        }, 2000);
                    } else if (errors.length > 5) {
                        setTimeout(() => {
                            showToast(`${errors.length} error ditemukan. Contoh: ${errors[0]}`, 'error');
                        }, 2000);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Upload error:', error);
                    showToast(`Error memproses file: ${error.message}`, 'error');
                }
                
                // Reset file input
                e.target.value = '';
            };
            
            reader.onerror = function() {
                showToast('Gagal membaca file. Pastikan file Excel tidak rusak.', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        });

        // Helper functions for Excel processing
        function findFlexibleColumn(headers, possibleNames) {
            // Cari exact match dulu
            for (let name of possibleNames) {
                const exactIndex = headers.findIndex(h => h === name);
                if (exactIndex !== -1) return exactIndex;
            }
            
            // Cari partial match
            for (let name of possibleNames) {
                const partialIndex = headers.findIndex(h => 
                    h.includes(name) || name.includes(h)
                );
                if (partialIndex !== -1) return partialIndex;
            }
            
            return -1;
        }

        function cleanAndValidateNisn(value) {
            if (!value) return ''; // Izinkan NISN kosong
            
            const str = String(value).trim();
            if (str === '') return ''; // Izinkan NISN kosong
            
            // Extract only digits
            const digits = str.replace(/\D/g, '');
            
            // Jika ada digit, validasi panjang
            if (digits.length > 0) {
                // NISN should be 6-20 digits (lebih permisif)
                if (digits.length >= 6 && digits.length <= 20) {
                    return digits;
                }
                
                // Jika kurang dari 6 digit tapi ada isinya, tetap return untuk review manual
                if (digits.length >= 3) {
                    return digits;
                }
            }
            
            // Return string asli jika tidak bisa diproses sebagai angka
            return str;
        }

        function cleanAndValidateName(value) {
            if (!value) return '';
            
            const str = String(value).trim();
            if (str === '') return '';
            
            // Must contain at least some letters
            if (!/[a-zA-Z]/.test(str)) return '';
            
            // Must be at least 2 characters
            if (str.length < 2) return '';
            
            // If it's all numbers, skip
            if (/^\d+$/.test(str)) return '';
            
            return str;
        }

        function cleanNumericField(value) {
            if (!value) return '';
            
            const str = String(value).trim();
            if (str === '') return '';
            
            // Extract digits only
            const digits = str.replace(/\D/g, '');
            
            // Return digits if reasonable length (lebih permisif untuk NIPD)
            if (digits.length >= 4 && digits.length <= 25) {
                return digits;
            }
            
            // Return original if has some digits (untuk NIPD yang mungkin pendek)
            if (digits.length > 0) {
                return digits.length >= 2 ? digits : str;
            }
            
            return '';
        }

        function cleanTextField(value) {
            if (!value) return '';
            
            const str = String(value).trim();
            if (str === '') return '';
            
            // Remove quotes and normalize spaces
            return str.replace(/^['"]|['"]$/g, '').replace(/\s+/g, ' ');
        }

        function normalizeJenisKelamin(jk) {
            if (!jk) return '';
            const normalized = jk.toString().toUpperCase().trim();
            if (normalized === 'LAKI-LAKI' || normalized === 'LAKI' || normalized === '1' || normalized === 'L') {
                return 'L';
            } else if (normalized === 'PEREMPUAN' || normalized === 'WANITA' || normalized === '2' || normalized === 'P') {
                return 'P';
            }
            return jk; // Return original if can't normalize
        }

        function formatTanggal(tanggal) {
            if (!tanggal) return '';
            
            // If it's already a string in correct format, return it
            if (typeof tanggal === 'string' && tanggal.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return tanggal;
            }
            
            // If it's an Excel date number, convert it
            if (typeof tanggal === 'number') {
                try {
                    const date = XLSX.SSF.parse_date_code(tanggal);
                    if (date && date.y && date.m && date.d) {
                        return `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
                    }
                } catch (e) {
                    console.log('Error parsing Excel date:', tanggal);
                }
            }
            
            // Try to parse other date formats
            try {
                const date = new Date(tanggal);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
            } catch (e) {
                console.log('Could not parse date:', tanggal);
            }
            
            return String(tanggal); // Return as string if can't format
        }

        // Kelas Management
        function loadKelasGrid() {
            const grid = document.getElementById('kelas-grid');
            
            if (appData.kelas.length === 0) {
                grid.innerHTML = '<div class="text-center text-gray-500 col-span-full">Belum ada kelas. Klik "Tambah Kelas" untuk membuat kelas baru.</div>';
                return;
            }
            
            grid.innerHTML = appData.kelas.map(kelas => `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-medium text-gray-900">${kelas.nama_kelas}</h4>
                        <div class="flex space-x-2">
                            <button onclick="aturKelas('${kelas.id}')" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded text-sm font-medium" title="Atur Kelas">
                                Atur
                            </button>
                            <button onclick="deleteKelas('${kelas.id}')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm font-medium" title="Hapus Kelas">
                                Hapus
                            </button>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600">
                        <p><span class="font-medium">Tingkat:</span> ${kelas.tingkat}</p>
                        <p><span class="font-medium">Kurikulum:</span> ${kelas.kurikulum || 'Belum diatur'}</p>
                        <p><span class="font-medium">Wali Kelas:</span> ${kelas.wali_kelas || 'Belum diatur'}</p>
                        <p><span class="font-medium">Jumlah Siswa:</span> ${appData.siswa.filter(s => s.kelas === kelas.nama_kelas).length}</p>
                    </div>
                </div>
            `).join('');
        }

        // Kelas form handlers
        document.getElementById('tambah-kelas-btn').addEventListener('click', function() {
            document.getElementById('modal-kelas').classList.remove('hidden');
            document.getElementById('modal-kelas').classList.add('flex');
        });

        document.getElementById('batal-kelas-btn').addEventListener('click', function() {
            document.getElementById('modal-kelas').classList.add('hidden');
            document.getElementById('modal-kelas').classList.remove('flex');
            document.getElementById('form-kelas').reset();
        });

        document.getElementById('form-kelas').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const kelas = {
                id: Date.now().toString(),
                nama_kelas: formData.get('nama_kelas'),
                tingkat: formData.get('tingkat'),
                wali_kelas: formData.get('wali_kelas')
            };
            
            appData.kelas.push(kelas);
            saveData();
            loadKelasGrid();
            
            document.getElementById('modal-kelas').classList.add('hidden');
            document.getElementById('modal-kelas').classList.remove('flex');
            this.reset();
            
            showToast('Kelas berhasil ditambahkan!');
        });

        // Delete kelas
        function deleteKelas(id) {
            if (confirm('Apakah Anda yakin ingin menghapus kelas ini?')) {
                appData.kelas = appData.kelas.filter(k => k.id !== id);
                saveData();
                loadKelasGrid();
                showToast('Kelas berhasil dihapus!');
            }
        }

        // Atur Kelas
        let currentKelasId = null;

        function aturKelas(id) {
            const kelas = appData.kelas.find(k => k.id === id);
            if (!kelas) return;

            currentKelasId = id;

            // Load tutor options first
            loadTutorOptions();

            // Populate info kelas
            document.getElementById('atur-nama-kelas').textContent = kelas.nama_kelas;
            document.getElementById('atur-tingkat-kelas').textContent = kelas.tingkat;

            // Populate form dengan data yang ada
            const form = document.getElementById('form-atur-kelas');
            form.kurikulum.value = kelas.kurikulum || '';
            form.wali_kelas.value = kelas.wali_kelas_id || '';
            form.tahun_ajaran.value = kelas.tahun_ajaran || appData.settings.tahun_ajaran || '';
            form.semester.value = kelas.semester || appData.settings.semester || '';
            form.keterangan.value = kelas.keterangan || '';

            // Hitung statistik siswa
            const siswaKelas = appData.siswa.filter(s => s.kelas === kelas.nama_kelas);
            const siswaL = siswaKelas.filter(s => s.jk === 'L').length;
            const siswaP = siswaKelas.filter(s => s.jk === 'P').length;

            document.getElementById('atur-total-siswa').textContent = siswaKelas.length;
            document.getElementById('atur-siswa-l').textContent = siswaL;
            document.getElementById('atur-siswa-p').textContent = siswaP;

            // Show modal
            document.getElementById('modal-atur-kelas').classList.remove('hidden');
            document.getElementById('modal-atur-kelas').classList.add('flex');
        }

        // Modal atur kelas handlers
        document.getElementById('batal-atur-kelas-btn').addEventListener('click', function() {
            document.getElementById('modal-atur-kelas').classList.add('hidden');
            document.getElementById('modal-atur-kelas').classList.remove('flex');
            currentKelasId = null;
        });

        document.getElementById('simpan-atur-kelas-btn').addEventListener('click', function() {
            if (!currentKelasId) return;

            const form = document.getElementById('form-atur-kelas');
            const formData = new FormData(form);
            const waliKelasId = formData.get('wali_kelas');
            
            // Get tutor data if selected
            let waliKelasNama = '';
            if (waliKelasId) {
                const tutor = appData.tutor.find(t => t.id === waliKelasId);
                waliKelasNama = tutor ? tutor.nama_tutor : '';
            }

            // Update kelas data
            const kelasIndex = appData.kelas.findIndex(k => k.id === currentKelasId);
            if (kelasIndex !== -1) {
                appData.kelas[kelasIndex] = {
                    ...appData.kelas[kelasIndex],
                    kurikulum: formData.get('kurikulum'),
                    wali_kelas_id: waliKelasId,
                    wali_kelas: waliKelasNama,
                    tahun_ajaran: formData.get('tahun_ajaran'),
                    semester: formData.get('semester'),
                    keterangan: formData.get('keterangan')
                };

                saveData();
                loadKelasGrid();

                // Close modal
                document.getElementById('modal-atur-kelas').classList.add('hidden');
                document.getElementById('modal-atur-kelas').classList.remove('flex');
                currentKelasId = null;

                showToast('Pengaturan kelas berhasil disimpan!');
            }
        });

        // Mapel Management
        let currentKurikulum = 'merdeka';

        function loadMapelTable() {
            const tbody = document.getElementById('mapel-table-body');
            const filteredMapel = appData.mapel.filter(m => m.kurikulum === currentKurikulum);
            
            if (filteredMapel.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Belum ada mata pelajaran. Klik "Tambah Mapel" untuk menambah mata pelajaran.</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredMapel.map((mapel, index) => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${mapel.kode_mapel}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${mapel.nama_mapel}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${mapel.kurikulum === 'merdeka' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            ${mapel.kurikulum === 'merdeka' ? 'Kurikulum Merdeka' : 'Kurikulum 2013'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editMapel('${mapel.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deleteMapel('${mapel.id}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                </tr>
            `).join('');
        }

        // Kurikulum tab handlers
        document.querySelectorAll('.kurikulum-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.kurikulum-tab').forEach(t => {
                    t.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    t.classList.add('border-transparent', 'text-gray-500');
                });
                
                this.classList.add('active', 'border-blue-500', 'text-blue-600');
                this.classList.remove('border-transparent', 'text-gray-500');
                
                currentKurikulum = this.dataset.kurikulum;
                loadMapelTable();
            });
        });

        // Mapel form handlers
        document.getElementById('tambah-mapel-btn').addEventListener('click', function() {
            document.getElementById('modal-mapel').classList.remove('hidden');
            document.getElementById('modal-mapel').classList.add('flex');
        });

        document.getElementById('batal-mapel-btn').addEventListener('click', function() {
            document.getElementById('modal-mapel').classList.add('hidden');
            document.getElementById('modal-mapel').classList.remove('flex');
            document.getElementById('form-mapel').reset();
        });

        document.getElementById('form-mapel').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const mapel = {
                id: Date.now().toString(),
                kode_mapel: formData.get('kode_mapel'),
                nama_mapel: formData.get('nama_mapel'),
                kurikulum: formData.get('kurikulum')
            };
            
            appData.mapel.push(mapel);
            saveData();
            loadMapelTable();
            
            document.getElementById('modal-mapel').classList.add('hidden');
            document.getElementById('modal-mapel').classList.remove('flex');
            this.reset();
            
            showToast('Mata pelajaran berhasil ditambahkan!');
        });

        // Delete mapel
        function deleteMapel(id) {
            if (confirm('Apakah Anda yakin ingin menghapus mata pelajaran ini?')) {
                appData.mapel = appData.mapel.filter(m => m.id !== id);
                saveData();
                loadMapelTable();
                showToast('Mata pelajaran berhasil dihapus!');
            }
        }

        // Nilai Management
        function loadNilaiSelectors() {
            const kelasSelect = document.getElementById('select-kelas-nilai');
            const mapelSelect = document.getElementById('select-mapel-nilai');
            
            // Load kelas options - filter for tutors
            let availableKelas = appData.kelas;
            if (currentUser.level === 'tutor') {
                availableKelas = appData.kelas.filter(k => k.wali_kelas_id === currentUser.tutor_id);
            }
            
            kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>' +
                availableKelas.map(kelas => `<option value="${kelas.nama_kelas}">${kelas.nama_kelas}</option>`).join('');
            
            // Load mapel options based on kurikulum
            function updateMapelOptions() {
                const kurikulum = document.getElementById('select-kurikulum-nilai').value;
                const filteredMapel = appData.mapel.filter(m => m.kurikulum === kurikulum);
                mapelSelect.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>' +
                    filteredMapel.map(mapel => `<option value="${mapel.id}">${mapel.nama_mapel}</option>`).join('');
            }
            
            document.getElementById('select-kurikulum-nilai').addEventListener('change', updateMapelOptions);
            updateMapelOptions();
            
            // Handle selection changes
            function updateNilaiForm() {
                const kelas = kelasSelect.value;
                const mapelId = mapelSelect.value;
                
                if (kelas && mapelId) {
                    loadNilaiForm(kelas, mapelId);
                } else {
                    document.getElementById('nilai-form-container').classList.add('hidden');
                    document.getElementById('nilai-empty-state').classList.remove('hidden');
                }
            }
            
            kelasSelect.addEventListener('change', updateNilaiForm);
            mapelSelect.addEventListener('change', updateNilaiForm);
        }

        function loadNilaiForm(kelas, mapelId) {
            const siswaKelas = appData.siswa.filter(s => s.kelas === kelas);
            const mapel = appData.mapel.find(m => m.id === mapelId);
            const kurikulum = document.getElementById('select-kurikulum-nilai').value;
            
            // Check if tutor has access to this class
            if (currentUser.level === 'tutor') {
                const kelasData = appData.kelas.find(k => k.nama_kelas === kelas);
                if (!kelasData || kelasData.wali_kelas_id !== currentUser.tutor_id) {
                    document.getElementById('nilai-empty-state').innerHTML = 'Anda hanya dapat mengisi nilai untuk kelas yang Anda ampu.';
                    document.getElementById('nilai-empty-state').classList.remove('hidden');
                    document.getElementById('nilai-form-container').classList.add('hidden');
                    return;
                }
            }
            
            if (siswaKelas.length === 0) {
                document.getElementById('nilai-empty-state').innerHTML = 'Tidak ada siswa di kelas ini.';
                document.getElementById('nilai-empty-state').classList.remove('hidden');
                document.getElementById('nilai-form-container').classList.add('hidden');
                return;
            }
            
            // Update header based on kurikulum
            const nilaiHeader = document.getElementById('nilai-header');
            if (kurikulum === 'merdeka') {
                nilaiHeader.innerHTML = 'Nilai (A/B/C)';
            } else {
                nilaiHeader.innerHTML = 'Nilai (0-100)';
            }
            
            const tbody = document.getElementById('nilai-table-body');
            tbody.innerHTML = siswaKelas.map((siswa, index) => {
                const existingNilai = appData.nilai.find(n => n.nisn === siswa.nisn && n.mapel_id === mapelId);
                const nilaiValue = existingNilai ? existingNilai.nilai : '';
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nisn}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${kurikulum === 'merdeka' ? 
                                `<select class="nilai-input border border-gray-300 rounded px-2 py-1" data-nisn="${siswa.nisn}">
                                    <option value="">-</option>
                                    <option value="A" ${nilaiValue === 'A' ? 'selected' : ''}>A</option>
                                    <option value="B" ${nilaiValue === 'B' ? 'selected' : ''}>B</option>
                                    <option value="C" ${nilaiValue === 'C' ? 'selected' : ''}>C</option>
                                </select>` :
                                `<input type="number" min="0" max="100" class="nilai-input border border-gray-300 rounded px-2 py-1 w-20" data-nisn="${siswa.nisn}" value="${nilaiValue}">`
                            }
                        </td>
                        <td class="px-6 py-4">
                            <textarea class="deskripsi-input border border-gray-300 rounded px-2 py-1 w-full text-xs" rows="2" data-nisn="${siswa.nisn}" placeholder="Deskripsi capaian kompetensi...">${existingNilai ? existingNilai.deskripsi || '' : ''}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('nilai-empty-state').classList.add('hidden');
            document.getElementById('nilai-form-container').classList.remove('hidden');
        }

        // Save nilai
        document.getElementById('simpan-nilai-btn').addEventListener('click', function() {
            const kelas = document.getElementById('select-kelas-nilai').value;
            const mapelId = document.getElementById('select-mapel-nilai').value;
            const nilaiInputs = document.querySelectorAll('.nilai-input');
            const deskripsiInputs = document.querySelectorAll('.deskripsi-input');
            
            let saved = 0;
            nilaiInputs.forEach(input => {
                const nisn = input.dataset.nisn;
                const nilai = input.value;
                const deskripsiInput = Array.from(deskripsiInputs).find(d => d.dataset.nisn === nisn);
                const deskripsi = deskripsiInput ? deskripsiInput.value : '';
                
                if (nilai) {
                    // Remove existing nilai for this student and subject
                    appData.nilai = appData.nilai.filter(n => !(n.nisn === nisn && n.mapel_id === mapelId));
                    
                    // Add new nilai
                    appData.nilai.push({
                        id: Date.now().toString() + Math.random(),
                        nisn: nisn,
                        mapel_id: mapelId,
                        nilai: nilai,
                        deskripsi: deskripsi,
                        tanggal: new Date().toISOString().split('T')[0]
                    });
                    saved++;
                }
            });
            
            saveData();
            showToast(`Berhasil menyimpan ${saved} nilai!`);
        });

        // Cek Data Siswa
        document.getElementById('search-siswa').addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            
            if (query.length < 2) {
                document.getElementById('siswa-detail').classList.add('hidden');
                document.getElementById('siswa-not-found').classList.add('hidden');
                document.getElementById('siswa-search-empty').classList.remove('hidden');
                return;
            }
            
            const siswa = appData.siswa.find(s => 
                s.nisn.toLowerCase().includes(query) || 
                s.nama.toLowerCase().includes(query)
            );
            
            if (siswa) {
                // Data Pribadi
                document.getElementById('detail-nisn').textContent = siswa.nisn || '-';
                document.getElementById('detail-nipd').textContent = siswa.nipd || '-';
                document.getElementById('detail-nama').textContent = siswa.nama || '-';
                document.getElementById('detail-jk').textContent = siswa.jk === 'L' ? 'Laki-laki' : siswa.jk === 'P' ? 'Perempuan' : '-';
                document.getElementById('detail-agama').textContent = siswa.agama || '-';
                document.getElementById('detail-ttl').textContent = `${siswa.tempat_lahir || '-'}, ${siswa.tanggal_lahir || '-'}`;
                document.getElementById('detail-nik').textContent = siswa.nik || '-';
                document.getElementById('detail-kelas').textContent = siswa.kelas || '-';
                document.getElementById('detail-status').textContent = siswa.status || 'Aktif';
                
                // Data Keluarga
                document.getElementById('detail-nama-ayah').textContent = siswa.nama_ayah || '-';
                document.getElementById('detail-pekerjaan-ayah').textContent = siswa.pekerjaan_ayah || '-';
                document.getElementById('detail-nama-ibu').textContent = siswa.nama_ibu || '-';
                document.getElementById('detail-pekerjaan-ibu').textContent = siswa.pekerjaan_ibu || '-';
                document.getElementById('detail-no-kk').textContent = siswa.no_kk || '-';
                document.getElementById('detail-anak-ke').textContent = siswa.anak_ke || '-';
                
                // Data Alamat & Kontak
                document.getElementById('detail-alamat').textContent = siswa.alamat || '-';
                document.getElementById('detail-rt-rw').textContent = `${siswa.rt || '-'}/${siswa.rw || '-'}`;
                document.getElementById('detail-desa').textContent = siswa.desa || '-';
                document.getElementById('detail-kecamatan').textContent = siswa.kecamatan || '-';
                document.getElementById('detail-kabupaten').textContent = siswa.kabupaten || '-';
                document.getElementById('detail-provinsi').textContent = siswa.provinsi || '-';
                document.getElementById('detail-kode-pos').textContent = siswa.kode_pos || '-';
                document.getElementById('detail-no-hp').textContent = siswa.no_hp || '-';
                document.getElementById('detail-email').textContent = siswa.email || '-';
                
                document.getElementById('siswa-search-empty').classList.add('hidden');
                document.getElementById('siswa-not-found').classList.add('hidden');
                document.getElementById('siswa-detail').classList.remove('hidden');
            } else {
                document.getElementById('siswa-detail').classList.add('hidden');
                document.getElementById('siswa-search-empty').classList.add('hidden');
                document.getElementById('siswa-not-found').classList.remove('hidden');
            }
        });

        // Cetak Rapor
        function loadCetakSelectors() {
            const siswaSelect = document.getElementById('select-siswa-cetak');
            
            // Filter siswa for tutors - only their class students
            let availableSiswa = appData.siswa;
            if (currentUser.level === 'tutor') {
                const tutorKelas = appData.kelas.filter(k => k.wali_kelas_id === currentUser.tutor_id);
                const tutorKelasNames = tutorKelas.map(k => k.nama_kelas);
                availableSiswa = appData.siswa.filter(s => tutorKelasNames.includes(s.kelas));
            }
            
            siswaSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>' +
                availableSiswa.map(siswa => `<option value="${siswa.nisn}">${siswa.nama} (${siswa.nisn})</option>`).join('');
        }

        document.getElementById('preview-rapor-btn').addEventListener('click', function() {
            const nisn = document.getElementById('select-siswa-cetak').value;
            const template = document.getElementById('select-template-rapor').value;
            
            if (!nisn) {
                showToast('Pilih siswa terlebih dahulu!', 'error');
                return;
            }
            
            generateRaporPreview(nisn, template);
        });

        document.getElementById('cetak-rapor-btn').addEventListener('click', function() {
            const preview = document.getElementById('rapor-preview');
            if (preview.classList.contains('hidden')) {
                showToast('Buat preview rapor terlebih dahulu!', 'error');
                return;
            }
            
            // Show loading
            showToast('Menyiapkan dokumen untuk cetak...', 'info');
            
            // Delay untuk memastikan preview sudah ter-render
            setTimeout(() => {
                window.print();
            }, 500);
        });

        function generateRaporPreview(nisn, template) {
            const siswa = appData.siswa.find(s => s.nisn === nisn);
            const nilaiSiswa = appData.nilai.filter(n => n.nisn === nisn);
            
            let raporHTML = '';
            
            if (template === 'merdeka') {
                raporHTML = generateRaporMerdeka(siswa, nilaiSiswa);
            } else {
                raporHTML = generateRaporK13(siswa, nilaiSiswa);
            }
            
            document.getElementById('rapor-preview').innerHTML = raporHTML;
            document.getElementById('rapor-preview').classList.remove('hidden');
            document.getElementById('rapor-empty-state').classList.add('hidden');
        }

        function generateRaporMerdeka(siswa, nilaiSiswa) {
            // Tentukan fase berdasarkan kelas/tingkat
            const kelas = siswa.kelas || '';
            let fase = 'Fase C';
            let tingkatKelas = 'Paket C';
            
            if (kelas.toLowerCase().includes('paket a') || kelas.toLowerCase().includes('setara sd')) {
                fase = 'Fase A-B';
                tingkatKelas = 'Paket A (Setara SD)';
            } else if (kelas.toLowerCase().includes('paket b') || kelas.toLowerCase().includes('setara smp')) {
                fase = 'Fase D';
                tingkatKelas = 'Paket B (Setara SMP)';
            } else if (kelas.toLowerCase().includes('paket c') || kelas.toLowerCase().includes('setara sma')) {
                fase = 'Fase E-F';
                tingkatKelas = 'Paket C (Setara SMA)';
            }

            // Get wali kelas info
            const kelasData = appData.kelas.find(k => k.nama_kelas === siswa.kelas);
            let waliKelasNama = 'Belum diatur';
            let waliKelasTTD = '';
            
            if (kelasData && kelasData.wali_kelas_id) {
                const waliKelas = appData.tutor.find(t => t.id === kelasData.wali_kelas_id);
                if (waliKelas) {
                    waliKelasNama = waliKelas.nama_tutor;
                    waliKelasTTD = waliKelas.ttd_url || '';
                }
            }

            return `
                <div class="bg-white p-4 max-w-full mx-auto text-xs">
                    <!-- Header dengan Logo dan Identitas Lembaga -->
                    <div class="text-center mb-4 border-b-2 border-black pb-3">
                        <div class="flex items-center justify-center mb-2">
                            ${appData.settings.logo_url ? 
                                `<img src="${appData.settings.logo_url}" alt="Logo" class="w-12 h-12 mr-3">` : 
                                '<div class="w-12 h-12 bg-blue-600 rounded mr-3 flex items-center justify-center"><span class="text-white font-bold text-xs">LOGO</span></div>'
                            }
                            <div>
                                <h1 class="text-lg font-bold mb-1">LAPORAN HASIL BELAJAR</h1>
                                <h2 class="text-base font-semibold">${appData.settings.school_name}</h2>
                                <p class="text-xs">Tahun Ajaran ${appData.settings.tahun_ajaran || '-'} | Semester ${appData.settings.semester === '1' ? 'Ganjil' : appData.settings.semester === '2' ? 'Genap' : '-'}</p>
                                <p class="text-xs">${appData.settings.school_address}</p>
                                ${appData.settings.npsn ? `<p class="text-xs">NPSN: ${appData.settings.npsn}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Identitas Siswa dalam 1 baris -->
                    <div class="mb-4">
                        <table class="w-full text-xs border-collapse">
                            <tr>
                                <td class="py-1 w-20 font-medium">Nama</td>
                                <td class="py-1 w-4">:</td>
                                <td class="py-1 font-semibold">${siswa.nama}</td>
                                <td class="py-1 w-20 font-medium">Sekolah</td>
                                <td class="py-1 w-4">:</td>
                                <td class="py-1">${appData.settings.school_name}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">NISN</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${siswa.nisn}</td>
                                <td class="py-1 font-medium">Alamat</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${appData.settings.school_address}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">NIPD</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${siswa.nipd || '-'}</td>
                                <td class="py-1 font-medium">Kelas</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${siswa.kelas || '-'}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">TTL</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${siswa.tempat_lahir || '-'}, ${siswa.tanggal_lahir || '-'}</td>
                                <td class="py-1 font-medium">Fase</td>
                                <td class="py-1">:</td>
                                <td class="py-1 font-semibold">${fase}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">JK</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${siswa.jk === 'L' ? 'Laki-laki' : siswa.jk === 'P' ? 'Perempuan' : '-'}</td>
                                <td class="py-1 font-medium">Semester</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${appData.settings.semester === '1' ? 'Ganjil' : appData.settings.semester === '2' ? 'Genap' : '-'}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Capaian Pembelajaran -->
                    <div class="mb-3">
                        <h3 class="font-bold mb-2 text-center bg-gray-100 py-1 text-sm">CAPAIAN PEMBELAJARAN</h3>
                        <table class="w-full border-collapse border border-black text-xs">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-black px-1 py-1 text-center w-6">No</th>
                                    <th class="border border-black px-1 py-1 text-left">Mata Pelajaran</th>
                                    <th class="border border-black px-1 py-1 text-center w-12">Nilai</th>
                                    <th class="border border-black px-1 py-1 text-center w-12">Capaian</th>
                                    <th class="border border-black px-1 py-1 text-left">Deskripsi Capaian Kompetensi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-gray-50">
                                    <td colspan="5" class="border border-black px-1 py-1 font-semibold text-xs">A. MATA PELAJARAN UMUM</td>
                                </tr>
                                ${generateMataPelajaranRows(nilaiSiswa, 'umum')}
                                <tr class="bg-gray-50">
                                    <td colspan="5" class="border border-black px-1 py-1 font-semibold text-xs">B. MATA PELAJARAN KEJURUAN (Jika Ada)</td>
                                </tr>
                                ${generateMataPelajaranRows(nilaiSiswa, 'kejuruan')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Keterangan Kriteria Penilaian -->
                    <div class="mb-3">
                        <h3 class="font-bold mb-2 text-center bg-gray-100 py-1 text-sm">KETERANGAN KRITERIA PENILAIAN</h3>
                        <div class="border border-black p-2">
                            <div class="grid grid-cols-3 gap-4 text-xs">
                                <div>
                                    <p class="font-semibold">A (Sangat Baik)</p>
                                    <p>Nilai ‚â• ${Math.max(85, parseInt(appData.settings.kkm || 75) + 10)}</p>
                                </div>
                                <div>
                                    <p class="font-semibold">B (Baik)</p>
                                    <p>Nilai ${parseInt(appData.settings.kkm || 75)} - ${Math.max(84, parseInt(appData.settings.kkm || 75) + 9)}</p>
                                </div>
                                <div>
                                    <p class="font-semibold">C (Cukup)</p>
                                    <p>Nilai ${Math.max(55, parseInt(appData.settings.kkm || 75) - 20)} - ${parseInt(appData.settings.kkm || 75) - 1}</p>
                                </div>
                            </div>
                            <p class="text-xs mt-2 italic">KKM (Kriteria Ketuntasan Minimal): ${appData.settings.kkm || 75}</p>
                        </div>
                    </div>

                    <!-- Ekstrakurikuler dan Ketidakhadiran dalam 1 baris -->
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <h3 class="font-bold mb-2 text-center bg-gray-100 py-1 text-sm">EKSTRAKURIKULER</h3>
                            <table class="w-full border-collapse border border-black text-xs">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-black px-1 py-1 text-center w-6">No</th>
                                        <th class="border border-black px-1 py-1 text-left">Kegiatan</th>
                                        <th class="border border-black px-1 py-1 text-center w-12">Predikat</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${generateEkstrakurikulerRows(siswa.nisn)}
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2 text-center bg-gray-100 py-1 text-sm">KETIDAKHADIRAN</h3>
                            <table class="w-full border-collapse border border-black text-xs">
                                <tbody>
                                    ${generateKehadiranRows(siswa.nisn)}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Catatan Wali Kelas -->
                    <div class="mb-3">
                        <h3 class="font-bold mb-2 text-center bg-gray-100 py-1 text-sm">CATATAN WALI KELAS</h3>
                        <div class="border border-black p-2 min-h-12">
                            ${generateCatatanWaliKelas(siswa.nisn)}
                        </div>
                    </div>

                    <!-- Tanda Tangan -->
                    <div class="grid grid-cols-3 gap-4 mt-4">
                        <div class="text-center">
                            <p class="mb-1 text-xs">Mengetahui,</p>
                            <p class="font-semibold mb-8 text-xs">Orang Tua/Wali</p>
                            <p class="border-t border-black pt-1 text-xs">(...........................)</p>
                        </div>
                        <div class="text-center">
                            <p class="mb-1 text-xs">${appData.settings.tempat_rapor || 'Jombang'}, ${formatTanggalIndonesia(appData.settings.tanggal_rapor)}</p>
                            <p class="font-semibold mb-1 text-xs">Wali Kelas</p>
                            ${waliKelasTTD ? 
                                `<div class="mb-6"><img src="${waliKelasTTD}" alt="TTD" class="w-16 h-8 mx-auto object-contain"></div>` : 
                                '<div class="mb-8"></div>'
                            }
                            <p class="border-t border-black pt-1 text-xs">${waliKelasNama}</p>
                            ${kelasData && kelasData.wali_kelas_nip ? `<p class="text-xs">NIP. ${kelasData.wali_kelas_nip}</p>` : ''}
                        </div>
                        <div class="text-center">
                            <p class="mb-1 text-xs">Kepala Lembaga</p>
                            <div class="mb-8"></div>
                            <p class="border-t border-black pt-1 text-xs">${appData.settings.headmaster}</p>
                            <p class="text-xs">NIP. ${appData.settings.headmaster_nip}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper functions untuk rapor
        function generateMataPelajaranRows(nilaiSiswa, jenis) {
            const mapelFiltered = nilaiSiswa.filter(nilai => {
                const mapel = appData.mapel.find(m => m.id === nilai.mapel_id);
                if (!mapel) return false;
                
                // Klasifikasi mata pelajaran
                const mapelUmum = ['matematika', 'bahasa indonesia', 'bahasa inggris', 'ipa', 'ips', 'ppkn', 'seni budaya', 'pjok', 'prakarya'];
                const isUmum = mapelUmum.some(mu => mapel.nama_mapel.toLowerCase().includes(mu));
                
                return jenis === 'umum' ? isUmum : !isUmum;
            });

            if (mapelFiltered.length === 0) {
                return `<tr><td colspan="5" class="border border-black px-2 py-2 text-center text-gray-500">Tidak ada mata pelajaran ${jenis}</td></tr>`;
            }

            return mapelFiltered.map((nilai, index) => {
                const mapel = appData.mapel.find(m => m.id === nilai.mapel_id);
                const capaianKompetensi = getCapaianKompetensi(nilai.nilai);
                const deskripsi = nilai.deskripsi || getDeskripsiCapaian(mapel ? mapel.nama_mapel : '', nilai.nilai);
                
                return `
                    <tr>
                        <td class="border border-black px-1 py-1 text-center">${index + 1}</td>
                        <td class="border border-black px-1 py-1 text-xs">${mapel ? mapel.nama_mapel : '-'}</td>
                        <td class="border border-black px-1 py-1 text-center font-semibold">${nilai.nilai}</td>
                        <td class="border border-black px-1 py-1 text-center font-semibold">${capaianKompetensi}</td>
                        <td class="border border-black px-1 py-1 text-xs">${deskripsi}</td>
                    </tr>
                `;
            }).join('');
        }

        function getCapaianKompetensi(nilai) {
            const kkm = parseInt(appData.settings.kkm || 75);
            
            // Untuk Kurikulum Merdeka: Berkembang Sesuai Harapan (BSH), Sangat Berkembang (SB), Mulai Berkembang (MB), Belum Berkembang (BB)
            if (nilai === 'A' || (typeof nilai === 'number' && nilai >= Math.max(85, kkm + 10))) return 'SB';
            if (nilai === 'B' || (typeof nilai === 'number' && nilai >= kkm)) return 'BSH';
            if (nilai === 'C' || (typeof nilai === 'number' && nilai >= Math.max(55, kkm - 20))) return 'MB';
            return 'BB';
        }

        function getDeskripsiCapaian(namaMapel, nilai) {
            const capaian = getCapaianKompetensi(nilai);
            const mapelLower = namaMapel.toLowerCase();
            
            const deskripsiTemplate = {
                'SB': `Peserta didik sangat baik dalam menguasai ${namaMapel} dan mampu mengaplikasikan konsep dengan sangat baik`,
                'BSH': `Peserta didik baik dalam menguasai ${namaMapel} dan mampu mengaplikasikan konsep dengan baik`,
                'MB': `Peserta didik cukup dalam menguasai ${namaMapel} dan perlu bimbingan lebih lanjut`,
                'BB': `Peserta didik perlu bimbingan intensif dalam menguasai ${namaMapel}`
            };
            
            return deskripsiTemplate[capaian] || `Peserta didik menunjukkan capaian yang sesuai dengan kemampuannya dalam ${namaMapel}`;
        }

        function formatTanggalIndonesia(tanggal) {
            if (!tanggal) return new Date().toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            
            const date = new Date(tanggal);
            return date.toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
        }

        function generateRaporK13(siswa, nilaiSiswa) {
            // Get wali kelas info
            const kelasData = appData.kelas.find(k => k.nama_kelas === siswa.kelas);
            let waliKelasNama = 'Belum diatur';
            let waliKelasTTD = '';
            
            if (kelasData && kelasData.wali_kelas_id) {
                const waliKelas = appData.tutor.find(t => t.id === kelasData.wali_kelas_id);
                if (waliKelas) {
                    waliKelasNama = waliKelas.nama_tutor;
                    waliKelasTTD = waliKelas.ttd_url || '';
                }
            }

            return `
                <div class="bg-white p-4 max-w-full mx-auto text-xs">
                    <!-- Header dengan Logo dan Identitas Lembaga -->
                    <div class="text-center mb-3 border-b-2 border-black pb-2">
                        <div class="flex items-center justify-center mb-1">
                            ${appData.settings.logo_url ? 
                                `<img src="${appData.settings.logo_url}" alt="Logo" class="w-10 h-10 mr-2">` : 
                                '<div class="w-10 h-10 bg-blue-600 rounded mr-2 flex items-center justify-center"><span class="text-white font-bold text-xs">LOGO</span></div>'
                            }
                            <div>
                                <h1 class="text-base font-bold mb-1">LAPORAN HASIL BELAJAR</h1>
                                <h2 class="text-sm font-semibold">${appData.settings.school_name}</h2>
                                <p class="text-xs">Tahun Ajaran ${appData.settings.tahun_ajaran || '-'} | Semester ${appData.settings.semester === '1' ? 'Ganjil' : appData.settings.semester === '2' ? 'Genap' : '-'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Identitas dalam 1 baris -->
                    <div class="mb-3">
                        <table class="w-full text-xs border-collapse">
                            <tr>
                                <td class="py-1 w-20 font-medium">Nama</td>
                                <td class="py-1 w-4">:</td>
                                <td class="py-1 font-semibold">${siswa.nama}</td>
                                <td class="py-1 w-20 font-medium">Lembaga</td>
                                <td class="py-1 w-4">:</td>
                                <td class="py-1">${appData.settings.school_name}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">NISN</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${siswa.nisn}</td>
                                <td class="py-1 font-medium">NPSN</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${appData.settings.npsn || '-'}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">NIPD</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${siswa.nipd || '-'}</td>
                                <td class="py-1 font-medium">Kelas</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${siswa.kelas || '-'}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">TTL</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${siswa.tempat_lahir || '-'}, ${siswa.tanggal_lahir || '-'}</td>
                                <td class="py-1 font-medium">Semester</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${appData.settings.semester === '1' ? 'Ganjil' : appData.settings.semester === '2' ? 'Genap' : '-'}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">JK</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${siswa.jk === 'L' ? 'Laki-laki' : siswa.jk === 'P' ? 'Perempuan' : '-'}</td>
                                <td class="py-1 font-medium">Tahun Ajaran</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${appData.settings.tahun_ajaran || '-'}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Hasil Belajar -->
                    <div class="mb-6">
                        <h3 class="font-bold mb-3 text-center bg-gray-100 py-2">HASIL BELAJAR</h3>
                        <table class="w-full border-collapse border border-black text-xs">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-black px-2 py-2 text-center w-8">No</th>
                                    <th class="border border-black px-2 py-2 text-left">Mata Pelajaran</th>
                                    <th class="border border-black px-2 py-2 text-center w-16">Pengetahuan</th>
                                    <th class="border border-black px-2 py-2 text-center w-16">Keterampilan</th>
                                    <th class="border border-black px-2 py-2 text-center w-16">Nilai Akhir</th>
                                    <th class="border border-black px-2 py-2 text-center w-16">Predikat</th>
                                    <th class="border border-black px-2 py-2 text-left">Deskripsi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-gray-50">
                                    <td colspan="7" class="border border-black px-2 py-1 font-semibold">A. MATA PELAJARAN UMUM</td>
                                </tr>
                                ${generateMataPelajaranRowsK13(nilaiSiswa, 'umum')}
                                <tr class="bg-gray-50">
                                    <td colspan="7" class="border border-black px-2 py-1 font-semibold">B. MATA PELAJARAN KEJURUAN (Jika Ada)</td>
                                </tr>
                                ${generateMataPelajaranRowsK13(nilaiSiswa, 'kejuruan')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Ekstrakurikuler -->
                    <div class="mb-4">
                        <h3 class="font-bold mb-2 text-center bg-gray-100 py-1 text-sm">EKSTRAKURIKULER</h3>
                        <table class="w-full border-collapse border border-black text-xs">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-black px-2 py-1 text-center w-8">No</th>
                                    <th class="border border-black px-2 py-1 text-left">Kegiatan Ekstrakurikuler</th>
                                    <th class="border border-black px-2 py-1 text-center w-20">Predikat</th>
                                    <th class="border border-black px-2 py-1 text-left">Keterangan</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${generateEkstrakurikulerRowsK13(siswa.nisn)}
                            </tbody>
                        </table>
                    </div>

                    <!-- Ketidakhadiran -->
                    <div class="mb-4">
                        <h3 class="font-bold mb-2 text-center bg-gray-100 py-1 text-sm">KETIDAKHADIRAN</h3>
                        <table class="w-full border-collapse border border-black text-xs">
                            ${generateKehadiranRowsK13(siswa.nisn)}
                        </table>
                    </div>

                    <!-- Catatan Wali Kelas -->
                    <div class="mb-4">
                        <h3 class="font-bold mb-2 text-center bg-gray-100 py-1 text-sm">CATATAN WALI KELAS</h3>
                        <div class="border border-black p-2 min-h-12">
                            ${generateCatatanWaliKelas(siswa.nisn)}
                        </div>
                    </div>

                    <!-- Tanda Tangan -->
                    <div class="grid grid-cols-3 gap-4 mt-4">
                        <div class="text-center">
                            <p class="mb-1 text-xs">Mengetahui,</p>
                            <p class="font-semibold mb-8 text-xs">Orang Tua/Wali</p>
                            <p class="border-t border-black pt-1 text-xs">(...........................)</p>
                        </div>
                        <div class="text-center">
                            <p class="mb-1 text-xs">${appData.settings.tempat_rapor || 'Jombang'}, ${formatTanggalIndonesia(appData.settings.tanggal_rapor)}</p>
                            <p class="font-semibold mb-1 text-xs">Wali Kelas</p>
                            ${waliKelasTTD ? 
                                `<div class="mb-6"><img src="${waliKelasTTD}" alt="TTD" class="w-16 h-8 mx-auto object-contain"></div>` : 
                                '<div class="mb-8"></div>'
                            }
                            <p class="border-t border-black pt-1 text-xs">${waliKelasNama}</p>
                            ${kelasData && kelasData.wali_kelas_nip ? `<p class="text-xs">NIP. ${kelasData.wali_kelas_nip}</p>` : ''}
                        </div>
                        <div class="text-center">
                            <p class="mb-1 text-xs">Kepala Lembaga</p>
                            <div class="mb-8"></div>
                            <p class="border-t border-black pt-1 text-xs">${appData.settings.headmaster}</p>
                            <p class="text-xs">NIP. ${appData.settings.headmaster_nip}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Settings Management
        function loadSettingsForm() {
            // Data Lembaga
            document.getElementById('setting-school-name').value = appData.settings.school_name;
            document.getElementById('setting-npsn').value = appData.settings.npsn;
            document.getElementById('setting-school-address').value = appData.settings.school_address;
            document.getElementById('setting-kecamatan').value = appData.settings.kecamatan;
            document.getElementById('setting-kabupaten').value = appData.settings.kabupaten;
            document.getElementById('setting-provinsi').value = appData.settings.provinsi;
            document.getElementById('setting-kode-pos').value = appData.settings.kode_pos;
            document.getElementById('setting-telepon').value = appData.settings.telepon;
            document.getElementById('setting-email').value = appData.settings.email;
            document.getElementById('setting-website').value = appData.settings.website;
            document.getElementById('setting-headmaster').value = appData.settings.headmaster;
            document.getElementById('setting-headmaster-nip').value = appData.settings.headmaster_nip;
            
            // Data Akademik
            document.getElementById('setting-tahun-ajaran').value = appData.settings.tahun_ajaran;
            document.getElementById('setting-semester').value = appData.settings.semester;
            document.getElementById('setting-tanggal-mulai').value = appData.settings.tanggal_mulai;
            document.getElementById('setting-tanggal-akhir').value = appData.settings.tanggal_akhir;
            document.getElementById('setting-tempat-rapor').value = appData.settings.tempat_rapor;
            document.getElementById('setting-tanggal-rapor').value = appData.settings.tanggal_rapor;
            document.getElementById('setting-catatan-akademik').value = appData.settings.catatan_akademik;
            document.getElementById('setting-kkm').value = appData.settings.kkm;
            
            // Load logo if exists
            if (appData.settings.logo_url) {
                updateLogoPreview(appData.settings.logo_url);
            }
        }

        // Tab switching for pengaturan
        document.querySelectorAll('.pengaturan-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.pengaturan-tab').forEach(t => {
                    t.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    t.classList.add('border-transparent', 'text-gray-500');
                });
                
                // Add active class to clicked tab
                this.classList.add('active', 'border-blue-500', 'text-blue-600');
                this.classList.remove('border-transparent', 'text-gray-500');
                
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Show target tab content
                const targetTab = this.dataset.tab;
                document.getElementById('tab-' + targetTab).classList.remove('hidden');
                
                // Load specific data
                if (targetTab === 'tutor') {
                    loadTutorTable();
                }
            });
        });

        // Logo upload handler
        document.getElementById('upload-logo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Ukuran file terlalu besar! Maksimal 2MB.', 'error');
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('File harus berupa gambar!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const logoUrl = e.target.result;
                appData.settings.logo_url = logoUrl;
                updateLogoPreview(logoUrl);
                saveData();
                showToast('Logo berhasil diupload!');
            };
            reader.readAsDataURL(file);
        });

        function updateLogoPreview(logoUrl) {
            const preview = document.getElementById('logo-preview');
            preview.innerHTML = `<img src="${logoUrl}" alt="Logo" class="w-full h-full object-contain rounded-lg">`;
            
            // Update logo di aplikasi
            updateAppLogo(logoUrl);
        }

        function updateAppLogo(logoUrl) {
            // Update logo di sidebar
            const sidebarLogo = document.getElementById('sidebar-logo');
            if (sidebarLogo) {
                if (logoUrl) {
                    sidebarLogo.innerHTML = `<img src="${logoUrl}" alt="Logo Lembaga" class="w-full h-full object-contain rounded-full">`;
                    sidebarLogo.classList.remove('bg-blue-600');
                } else {
                    // Default icon
                    sidebarLogo.innerHTML = `<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>`;
                    sidebarLogo.classList.add('bg-blue-600');
                }
            }
            
            // Update logo di login
            const loginLogo = document.getElementById('login-logo');
            if (loginLogo) {
                if (logoUrl) {
                    loginLogo.innerHTML = `<img src="${logoUrl}" alt="Logo Lembaga" class="w-full h-full object-contain rounded-full">`;
                    loginLogo.classList.remove('bg-blue-600');
                } else {
                    // Default icon
                    loginLogo.innerHTML = `<svg class="h-10 w-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>`;
                    loginLogo.classList.add('bg-blue-600');
                }
            }
        }

        // Save Data Lembaga
        document.getElementById('simpan-lembaga-btn').addEventListener('click', function() {
            appData.settings.school_name = document.getElementById('setting-school-name').value;
            appData.settings.npsn = document.getElementById('setting-npsn').value;
            appData.settings.school_address = document.getElementById('setting-school-address').value;
            appData.settings.kecamatan = document.getElementById('setting-kecamatan').value;
            appData.settings.kabupaten = document.getElementById('setting-kabupaten').value;
            appData.settings.provinsi = document.getElementById('setting-provinsi').value;
            appData.settings.kode_pos = document.getElementById('setting-kode-pos').value;
            appData.settings.telepon = document.getElementById('setting-telepon').value;
            appData.settings.email = document.getElementById('setting-email').value;
            appData.settings.website = document.getElementById('setting-website').value;
            appData.settings.headmaster = document.getElementById('setting-headmaster').value;
            appData.settings.headmaster_nip = document.getElementById('setting-headmaster-nip').value;
            
            // Update config for Element SDK
            if (window.elementSdk) {
                window.elementSdk.setConfig({
                    app_title: appData.settings.app_name,
                    school_name: appData.settings.school_name
                });
            }
            
            saveData();
            showToast('Data lembaga berhasil disimpan!');
        });

        // Save Data Akademik
        document.getElementById('simpan-akademik-btn').addEventListener('click', function() {
            appData.settings.tahun_ajaran = document.getElementById('setting-tahun-ajaran').value;
            appData.settings.semester = document.getElementById('setting-semester').value;
            appData.settings.tanggal_mulai = document.getElementById('setting-tanggal-mulai').value;
            appData.settings.tanggal_akhir = document.getElementById('setting-tanggal-akhir').value;
            appData.settings.tempat_rapor = document.getElementById('setting-tempat-rapor').value;
            appData.settings.tanggal_rapor = document.getElementById('setting-tanggal-rapor').value;
            appData.settings.catatan_akademik = document.getElementById('setting-catatan-akademik').value;
            appData.settings.kkm = document.getElementById('setting-kkm').value;
            
            saveData();
            showToast('Data akademik berhasil disimpan!');
        });

        // Tutor Management
        function loadTutorTable() {
            const tbody = document.getElementById('tutor-table-body');
            
            if (appData.tutor.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Belum ada data tutor. Klik "Tambah Tutor" untuk menambah tutor.</td></tr>';
                return;
            }
            
            tbody.innerHTML = appData.tutor.map((tutor, index) => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${tutor.nama_tutor}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${tutor.nip || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${tutor.no_hp}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                            tutor.status === 'Aktif' ? 'bg-green-100 text-green-800' : 
                            tutor.status === 'Cuti' ? 'bg-yellow-100 text-yellow-800' : 
                            'bg-red-100 text-red-800'
                        }">
                            ${tutor.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editTutor('${tutor.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deleteTutor('${tutor.id}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                </tr>
            `).join('');
        }

        // Tutor form handlers
        document.getElementById('tambah-tutor-btn').addEventListener('click', function() {
            document.getElementById('modal-tutor').classList.remove('hidden');
            document.getElementById('modal-tutor').classList.add('flex');
        });

        document.getElementById('batal-tutor-btn').addEventListener('click', function() {
            document.getElementById('modal-tutor').classList.add('hidden');
            document.getElementById('modal-tutor').classList.remove('flex');
            document.getElementById('form-tutor').reset();
            document.getElementById('ttd-preview').innerHTML = '<span class="text-xs text-gray-500">TTD Preview</span>';
        });

        // TTD upload handler
        document.getElementById('upload-ttd').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file size (max 1MB)
            if (file.size > 1024 * 1024) {
                showToast('Ukuran file terlalu besar! Maksimal 1MB.', 'error');
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('File harus berupa gambar!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const ttdUrl = e.target.result;
                document.getElementById('ttd-preview').innerHTML = `<img src="${ttdUrl}" alt="TTD" class="w-full h-full object-contain">`;
                // Store TTD URL temporarily
                document.getElementById('upload-ttd').dataset.ttdUrl = ttdUrl;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('form-tutor').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const ttdUrl = document.getElementById('upload-ttd').dataset.ttdUrl || '';
            
            const tutorData = {
                nama_tutor: formData.get('nama_tutor'),
                nip: formData.get('nip'),
                jenis_kelamin: formData.get('jenis_kelamin'),
                tempat_lahir: formData.get('tempat_lahir'),
                tanggal_lahir: formData.get('tanggal_lahir'),
                pendidikan: formData.get('pendidikan'),
                alamat: formData.get('alamat'),
                no_hp: formData.get('no_hp'),
                email: formData.get('email'),
                ttd_url: ttdUrl,
                status: formData.get('status')
            };
            
            if (currentEditTutorId) {
                // Edit existing tutor
                const tutorIndex = appData.tutor.findIndex(t => t.id === currentEditTutorId);
                if (tutorIndex !== -1) {
                    appData.tutor[tutorIndex] = { ...appData.tutor[tutorIndex], ...tutorData };
                    showToast('Tutor berhasil diperbarui!');
                }
                currentEditTutorId = null;
            } else {
                // Add new tutor
                const tutor = {
                    id: Date.now().toString(),
                    ...tutorData
                };
                appData.tutor.push(tutor);
                showToast('Tutor berhasil ditambahkan!');
            }
            
            saveData();
            loadTutorTable();
            
            document.getElementById('modal-tutor').classList.add('hidden');
            document.getElementById('modal-tutor').classList.remove('flex');
            this.reset();
            document.getElementById('ttd-preview').innerHTML = '<span class="text-xs text-gray-500">TTD Preview</span>';
            document.querySelector('#modal-tutor .text-lg').textContent = 'Tambah Tutor Baru';
        });

        // Edit tutor
        let currentEditTutorId = null;

        function editTutor(id) {
            const tutor = appData.tutor.find(t => t.id === id);
            if (!tutor) return;

            currentEditTutorId = id;

            // Populate form with existing data
            const form = document.getElementById('form-tutor');
            form.nama_tutor.value = tutor.nama_tutor;
            form.nip.value = tutor.nip || '';
            form.jenis_kelamin.value = tutor.jenis_kelamin || '';
            form.tempat_lahir.value = tutor.tempat_lahir || '';
            form.tanggal_lahir.value = tutor.tanggal_lahir || '';
            form.pendidikan.value = tutor.pendidikan || '';
            form.alamat.value = tutor.alamat || '';
            form.no_hp.value = tutor.no_hp;
            form.email.value = tutor.email || '';
            form.status.value = tutor.status;

            // Show existing TTD if available
            if (tutor.ttd_url) {
                document.getElementById('ttd-preview').innerHTML = `<img src="${tutor.ttd_url}" alt="TTD" class="w-full h-full object-contain">`;
                document.getElementById('upload-ttd').dataset.ttdUrl = tutor.ttd_url;
            }

            // Change modal title
            document.querySelector('#modal-tutor .text-lg').textContent = 'Edit Tutor';

            // Show modal
            document.getElementById('modal-tutor').classList.remove('hidden');
            document.getElementById('modal-tutor').classList.add('flex');
        }

        // Delete tutor
        function deleteTutor(id) {
            if (confirm('Apakah Anda yakin ingin menghapus tutor ini?')) {
                appData.tutor = appData.tutor.filter(t => t.id !== id);
                saveData();
                loadTutorTable();
                showToast('Tutor berhasil dihapus!');
            }
        }

        // Load tutor options for wali kelas
        function loadTutorOptions() {
            const select = document.querySelector('select[name="wali_kelas"]');
            if (select) {
                const activeTutors = appData.tutor.filter(t => t.status === 'Aktif');
                select.innerHTML = '<option value="">-- Pilih Tutor sebagai Wali Kelas --</option>' +
                    activeTutors.map(tutor => `<option value="${tutor.id}">${tutor.nama_tutor}</option>`).join('');
            }
        }

        // Helper function untuk K13
        function generateMataPelajaranRowsK13(nilaiSiswa, jenis) {
            const mapelFiltered = nilaiSiswa.filter(nilai => {
                const mapel = appData.mapel.find(m => m.id === nilai.mapel_id);
                if (!mapel) return false;
                
                // Klasifikasi mata pelajaran
                const mapelUmum = ['matematika', 'bahasa indonesia', 'bahasa inggris', 'ipa', 'ips', 'ppkn', 'seni budaya', 'pjok', 'prakarya'];
                const isUmum = mapelUmum.some(mu => mapel.nama_mapel.toLowerCase().includes(mu));
                
                return jenis === 'umum' ? isUmum : !isUmum;
            });

            if (mapelFiltered.length === 0) {
                return `<tr><td colspan="7" class="border border-black px-2 py-2 text-center text-gray-500">Tidak ada mata pelajaran ${jenis}</td></tr>`;
            }

            return mapelFiltered.map((nilai, index) => {
                const mapel = appData.mapel.find(m => m.id === nilai.mapel_id);
                const nilaiAngka = typeof nilai.nilai === 'number' ? nilai.nilai : parseInt(nilai.nilai) || 0;
                
                // Untuk K13: pisahkan pengetahuan dan keterampilan (simulasi)
                const pengetahuan = nilaiAngka;
                const keterampilan = Math.max(nilaiAngka - 2, 0); // Simulasi nilai keterampilan
                const nilaiAkhir = Math.round((pengetahuan + keterampilan) / 2);
                
                const kkm = parseInt(appData.settings.kkm || 75);
                const predikat = nilaiAkhir >= Math.max(85, kkm + 10) ? 'A' : nilaiAkhir >= kkm ? 'B' : nilaiAkhir >= Math.max(55, kkm - 20) ? 'C' : 'D';
                const deskripsi = nilai.deskripsi || getDeskripsiK13(mapel ? mapel.nama_mapel : '', nilaiAkhir, predikat);
                
                return `
                    <tr>
                        <td class="border border-black px-2 py-2 text-center">${index + 1}</td>
                        <td class="border border-black px-2 py-2">${mapel ? mapel.nama_mapel : '-'}</td>
                        <td class="border border-black px-2 py-2 text-center">${pengetahuan}</td>
                        <td class="border border-black px-2 py-2 text-center">${keterampilan}</td>
                        <td class="border border-black px-2 py-2 text-center font-semibold">${nilaiAkhir}</td>
                        <td class="border border-black px-2 py-2 text-center font-semibold">${predikat}</td>
                        <td class="border border-black px-2 py-2 text-xs">${deskripsi}</td>
                    </tr>
                `;
            }).join('');
        }

        function getDeskripsiK13(namaMapel, nilai, predikat) {
            const deskripsiTemplate = {
                'A': `Sangat baik dalam menguasai ${namaMapel}, mampu menganalisis dan menerapkan konsep dengan sangat baik`,
                'B': `Baik dalam menguasai ${namaMapel}, mampu memahami dan menerapkan konsep dengan baik`,
                'C': `Cukup dalam menguasai ${namaMapel}, perlu bimbingan untuk meningkatkan pemahaman konsep`,
                'D': `Perlu bimbingan intensif dalam menguasai ${namaMapel} untuk mencapai kompetensi yang diharapkan`
            };
            
            return deskripsiTemplate[predikat] || `Menunjukkan capaian yang sesuai dengan kemampuannya dalam ${namaMapel}`;
        }

        // Helper functions untuk ekstrakurikuler dan kehadiran
        function generateEkstrakurikulerRows(nisn) {
            const semester = appData.settings.semester || '1';
            const ekstrakurikuler = appData.ekstrakurikuler.filter(e => e.nisn === nisn && e.semester === semester);
            
            if (ekstrakurikuler.length === 0) {
                return `
                    <tr>
                        <td class="border border-black px-1 py-1 text-center">1</td>
                        <td class="border border-black px-1 py-1">-</td>
                        <td class="border border-black px-1 py-1 text-center">-</td>
                    </tr>
                `;
            }
            
            return ekstrakurikuler.map((ekskul, index) => `
                <tr>
                    <td class="border border-black px-1 py-1 text-center">${index + 1}</td>
                    <td class="border border-black px-1 py-1 text-xs">${ekskul.kegiatan}</td>
                    <td class="border border-black px-1 py-1 text-center text-xs">${ekskul.predikat || '-'}</td>
                </tr>
            `).join('');
        }

        function generateEkstrakurikulerRowsK13(nisn) {
            const semester = appData.settings.semester || '1';
            const ekstrakurikuler = appData.ekstrakurikuler.filter(e => e.nisn === nisn && e.semester === semester);
            
            if (ekstrakurikuler.length === 0) {
                return `
                    <tr>
                        <td class="border border-black px-2 py-1 text-center">1</td>
                        <td class="border border-black px-2 py-1">-</td>
                        <td class="border border-black px-2 py-1 text-center">-</td>
                        <td class="border border-black px-2 py-1">-</td>
                    </tr>
                `;
            }
            
            return ekstrakurikuler.map((ekskul, index) => `
                <tr>
                    <td class="border border-black px-2 py-1 text-center">${index + 1}</td>
                    <td class="border border-black px-2 py-1 text-xs">${ekskul.kegiatan}</td>
                    <td class="border border-black px-2 py-1 text-center text-xs">${ekskul.predikat || '-'}</td>
                    <td class="border border-black px-2 py-1 text-xs">${ekskul.keterangan || '-'}</td>
                </tr>
            `).join('');
        }

        function generateKehadiranRows(nisn) {
            const semester = appData.settings.semester || '1';
            const kehadiran = appData.kehadiran.find(k => k.nisn === nisn && k.semester === semester);
            
            const sakit = kehadiran ? kehadiran.sakit || 0 : 0;
            const izin = kehadiran ? kehadiran.izin || 0 : 0;
            const alpha = kehadiran ? kehadiran.alpha || 0 : 0;
            
            return `
                <tr>
                    <td class="border border-black px-1 py-1">Sakit</td>
                    <td class="border border-black px-1 py-1 text-center w-8">${sakit}</td>
                    <td class="border border-black px-1 py-1 w-8">hari</td>
                </tr>
                <tr>
                    <td class="border border-black px-1 py-1">Izin</td>
                    <td class="border border-black px-1 py-1 text-center">${izin}</td>
                    <td class="border border-black px-1 py-1">hari</td>
                </tr>
                <tr>
                    <td class="border border-black px-1 py-1">Tanpa Keterangan</td>
                    <td class="border border-black px-1 py-1 text-center">${alpha}</td>
                    <td class="border border-black px-1 py-1">hari</td>
                </tr>
            `;
        }

        function generateKehadiranRowsK13(nisn) {
            const semester = appData.settings.semester || '1';
            const kehadiran = appData.kehadiran.find(k => k.nisn === nisn && k.semester === semester);
            
            const sakit = kehadiran ? kehadiran.sakit || 0 : 0;
            const izin = kehadiran ? kehadiran.izin || 0 : 0;
            const alpha = kehadiran ? kehadiran.alpha || 0 : 0;
            
            return `
                <tr>
                    <td class="border border-black px-2 py-1 w-32">Sakit</td>
                    <td class="border border-black px-2 py-1 w-16 text-center">${sakit}</td>
                    <td class="border border-black px-2 py-1 w-16">hari</td>
                    <td class="border border-black px-2 py-1 w-32">Izin</td>
                    <td class="border border-black px-2 py-1 w-16 text-center">${izin}</td>
                    <td class="border border-black px-2 py-1 w-16">hari</td>
                    <td class="border border-black px-2 py-1 w-32">Tanpa Keterangan</td>
                    <td class="border border-black px-2 py-1 w-16 text-center">${alpha}</td>
                    <td class="border border-black px-2 py-1 w-16">hari</td>
                </tr>
            `;
        }

        function generateCatatanWaliKelas(nisn) {
            const semester = appData.settings.semester || '1';
            const kehadiran = appData.kehadiran.find(k => k.nisn === nisn && k.semester === semester);
            
            if (kehadiran && kehadiran.catatan && kehadiran.catatan.trim()) {
                return `<p class="text-xs">${kehadiran.catatan}</p>`;
            }
            
            return `<p class="text-xs italic">Peserta didik menunjukkan perkembangan yang baik dalam mengikuti pembelajaran.</p>`;
        }

        // Helper function untuk status naik kelas
        function getStatusNaikKelas(siswa) {
            const isGenap = appData.settings.semester === '2';
            
            if (!isGenap) {
                return { text: '-', class: '', badgeClass: '' };
            }
            
            if (siswa.status_naik === 'naik') {
                return { 
                    text: 'Naik Kelas', 
                    class: '', 
                    badgeClass: 'bg-green-100 text-green-800' 
                };
            } else if (siswa.status_naik === 'tidak_naik') {
                return { 
                    text: 'Tidak Naik', 
                    class: 'line-through text-red-600', 
                    badgeClass: 'bg-red-100 text-red-800' 
                };
            } else if (siswa.status_naik === 'lulus') {
                return { 
                    text: 'Lulus', 
                    class: '', 
                    badgeClass: 'bg-blue-100 text-blue-800' 
                };
            }
            
            return { 
                text: 'Belum Diproses', 
                class: '', 
                badgeClass: 'bg-yellow-100 text-yellow-800' 
            };
        }

        // Naik Kelas Management
        let currentNaikSiswa = null;

        function naikKelas(nisn) {
            const siswa = appData.siswa.find(s => s.nisn === nisn);
            if (!siswa) return;

            currentNaikSiswa = nisn;

            // Populate siswa info
            document.getElementById('naik-nama-siswa').textContent = siswa.nama;
            document.getElementById('naik-nisn-siswa').textContent = siswa.nisn;
            document.getElementById('naik-kelas-saat-ini').textContent = siswa.kelas || '-';

            // Load kelas options
            const kelasSelect = document.querySelector('select[name="kelas_tujuan"]');
            kelasSelect.innerHTML = '<option value="">-- Pilih Kelas Tujuan --</option>' +
                appData.kelas.map(kelas => `<option value="${kelas.nama_kelas}">${kelas.nama_kelas}</option>`).join('');

            // Set current values if exists
            const form = document.getElementById('form-naik-kelas');
            form.status_naik.value = siswa.status_naik || '';
            form.kelas_tujuan.value = siswa.kelas_tujuan || '';
            form.catatan_naik.value = siswa.catatan_naik || '';

            // Show/hide kelas tujuan based on status
            toggleKelasTujuan(siswa.status_naik || '');

            // Show modal
            document.getElementById('modal-naik-kelas').classList.remove('hidden');
            document.getElementById('modal-naik-kelas').classList.add('flex');
        }

        function toggleKelasTujuan(status) {
            const container = document.getElementById('kelas-tujuan-container');
            if (status === 'naik') {
                container.classList.remove('hidden');
                document.querySelector('select[name="kelas_tujuan"]').required = true;
            } else {
                container.classList.add('hidden');
                document.querySelector('select[name="kelas_tujuan"]').required = false;
            }
        }

        // Modal naik kelas handlers
        document.getElementById('batal-naik-kelas-btn').addEventListener('click', function() {
            document.getElementById('modal-naik-kelas').classList.add('hidden');
            document.getElementById('modal-naik-kelas').classList.remove('flex');
            currentNaikSiswa = null;
        });

        // Status change handler
        document.querySelector('select[name="status_naik"]').addEventListener('change', function() {
            toggleKelasTujuan(this.value);
        });

        document.getElementById('form-naik-kelas').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentNaikSiswa) return;

            const formData = new FormData(this);
            const siswaIndex = appData.siswa.findIndex(s => s.nisn === currentNaikSiswa);
            
            if (siswaIndex !== -1) {
                appData.siswa[siswaIndex].status_naik = formData.get('status_naik');
                appData.siswa[siswaIndex].kelas_tujuan = formData.get('kelas_tujuan');
                appData.siswa[siswaIndex].catatan_naik = formData.get('catatan_naik');
                
                // If naik kelas, update current kelas
                if (formData.get('status_naik') === 'naik' && formData.get('kelas_tujuan')) {
                    appData.siswa[siswaIndex].kelas = formData.get('kelas_tujuan');
                }

                saveData();
                loadSiswaTable();

                // Close modal
                document.getElementById('modal-naik-kelas').classList.add('hidden');
                document.getElementById('modal-naik-kelas').classList.remove('flex');
                currentNaikSiswa = null;

                showToast('Status kenaikan kelas berhasil diproses!');
            }
        });

        // Naik Kelas Management
        function loadNaikKelasSelectors() {
            const kelasSelect = document.getElementById('select-kelas-naik');
            const semesterSelect = document.getElementById('select-semester-naik');
            
            // Filter kelas for tutors
            let availableKelas = appData.kelas;
            if (currentUser.level === 'tutor') {
                availableKelas = appData.kelas.filter(k => k.wali_kelas_id === currentUser.tutor_id);
            }
            
            kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>' +
                availableKelas.map(kelas => `<option value="${kelas.nama_kelas}">${kelas.nama_kelas}</option>`).join('');
            
            // Set current semester
            semesterSelect.value = appData.settings.semester || '2';
            
            // Handle selection changes
            function updateNaikKelasForm() {
                const kelas = kelasSelect.value;
                const semester = semesterSelect.value;
                
                if (kelas) {
                    loadNaikKelasForm(kelas, semester);
                } else {
                    document.getElementById('naik-kelas-form-container').classList.add('hidden');
                    document.getElementById('naik-kelas-empty-state').classList.remove('hidden');
                }
            }
            
            kelasSelect.addEventListener('change', updateNaikKelasForm);
            semesterSelect.addEventListener('change', updateNaikKelasForm);
        }

        function loadNaikKelasForm(kelas, semester) {
            const siswaKelas = appData.siswa.filter(s => s.kelas === kelas);
            
            if (siswaKelas.length === 0) {
                document.getElementById('naik-kelas-empty-state').innerHTML = 'Tidak ada siswa di kelas ini.';
                document.getElementById('naik-kelas-empty-state').classList.remove('hidden');
                document.getElementById('naik-kelas-form-container').classList.add('hidden');
                return;
            }
            
            // Generate table body
            const tbody = document.getElementById('naik-kelas-table-body');
            tbody.innerHTML = siswaKelas.map((siswa, index) => {
                const statusNaik = siswa.status_naik || '';
                const kelasTujuan = siswa.kelas_tujuan || '';
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nisn}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.kelas}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select class="status-naik-input border border-gray-300 rounded px-2 py-1 text-sm" data-nisn="${siswa.nisn}">
                                <option value="">-- Pilih Status --</option>
                                <option value="naik" ${statusNaik === 'naik' ? 'selected' : ''}>Naik Kelas</option>
                                <option value="tidak_naik" ${statusNaik === 'tidak_naik' ? 'selected' : ''}>Tidak Naik</option>
                                <option value="lulus" ${statusNaik === 'lulus' ? 'selected' : ''}>Lulus</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select class="kelas-tujuan-input border border-gray-300 rounded px-2 py-1 text-sm ${statusNaik !== 'naik' ? 'hidden' : ''}" data-nisn="${siswa.nisn}">
                                <option value="">-- Pilih Kelas --</option>
                                ${appData.kelas.map(k => `<option value="${k.nama_kelas}" ${kelasTujuan === k.nama_kelas ? 'selected' : ''}>${k.nama_kelas}</option>`).join('')}
                            </select>
                            <span class="text-gray-500 text-sm ${statusNaik === 'naik' ? 'hidden' : ''}" data-nisn="${siswa.nisn}">-</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="resetStatusNaik('${siswa.nisn}')" class="text-red-600 hover:text-red-900 text-xs">Reset</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add event listeners for status change
            document.querySelectorAll('.status-naik-input').forEach(select => {
                select.addEventListener('change', function() {
                    const nisn = this.dataset.nisn;
                    const status = this.value;
                    const kelasTujuanSelect = document.querySelector(`.kelas-tujuan-input[data-nisn="${nisn}"]`);
                    const kelasTujuanSpan = document.querySelector(`span[data-nisn="${nisn}"]`);
                    
                    if (status === 'naik') {
                        kelasTujuanSelect.classList.remove('hidden');
                        kelasTujuanSpan.classList.add('hidden');
                    } else {
                        kelasTujuanSelect.classList.add('hidden');
                        kelasTujuanSpan.classList.remove('hidden');
                    }
                });
            });
            
            document.getElementById('naik-kelas-empty-state').classList.add('hidden');
            document.getElementById('naik-kelas-form-container').classList.remove('hidden');
        }

        // Reset status naik kelas
        function resetStatusNaik(nisn) {
            const statusSelect = document.querySelector(`.status-naik-input[data-nisn="${nisn}"]`);
            const kelasTujuanSelect = document.querySelector(`.kelas-tujuan-input[data-nisn="${nisn}"]`);
            const kelasTujuanSpan = document.querySelector(`span[data-nisn="${nisn}"]`);
            
            statusSelect.value = '';
            kelasTujuanSelect.value = '';
            kelasTujuanSelect.classList.add('hidden');
            kelasTujuanSpan.classList.remove('hidden');
        }

        // Save all naik kelas changes
        document.getElementById('simpan-semua-naik-btn').addEventListener('click', function() {
            const statusInputs = document.querySelectorAll('.status-naik-input');
            const kelasTujuanInputs = document.querySelectorAll('.kelas-tujuan-input');
            
            let updated = 0;
            
            statusInputs.forEach(input => {
                const nisn = input.dataset.nisn;
                const status = input.value;
                const kelasTujuanInput = Array.from(kelasTujuanInputs).find(k => k.dataset.nisn === nisn);
                const kelasTujuan = kelasTujuanInput ? kelasTujuanInput.value : '';
                
                const siswaIndex = appData.siswa.findIndex(s => s.nisn === nisn);
                if (siswaIndex !== -1) {
                    appData.siswa[siswaIndex].status_naik = status;
                    appData.siswa[siswaIndex].kelas_tujuan = kelasTujuan;
                    
                    // If naik kelas, update current kelas
                    if (status === 'naik' && kelasTujuan) {
                        appData.siswa[siswaIndex].kelas = kelasTujuan;
                    }
                    
                    if (status) updated++;
                }
            });
            
            saveData();
            showToast(`Berhasil memproses ${updated} siswa!`);
        });

        // Legger Nilai Management
        function loadLeggerSelectors() {
            const kelasSelect = document.getElementById('select-kelas-legger');
            
            // Filter kelas for tutors
            let availableKelas = appData.kelas;
            if (currentUser.level === 'tutor') {
                availableKelas = appData.kelas.filter(k => k.wali_kelas_id === currentUser.tutor_id);
            }
            
            kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>' +
                availableKelas.map(kelas => `<option value="${kelas.nama_kelas}">${kelas.nama_kelas}</option>`).join('');
            
            // Handle selection changes
            function updateLeggerPreview() {
                const kelas = kelasSelect.value;
                const kurikulum = document.getElementById('select-kurikulum-legger').value;
                
                if (kelas) {
                    generateLeggerPreview(kelas, kurikulum);
                } else {
                    document.getElementById('legger-preview').classList.add('hidden');
                    document.getElementById('legger-empty-state').classList.remove('hidden');
                }
            }
            
            kelasSelect.addEventListener('change', updateLeggerPreview);
            document.getElementById('select-kurikulum-legger').addEventListener('change', updateLeggerPreview);
        }

        function generateLeggerPreview(kelas, kurikulum) {
            const siswaKelas = appData.siswa.filter(s => s.kelas === kelas);
            const mapelKurikulum = appData.mapel.filter(m => m.kurikulum === kurikulum);
            
            if (siswaKelas.length === 0) {
                document.getElementById('legger-empty-state').innerHTML = 'Tidak ada siswa di kelas ini.';
                document.getElementById('legger-empty-state').classList.remove('hidden');
                document.getElementById('legger-preview').classList.add('hidden');
                return;
            }
            
            if (mapelKurikulum.length === 0) {
                document.getElementById('legger-empty-state').innerHTML = 'Tidak ada mata pelajaran untuk kurikulum ini.';
                document.getElementById('legger-empty-state').classList.remove('hidden');
                document.getElementById('legger-preview').classList.add('hidden');
                return;
            }
            
            // Generate header
            const header = document.getElementById('legger-header');
            header.innerHTML = `
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border border-gray-300">No</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border border-gray-300">NISN</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border border-gray-300">Nama Siswa</th>
                ${mapelKurikulum.map(mapel => 
                    `<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase border border-gray-300" style="writing-mode: vertical-rl; text-orientation: mixed;">${mapel.nama_mapel}</th>`
                ).join('')}
                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase border border-gray-300">Rata-rata</th>
            `;
            
            // Generate body
            const body = document.getElementById('legger-body');
            body.innerHTML = siswaKelas.map((siswa, index) => {
                const nilaiSiswa = appData.nilai.filter(n => n.nisn === siswa.nisn);
                let totalNilai = 0;
                let jumlahMapel = 0;
                
                const nilaiCells = mapelKurikulum.map(mapel => {
                    const nilai = nilaiSiswa.find(n => n.mapel_id === mapel.id);
                    const nilaiValue = nilai ? nilai.nilai : '-';
                    
                    if (nilai && nilai.nilai) {
                        const numValue = typeof nilai.nilai === 'number' ? nilai.nilai : 
                                       nilai.nilai === 'A' ? 90 : nilai.nilai === 'B' ? 80 : nilai.nilai === 'C' ? 70 : 0;
                        if (numValue > 0) {
                            totalNilai += numValue;
                            jumlahMapel++;
                        }
                    }
                    
                    return `<td class="px-3 py-2 text-center text-sm border border-gray-300">${nilaiValue}</td>`;
                }).join('');
                
                const rataRata = jumlahMapel > 0 ? (totalNilai / jumlahMapel).toFixed(1) : '-';
                
                return `
                    <tr>
                        <td class="px-3 py-2 text-center text-sm border border-gray-300">${index + 1}</td>
                        <td class="px-3 py-2 text-sm border border-gray-300">${siswa.nisn}</td>
                        <td class="px-3 py-2 text-sm border border-gray-300">${siswa.nama}</td>
                        ${nilaiCells}
                        <td class="px-3 py-2 text-center text-sm font-semibold border border-gray-300">${rataRata}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('legger-empty-state').classList.add('hidden');
            document.getElementById('legger-preview').classList.remove('hidden');
        }

        // Download legger as Excel
        document.getElementById('download-legger-btn').addEventListener('click', function() {
            const kelas = document.getElementById('select-kelas-legger').value;
            const kurikulum = document.getElementById('select-kurikulum-legger').value;
            
            if (!kelas) {
                showToast('Pilih kelas terlebih dahulu!', 'error');
                return;
            }
            
            downloadLeggerExcel(kelas, kurikulum);
        });

        function downloadLeggerExcel(kelas, kurikulum) {
            const siswaKelas = appData.siswa.filter(s => s.kelas === kelas);
            const mapelKurikulum = appData.mapel.filter(m => m.kurikulum === kurikulum);
            
            if (siswaKelas.length === 0 || mapelKurikulum.length === 0) {
                showToast('Tidak ada data untuk didownload!', 'error');
                return;
            }
            
            // Prepare data for Excel
            const headers = ['No', 'NISN', 'Nama Siswa', ...mapelKurikulum.map(m => m.nama_mapel), 'Rata-rata'];
            
            const data = siswaKelas.map((siswa, index) => {
                const nilaiSiswa = appData.nilai.filter(n => n.nisn === siswa.nisn);
                let totalNilai = 0;
                let jumlahMapel = 0;
                
                const nilaiRow = mapelKurikulum.map(mapel => {
                    const nilai = nilaiSiswa.find(n => n.mapel_id === mapel.id);
                    const nilaiValue = nilai ? nilai.nilai : '';
                    
                    if (nilai && nilai.nilai) {
                        const numValue = typeof nilai.nilai === 'number' ? nilai.nilai : 
                                       nilai.nilai === 'A' ? 90 : nilai.nilai === 'B' ? 80 : nilai.nilai === 'C' ? 70 : 0;
                        if (numValue > 0) {
                            totalNilai += numValue;
                            jumlahMapel++;
                        }
                    }
                    
                    return nilaiValue;
                });
                
                const rataRata = jumlahMapel > 0 ? (totalNilai / jumlahMapel).toFixed(1) : '';
                
                return [index + 1, siswa.nisn, siswa.nama, ...nilaiRow, rataRata];
            });
            
            // Create workbook
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            const wb = XLSX.utils.book_new();
            
            // Add title rows
            XLSX.utils.sheet_add_aoa(ws, [
                [`LEGGER NILAI - ${kelas.toUpperCase()}`],
                [`${appData.settings.school_name}`],
                [`Tahun Ajaran: ${appData.settings.tahun_ajaran || '-'} | Semester: ${appData.settings.semester === '1' ? 'Ganjil' : 'Genap'}`],
                [`Kurikulum: ${kurikulum === 'merdeka' ? 'Kurikulum Merdeka' : 'Kurikulum 2013'}`],
                []
            ], { origin: 'A1' });
            
            // Adjust data position
            XLSX.utils.sheet_add_aoa(ws, [headers, ...data], { origin: 'A6' });
            
            // Set column widths
            const colWidths = [
                { wch: 5 },  // No
                { wch: 15 }, // NISN
                { wch: 25 }, // Nama
                ...mapelKurikulum.map(() => ({ wch: 12 })), // Mapel columns
                { wch: 10 }  // Rata-rata
            ];
            ws['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(wb, ws, 'Legger Nilai');
            
            // Download file
            const fileName = `Legger_Nilai_${kelas}_${kurikulum}_${appData.settings.tahun_ajaran || 'TA'}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('Legger nilai berhasil didownload!');
        }

        // Ekstrakurikuler Management
        function loadEkskulSelectors() {
            const kelasSelect = document.getElementById('select-kelas-ekskul');
            const semesterSelect = document.getElementById('select-semester-ekskul');
            
            // Filter kelas for tutors
            let availableKelas = appData.kelas;
            if (currentUser.level === 'tutor') {
                availableKelas = appData.kelas.filter(k => k.wali_kelas_id === currentUser.tutor_id);
            }
            
            kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>' +
                availableKelas.map(kelas => `<option value="${kelas.nama_kelas}">${kelas.nama_kelas}</option>`).join('');
            
            // Set current semester
            semesterSelect.value = appData.settings.semester || '1';
            
            // Handle selection changes
            function updateEkskulForm() {
                const kelas = kelasSelect.value;
                const semester = semesterSelect.value;
                
                if (kelas) {
                    loadEkskulForm(kelas, semester);
                } else {
                    document.getElementById('ekskul-form-container').classList.add('hidden');
                    document.getElementById('ekskul-empty-state').classList.remove('hidden');
                }
            }
            
            kelasSelect.addEventListener('change', updateEkskulForm);
            semesterSelect.addEventListener('change', updateEkskulForm);
        }

        function loadEkskulForm(kelas, semester) {
            const siswaKelas = appData.siswa.filter(s => s.kelas === kelas);
            
            if (siswaKelas.length === 0) {
                document.getElementById('ekskul-empty-state').innerHTML = 'Tidak ada siswa di kelas ini.';
                document.getElementById('ekskul-empty-state').classList.remove('hidden');
                document.getElementById('ekskul-form-container').classList.add('hidden');
                return;
            }
            
            const tbody = document.getElementById('ekskul-table-body');
            tbody.innerHTML = siswaKelas.map((siswa, index) => {
                const existingEkskul = appData.ekstrakurikuler.find(e => e.nisn === siswa.nisn && e.semester === semester);
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nisn}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" class="ekskul-kegiatan-input border border-gray-300 rounded px-2 py-1 w-full text-sm" 
                                   data-nisn="${siswa.nisn}" value="${existingEkskul ? existingEkskul.kegiatan : ''}" 
                                   placeholder="Nama kegiatan ekstrakurikuler">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select class="ekskul-predikat-input border border-gray-300 rounded px-2 py-1 text-sm" data-nisn="${siswa.nisn}">
                                <option value="">-- Pilih --</option>
                                <option value="Sangat Baik" ${existingEkskul && existingEkskul.predikat === 'Sangat Baik' ? 'selected' : ''}>Sangat Baik</option>
                                <option value="Baik" ${existingEkskul && existingEkskul.predikat === 'Baik' ? 'selected' : ''}>Baik</option>
                                <option value="Cukup" ${existingEkskul && existingEkskul.predikat === 'Cukup' ? 'selected' : ''}>Cukup</option>
                                <option value="Kurang" ${existingEkskul && existingEkskul.predikat === 'Kurang' ? 'selected' : ''}>Kurang</option>
                            </select>
                        </td>
                        <td class="px-6 py-4">
                            <textarea class="ekskul-keterangan-input border border-gray-300 rounded px-2 py-1 w-full text-xs" 
                                      rows="2" data-nisn="${siswa.nisn}" 
                                      placeholder="Keterangan kegiatan...">${existingEkskul ? existingEkskul.keterangan || '' : ''}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('ekskul-empty-state').classList.add('hidden');
            document.getElementById('ekskul-form-container').classList.remove('hidden');
        }

        // Save ekstrakurikuler
        document.getElementById('simpan-ekskul-btn').addEventListener('click', function() {
            const kelas = document.getElementById('select-kelas-ekskul').value;
            const semester = document.getElementById('select-semester-ekskul').value;
            const kegiatanInputs = document.querySelectorAll('.ekskul-kegiatan-input');
            const predikatInputs = document.querySelectorAll('.ekskul-predikat-input');
            const keteranganInputs = document.querySelectorAll('.ekskul-keterangan-input');
            
            let saved = 0;
            kegiatanInputs.forEach(input => {
                const nisn = input.dataset.nisn;
                const kegiatan = input.value;
                const predikatInput = Array.from(predikatInputs).find(p => p.dataset.nisn === nisn);
                const keteranganInput = Array.from(keteranganInputs).find(k => k.dataset.nisn === nisn);
                const predikat = predikatInput ? predikatInput.value : '';
                const keterangan = keteranganInput ? keteranganInput.value : '';
                
                // Remove existing ekstrakurikuler for this student and semester
                appData.ekstrakurikuler = appData.ekstrakurikuler.filter(e => !(e.nisn === nisn && e.semester === semester));
                
                // Add new ekstrakurikuler if kegiatan is filled
                if (kegiatan.trim()) {
                    appData.ekstrakurikuler.push({
                        id: Date.now().toString() + Math.random(),
                        nisn: nisn,
                        semester: semester,
                        kegiatan: kegiatan,
                        predikat: predikat,
                        keterangan: keterangan,
                        tanggal: new Date().toISOString().split('T')[0]
                    });
                    saved++;
                }
            });
            
            saveData();
            showToast(`Berhasil menyimpan ${saved} data ekstrakurikuler!`);
        });

        // Kehadiran Management
        function loadKehadiranSelectors() {
            const kelasSelect = document.getElementById('select-kelas-kehadiran');
            const semesterSelect = document.getElementById('select-semester-kehadiran');
            
            // Filter kelas for tutors
            let availableKelas = appData.kelas;
            if (currentUser.level === 'tutor') {
                availableKelas = appData.kelas.filter(k => k.wali_kelas_id === currentUser.tutor_id);
            }
            
            kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>' +
                availableKelas.map(kelas => `<option value="${kelas.nama_kelas}">${kelas.nama_kelas}</option>`).join('');
            
            // Set current semester
            semesterSelect.value = appData.settings.semester || '1';
            
            // Handle selection changes
            function updateKehadiranForm() {
                const kelas = kelasSelect.value;
                const semester = semesterSelect.value;
                
                if (kelas) {
                    loadKehadiranForm(kelas, semester);
                } else {
                    document.getElementById('kehadiran-form-container').classList.add('hidden');
                    document.getElementById('kehadiran-empty-state').classList.remove('hidden');
                }
            }
            
            kelasSelect.addEventListener('change', updateKehadiranForm);
            semesterSelect.addEventListener('change', updateKehadiranForm);
        }

        function loadKehadiranForm(kelas, semester) {
            const siswaKelas = appData.siswa.filter(s => s.kelas === kelas);
            
            if (siswaKelas.length === 0) {
                document.getElementById('kehadiran-empty-state').innerHTML = 'Tidak ada siswa di kelas ini.';
                document.getElementById('kehadiran-empty-state').classList.remove('hidden');
                document.getElementById('kehadiran-form-container').classList.add('hidden');
                return;
            }
            
            const tbody = document.getElementById('kehadiran-table-body');
            tbody.innerHTML = siswaKelas.map((siswa, index) => {
                const existingKehadiran = appData.kehadiran.find(k => k.nisn === siswa.nisn && k.semester === semester);
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nisn}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="number" min="0" class="kehadiran-sakit-input border border-gray-300 rounded px-2 py-1 w-16 text-sm text-center" 
                                   data-nisn="${siswa.nisn}" value="${existingKehadiran ? existingKehadiran.sakit || 0 : 0}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="number" min="0" class="kehadiran-izin-input border border-gray-300 rounded px-2 py-1 w-16 text-sm text-center" 
                                   data-nisn="${siswa.nisn}" value="${existingKehadiran ? existingKehadiran.izin || 0 : 0}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="number" min="0" class="kehadiran-alpha-input border border-gray-300 rounded px-2 py-1 w-16 text-sm text-center" 
                                   data-nisn="${siswa.nisn}" value="${existingKehadiran ? existingKehadiran.alpha || 0 : 0}">
                        </td>
                        <td class="px-6 py-4">
                            <textarea class="kehadiran-catatan-input border border-gray-300 rounded px-2 py-1 w-full text-xs" 
                                      rows="2" data-nisn="${siswa.nisn}" 
                                      placeholder="Catatan wali kelas untuk siswa...">${existingKehadiran ? existingKehadiran.catatan || '' : ''}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('kehadiran-empty-state').classList.add('hidden');
            document.getElementById('kehadiran-form-container').classList.remove('hidden');
        }

        // Save kehadiran
        document.getElementById('simpan-kehadiran-btn').addEventListener('click', function() {
            const kelas = document.getElementById('select-kelas-kehadiran').value;
            const semester = document.getElementById('select-semester-kehadiran').value;
            const sakitInputs = document.querySelectorAll('.kehadiran-sakit-input');
            const izinInputs = document.querySelectorAll('.kehadiran-izin-input');
            const alphaInputs = document.querySelectorAll('.kehadiran-alpha-input');
            const catatanInputs = document.querySelectorAll('.kehadiran-catatan-input');
            
            let saved = 0;
            sakitInputs.forEach(input => {
                const nisn = input.dataset.nisn;
                const sakit = parseInt(input.value) || 0;
                const izinInput = Array.from(izinInputs).find(i => i.dataset.nisn === nisn);
                const alphaInput = Array.from(alphaInputs).find(a => a.dataset.nisn === nisn);
                const catatanInput = Array.from(catatanInputs).find(c => c.dataset.nisn === nisn);
                const izin = izinInput ? parseInt(izinInput.value) || 0 : 0;
                const alpha = alphaInput ? parseInt(alphaInput.value) || 0 : 0;
                const catatan = catatanInput ? catatanInput.value : '';
                
                // Remove existing kehadiran for this student and semester
                appData.kehadiran = appData.kehadiran.filter(k => !(k.nisn === nisn && k.semester === semester));
                
                // Add new kehadiran
                appData.kehadiran.push({
                    id: Date.now().toString() + Math.random(),
                    nisn: nisn,
                    semester: semester,
                    sakit: sakit,
                    izin: izin,
                    alpha: alpha,
                    catatan: catatan,
                    tanggal: new Date().toISOString().split('T')[0]
                });
                saved++;
            });
            
            saveData();
            showToast(`Berhasil menyimpan ${saved} data kehadiran dan catatan!`);
        });

        // WhatsApp function - safe way to open WhatsApp
        function openWhatsApp() {
            const phoneNumber = '6281357788364';
            const message = encodeURIComponent('Halo, saya butuh bantuan dengan e-RaporKu');
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
            
            // Use window.open to avoid iframe navigation restrictions
            const newWindow = window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
            
            if (!newWindow) {
                // Fallback if popup is blocked
                showToast('Popup diblokir! Silakan buka WhatsApp secara manual ke: +62 813-5778-8364', 'info');
            }
        }

        // Initialize app
        checkAuth();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99bad7e2e37cfe13',t:'MTc2MjY2NTQ0Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>