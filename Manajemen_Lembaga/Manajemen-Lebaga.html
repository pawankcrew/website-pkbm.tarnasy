<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manajemen Lembaga</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      height: 100%;
      overflow: hidden;
    }
    html {
      height: 100%;
    }
    .sidebar {
      transition: all 0.3s ease;
    }
    .menu-item {
      transition: all 0.2s ease;
    }
    .menu-item:hover {
      transform: translateX(4px);
    }
    .content-area {
      height: 100%;
      overflow-y: auto;
    }
    .card {
      transition: all 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .btn {
      transition: all 0.2s ease;
    }
    .btn:hover {
      transform: scale(1.02);
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media print {
      body * {
        visibility: hidden;
      }
      #printArea, #printArea * {
        visibility: visible;
      }
      #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      .no-print {
        display: none !important;
      }
    }
    .foto-preview {
      width: 120px;
      height: 160px;
      object-fit: cover;
      border: 2px solid #cbd5e1;
      border-radius: 8px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div id="app" class="flex h-full"></div>
  <div id="printArea" style="display: none;"></div>
  <script>
    const defaultConfig = {
      app_title: "Manajemen Lembaga",
      primary_color: "#2563eb",
      secondary_color: "#f8fafc",
      text_color: "#1e293b",
      accent_color: "#10b981",
      sidebar_color: "#1e40af",
      font_family: "Inter",
      font_size: 14
    };

    let allData = [];
    let currentView = 'dashboard';
    let selectedClass = '';
    let selectedDate = new Date().toISOString().split('T')[0];

    // LocalStorage functions
    function loadFromLocalStorage() {
      try {
        const stored = localStorage.getItem('absensi_data');
        if (stored) {
          allData = JSON.parse(stored);
        }
      } catch (error) {
        console.error('Error loading from localStorage:', error);
        allData = [];
      }
    }

    function saveToLocalStorage() {
      try {
        localStorage.setItem('absensi_data', JSON.stringify(allData));
      } catch (error) {
        console.error('Error saving to localStorage:', error);
        showToast('Gagal menyimpan data', 'error');
      }
    }

    function createRecord(record) {
      record._id = `${record.type}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      allData.push(record);
      saveToLocalStorage();
      return { success: true };
    }

    function updateRecord(record) {
      const index = allData.findIndex(r => r._id === record._id);
      if (index !== -1) {
        allData[index] = record;
        saveToLocalStorage();
        return { success: true };
      }
      return { success: false };
    }

    function deleteRecord(record) {
      const index = allData.findIndex(r => r._id === record._id);
      if (index !== -1) {
        allData.splice(index, 1);
        saveToLocalStorage();
        return { success: true };
      }
      return { success: false };
    }

    async function initApp() {
      try {
        // Load data from localStorage
        loadFromLocalStorage();

        // Initialize Element SDK
        if (window.elementSdk) {
          window.elementSdk.init({
            defaultConfig,
            onConfigChange: async (config) => {
              document.body.style.fontFamily = `${config.font_family || defaultConfig.font_family}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
              renderCurrentView();
            },
            mapToCapabilities: (config) => ({
              recolorables: [
                {
                  get: () => config.primary_color || defaultConfig.primary_color,
                  set: (value) => {
                    config.primary_color = value;
                    window.elementSdk.setConfig({ primary_color: value });
                  }
                },
                {
                  get: () => config.secondary_color || defaultConfig.secondary_color,
                  set: (value) => {
                    config.secondary_color = value;
                    window.elementSdk.setConfig({ secondary_color: value });
                  }
                },
                {
                  get: () => config.text_color || defaultConfig.text_color,
                  set: (value) => {
                    config.text_color = value;
                    window.elementSdk.setConfig({ text_color: value });
                  }
                },
                {
                  get: () => config.accent_color || defaultConfig.accent_color,
                  set: (value) => {
                    config.accent_color = value;
                    window.elementSdk.setConfig({ accent_color: value });
                  }
                },
                {
                  get: () => config.sidebar_color || defaultConfig.sidebar_color,
                  set: (value) => {
                    config.sidebar_color = value;
                    window.elementSdk.setConfig({ sidebar_color: value });
                  }
                }
              ],
              borderables: [],
              fontEditable: {
                get: () => config.font_family || defaultConfig.font_family,
                set: (value) => {
                  config.font_family = value;
                  window.elementSdk.setConfig({ font_family: value });
                }
              },
              fontSizeable: {
                get: () => config.font_size || defaultConfig.font_size,
                set: (value) => {
                  config.font_size = value;
                  window.elementSdk.setConfig({ font_size: value });
                }
              }
            }),
            mapToEditPanelValues: (config) => new Map([
              ["app_title", config.app_title || defaultConfig.app_title]
            ])
          });
        }

        renderCurrentView();
      } catch (error) {
        console.error('Initialization error:', error);
        renderCurrentView();
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      const config = window.elementSdk?.config || defaultConfig;
      toast.style.backgroundColor = type === 'success' ? (config.accent_color || defaultConfig.accent_color) : '#ef4444';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function getStudents() {
      return allData.filter(item => item.type === 'student');
    }

    function getAttendances() {
      return allData.filter(item => item.type === 'attendance');
    }

    function getTutors() {
      return allData.filter(item => item.type === 'tutor');
    }

    function getSettings() {
      const settings = allData.find(item => item.type === 'settings');
      return settings || {
        nama_lembaga: '',
        alamat_lembaga: '',
        telp_lembaga: '',
        email_lembaga: '',
        logo_url: '',
        nama_kepsek: '',
        nip_kepsek: ''
      };
    }

    function getClasses() {
      const students = getStudents();
      const classes = [...new Set(students.map(s => s.kelas))].filter(Boolean);
      return classes.sort();
    }

    function renderCurrentView() {
      const app = document.getElementById('app');
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      
      app.innerHTML = `
        <div class="sidebar" style="width: 280px; background: ${config.sidebar_color || defaultConfig.sidebar_color}; color: white; padding: 24px; overflow-y: auto;">
          <div style="margin-bottom: 32px;">
            <h1 style="font-size: ${baseSize * 1.5}px; font-weight: 700; margin: 0 0 8px 0;">${config.app_title || defaultConfig.app_title}</h1>
            <p style="font-size: ${baseSize * 0.9}px; opacity: 0.9; margin: 0;">Manajemen Absensi</p>
          </div>
          
          <nav>
            <div class="menu-item" onclick="switchView('dashboard')" style="padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; background: ${currentView === 'dashboard' ? 'rgba(255,255,255,0.2)' : 'transparent'}; font-size: ${baseSize}px;">
              üìä Dashboard
            </div>
            <div class="menu-item" onclick="toggleSettingsMenu()" style="padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; background: ${currentView === 'settings' || currentView === 'notes' ? 'rgba(255,255,255,0.2)' : 'transparent'}; font-size: ${baseSize}px;">
              ‚öôÔ∏è Pengaturan Lembaga
            </div>
            <div id="settingsSubmenu" style="display: ${currentView === 'settings' || currentView === 'notes' ? 'block' : 'none'}; margin-left: 20px;">
              <div class="menu-item" onclick="switchView('settings')" style="padding: 8px 16px; margin-bottom: 4px; border-radius: 8px; cursor: pointer; background: ${currentView === 'settings' ? 'rgba(255,255,255,0.2)' : 'transparent'}; font-size: ${baseSize * 0.9}px;">
                üìã Edit Lembaga
              </div>
              <div class="menu-item" onclick="switchView('notes')" style="padding: 8px 16px; margin-bottom: 4px; border-radius: 8px; cursor: pointer; background: ${currentView === 'notes' ? 'rgba(255,255,255,0.2)' : 'transparent'}; font-size: ${baseSize * 0.9}px;">
                üìù Note
              </div>
            </div>
            <div class="menu-item" onclick="switchView('tutors')" style="padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; background: ${currentView === 'tutors' ? 'rgba(255,255,255,0.2)' : 'transparent'}; font-size: ${baseSize}px;">
              üë®‚Äçüè´ Manajemen Tutor
            </div>
            <div class="menu-item" onclick="switchView('sk')" style="padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; background: ${currentView === 'sk' ? 'rgba(255,255,255,0.2)' : 'transparent'}; font-size: ${baseSize}px;">
              üìÑ SK Lembaga
            </div>
            <div class="menu-item" onclick="switchView('upload')" style="padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; background: ${currentView === 'upload' ? 'rgba(255,255,255,0.2)' : 'transparent'}; font-size: ${baseSize}px;">
              üì§ Upload Data Siswa
            </div>
            <div class="menu-item" onclick="switchView('students')" style="padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; background: ${currentView === 'students' ? 'rgba(255,255,255,0.2)' : 'transparent'}; font-size: ${baseSize}px;">
              üë• Data Siswa
            </div>
            <div class="menu-item" onclick="switchView('print')" style="padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; background: ${currentView === 'print' ? 'rgba(255,255,255,0.2)' : 'transparent'}; font-size: ${baseSize}px;">
              üñ®Ô∏è Cetak Absensi Manual
            </div>
            <div class="menu-item" onclick="switchView('kta')" style="padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; background: ${currentView === 'kta' ? 'rgba(255,255,255,0.2)' : 'transparent'}; font-size: ${baseSize}px;">
              ü™™ Cetak KTA
            </div>
          </nav>
        </div>
        
        <div class="content-area" style="flex: 1; background: ${config.secondary_color || defaultConfig.secondary_color}; padding: 32px;">
          <div id="content"></div>
        </div>
      `;

      renderContent();
    }

    function switchView(view) {
      currentView = view;
      renderCurrentView();
    }

    function renderContent() {
      const content = document.getElementById('content');
      
      switch(currentView) {
        case 'dashboard':
          renderDashboard(content);
          break;
        case 'settings':
          renderSettings(content);
          break;
        case 'notes':
          renderNotes(content);
          break;
        case 'tutors':
          renderTutors(content);
          break;
        case 'sk':
          renderSK(content);
          break;
        case 'upload':
          renderUpload(content);
          break;
        case 'students':
          renderStudents(content);
          break;
        case 'print':
          renderPrintAttendance(content);
          break;
        case 'kta':
          renderKTA(content);
          break;
      }
    }

    function toggleSettingsMenu() {
      const submenu = document.getElementById('settingsSubmenu');
      if (submenu) {
        submenu.style.display = submenu.style.display === 'none' ? 'block' : 'none';
      }
    }

    function getNotes() {
      return allData.filter(item => item.type === 'note').sort((a, b) => {
        return new Date(b.created_at) - new Date(a.created_at);
      });
    }

    function renderNotesList() {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const notes = getNotes();

      if (notes.length === 0) {
        return `
          <div style="text-align: center; padding: 40px; color: #64748b;">
            <p style="margin: 0; font-size: ${baseSize}px;">Belum ada catatan. Buat catatan baru di menu Pengaturan Lembaga ‚Üí Note</p>
          </div>
        `;
      }

      return notes.map(note => `
        <div style="background: ${config.secondary_color || defaultConfig.secondary_color}; padding: 20px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid ${config.primary_color || defaultConfig.primary_color};">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <h4 style="font-size: ${baseSize * 1.1}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin: 0;">${note.title}</h4>
            <span style="font-size: ${baseSize * 0.85}px; color: #64748b;">${new Date(note.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
          </div>
          <p style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color}; margin: 0; white-space: pre-wrap; line-height: 1.6;">${note.content}</p>
        </div>
      `).join('');
    }

    function renderNotes(container) {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const notes = getNotes();

      container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="font-size: ${baseSize * 2}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0;">Catatan & Informasi</h2>
          <button onclick="showAddNoteForm()" class="btn" style="background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">
            + Buat Catatan Baru
          </button>
        </div>

        <div id="notesList"></div>
        <div id="noteFormModal" style="display: none;"></div>
      `;

      renderNotesListFull();
    }

    function renderNotesListFull() {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const notes = getNotes();
      const listContainer = document.getElementById('notesList');

      if (notes.length === 0) {
        listContainer.innerHTML = `
          <div style="background: white; padding: 48px; border-radius: 12px; text-align: center; color: #64748b; font-size: ${baseSize}px;">
            Belum ada catatan. Klik tombol "Buat Catatan Baru" untuk menambahkan catatan pertama Anda.
          </div>
        `;
        return;
      }

      listContainer.innerHTML = notes.map(note => `
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; border-left: 4px solid ${config.primary_color || defaultConfig.primary_color};">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
            <h3 style="font-size: ${baseSize * 1.3}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin: 0;">${note.title}</h3>
            <div style="display: flex; gap: 8px; align-items: center;">
              <span style="font-size: ${baseSize * 0.85}px; color: #64748b;">${new Date(note.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
              <button onclick="deleteNote('${note._id}')" style="background: #ef4444; color: white; padding: 6px 12px; border: none; border-radius: 6px; font-size: ${baseSize * 0.85}px; cursor: pointer;">Hapus</button>
            </div>
          </div>
          <p style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color}; margin: 0; white-space: pre-wrap; line-height: 1.6;">${note.content}</p>
        </div>
      `).join('');
    }

    function showAddNoteForm() {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const modal = document.getElementById('noteFormModal');
      
      modal.style.display = 'block';
      modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
          <div style="background: white; padding: 32px; border-radius: 12px; max-width: 600px; width: 90%;">
            <h3 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 24px 0;">Buat Catatan Baru</h3>
            
            <form id="addNoteForm" onsubmit="handleAddNote(event)">
              <div style="margin-bottom: 16px;">
                <label for="note_title" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Judul Catatan</label>
                <input type="text" id="note_title" required placeholder="Contoh: Pengumuman Libur Semester" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
              </div>
              
              <div style="margin-bottom: 24px;">
                <label for="note_content" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Isi Catatan</label>
                <textarea id="note_content" rows="8" required placeholder="Tulis catatan atau informasi penting di sini..." style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px; resize: vertical;"></textarea>
              </div>
              
              <div style="display: flex; gap: 12px;">
                <button type="submit" class="btn" style="flex: 1; background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">Simpan</button>
                <button type="button" onclick="closeNoteForm()" style="flex: 1; background: #64748b; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">Batal</button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    function closeNoteForm() {
      document.getElementById('noteFormModal').style.display = 'none';
    }

    function handleAddNote(event) {
      event.preventDefault();

      const noteData = {
        type: 'note',
        title: document.getElementById('note_title').value,
        content: document.getElementById('note_content').value,
        created_at: new Date().toISOString()
      };

      const result = createRecord(noteData);
      
      if (result.success) {
        showToast('Catatan berhasil ditambahkan', 'success');
        closeNoteForm();
        renderNotesListFull();
        
        // Update dashboard jika sedang di dashboard
        if (currentView === 'dashboard') {
          const notesContainer = document.getElementById('notesContainer');
          if (notesContainer) {
            notesContainer.innerHTML = renderNotesList();
          }
        }
      } else {
        showToast('Gagal menambahkan catatan', 'error');
      }
    }

    function deleteNote(id) {
      const note = allData.find(n => n._id === id);
      if (!note) return;

      const result = deleteRecord(note);
      
      if (result.success) {
        showToast('Catatan berhasil dihapus', 'success');
        renderNotesListFull();
        
        // Update dashboard jika sedang di dashboard
        if (currentView === 'dashboard') {
          const notesContainer = document.getElementById('notesContainer');
          if (notesContainer) {
            notesContainer.innerHTML = renderNotesList();
          }
        }
      } else {
        showToast('Gagal menghapus catatan', 'error');
      }
    }

    function renderDashboard(container) {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const students = getStudents();
      const classes = getClasses();
      const tutors = getTutors();

      container.innerHTML = `
        <h2 style="font-size: ${baseSize * 2}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 24px 0;">Dashboard</h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px;">
          <div class="card" style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div style="font-size: ${baseSize * 0.9}px; color: #64748b; margin-bottom: 8px;">Total Siswa</div>
            <div style="font-size: ${baseSize * 2.5}px; font-weight: 700; color: ${config.primary_color || defaultConfig.primary_color};">${students.length}</div>
          </div>
          
          <div class="card" style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div style="font-size: ${baseSize * 0.9}px; color: #64748b; margin-bottom: 8px;">Total Kelas</div>
            <div style="font-size: ${baseSize * 2.5}px; font-weight: 700; color: ${config.primary_color || defaultConfig.primary_color};">${classes.length}</div>
          </div>
          
          <div class="card" style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div style="font-size: ${baseSize * 0.9}px; color: #64748b; margin-bottom: 8px;">Total Tutor</div>
            <div style="font-size: ${baseSize * 2.5}px; font-weight: 700; color: ${config.primary_color || defaultConfig.primary_color};">${tutors.length}</div>
          </div>
        </div>

        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
          <h3 style="font-size: ${baseSize * 1.3}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 16px 0;">üìù Catatan & Informasi</h3>
          <div id="notesContainer" style="font-size: ${baseSize}px;">
            ${renderNotesList()}
          </div>
        </div>
      `;
    }

    function renderSettings(container) {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const settings = getSettings();

      container.innerHTML = `
        <h2 style="font-size: ${baseSize * 2}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 24px 0;">Pengaturan Lembaga</h2>
        
        <div style="background: white; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 800px;">
          <form id="settingsForm" onsubmit="handleSaveSettings(event)">
            <div style="margin-bottom: 24px;">
              <label for="nama_lembaga" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Nama Lembaga</label>
              <input type="text" id="nama_lembaga" value="${settings.nama_lembaga || ''}" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
            </div>

            <div style="margin-bottom: 24px;">
              <label for="alamat_lembaga" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Alamat Lembaga</label>
              <textarea id="alamat_lembaga" rows="3" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">${settings.alamat_lembaga || ''}</textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
              <div>
                <label for="telp_lembaga" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Telepon</label>
                <input type="text" id="telp_lembaga" value="${settings.telp_lembaga || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
              </div>

              <div>
                <label for="email_lembaga" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Email</label>
                <input type="email" id="email_lembaga" value="${settings.email_lembaga || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
              </div>
            </div>

            <div style="margin-bottom: 24px;">
              <label for="logo_url" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">URL Logo Lembaga</label>
              <input type="url" id="logo_url" value="${settings.logo_url || ''}" placeholder="https://example.com/logo.png" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
              <p style="font-size: ${baseSize * 0.85}px; color: #64748b; margin: 4px 0 0 0;">Masukkan URL gambar logo lembaga</p>
            </div>

            <div style="border-top: 2px solid #e2e8f0; padding-top: 24px; margin-top: 24px;">
              <h3 style="font-size: ${baseSize * 1.2}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 16px 0;">Data Kepala Sekolah</h3>
              
              <div style="margin-bottom: 16px;">
                <label for="nama_kepsek" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Nama Kepala Sekolah</label>
                <input type="text" id="nama_kepsek" value="${settings.nama_kepsek || ''}" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
              </div>

              <div style="margin-bottom: 24px;">
                <label for="nip_kepsek" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">NIP Kepala Sekolah</label>
                <input type="text" id="nip_kepsek" value="${settings.nip_kepsek || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
              </div>
            </div>

            <button type="submit" class="btn" style="background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px 32px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">
              Simpan Pengaturan
            </button>
          </form>
        </div>
      `;
    }

    function handleSaveSettings(event) {
      event.preventDefault();

      const settingsData = {
        type: 'settings',
        _id: 'settings_main',
        nama_lembaga: document.getElementById('nama_lembaga').value,
        alamat_lembaga: document.getElementById('alamat_lembaga').value,
        telp_lembaga: document.getElementById('telp_lembaga').value,
        email_lembaga: document.getElementById('email_lembaga').value,
        logo_url: document.getElementById('logo_url').value,
        nama_kepsek: document.getElementById('nama_kepsek').value,
        nip_kepsek: document.getElementById('nip_kepsek').value,
        created_at: new Date().toISOString()
      };

      const existing = allData.find(d => d.type === 'settings');
      let result;

      if (existing) {
        Object.assign(existing, settingsData);
        existing._id = existing._id;
        result = updateRecord(existing);
      } else {
        result = createRecord(settingsData);
      }

      if (result.success) {
        showToast('Pengaturan berhasil disimpan', 'success');
      } else {
        showToast('Gagal menyimpan pengaturan', 'error');
      }
    }

    function renderSK(container) {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const tutors = getTutors();
      const settings = getSettings();

      container.innerHTML = `
        <h2 style="font-size: ${baseSize * 2}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 24px 0;">Surat Keputusan Lembaga</h2>
        
        <div style="background: white; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 900px;">
          <form id="skForm" onsubmit="generateSK(event)">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
              <div style="grid-column: 1 / -1;">
                <h3 style="font-size: ${baseSize * 1.2}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 16px 0; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">Informasi SK</h3>
              </div>
              
              <div>
                <label for="sk_nomor_urut" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Nomor Urut</label>
                <input type="text" id="sk_nomor_urut" placeholder="27" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
              </div>
              
              <div>
                <label for="sk_kode_jenis" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Kode Jenis</label>
                <input type="text" id="sk_kode_jenis" placeholder="02" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
              </div>
              
              <div>
                <label for="sk_kode_jabatan" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Kode Jabatan</label>
                <input type="text" id="sk_kode_jabatan" placeholder="III" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
              </div>
              
              <div>
                <label for="sk_bulan_romawi" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Bulan (Romawi)</label>
                <select id="sk_bulan_romawi" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  <option value="I">I (Januari)</option>
                  <option value="II">II (Februari)</option>
                  <option value="III">III (Maret)</option>
                  <option value="IV">IV (April)</option>
                  <option value="V">V (Mei)</option>
                  <option value="VI">VI (Juni)</option>
                  <option value="VII" selected>VII (Juli)</option>
                  <option value="VIII">VIII (Agustus)</option>
                  <option value="IX">IX (September)</option>
                  <option value="X">X (Oktober)</option>
                  <option value="XI">XI (November)</option>
                  <option value="XII">XII (Desember)</option>
                </select>
              </div>
              
              <div>
                <label for="sk_tahun" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Tahun</label>
                <input type="text" id="sk_tahun" value="${new Date().getFullYear()}" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
              </div>
              
              <div style="grid-column: 1 / -1;">
                <label for="sk_tentang" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Tentang</label>
                <input type="text" id="sk_tentang" placeholder="Pengangkatan Guru/Karyawan" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
              </div>
            </div>

            <div style="margin-bottom: 24px;">
              <h3 style="font-size: ${baseSize * 1.2}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 16px 0; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">Pilih Pegawai & Status</h3>
              
              <div style="background: ${config.secondary_color || defaultConfig.secondary_color}; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                ${tutors.length > 0 ? tutors.map(tutor => `
                  <div style="display: grid; grid-template-columns: auto 1fr 200px 200px; gap: 12px; align-items: center; padding: 12px; border-bottom: 1px solid #e2e8f0; margin-bottom: 8px;">
                    <input type="checkbox" name="sk_pegawai" value="${tutor._id}" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-size: ${baseSize}px; font-weight: 600;">${tutor.nama_tutor} - ${tutor.jabatan} ${tutor.kelas ? `(${tutor.kelas})` : ''}</span>
                    <select name="sk_status_${tutor._id}" style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: ${baseSize * 0.9}px;">
                      <option value="Tetap">Tetap</option>
                      <option value="Tidak Tetap">Tidak Tetap</option>
                      <option value="Kontrak">Kontrak</option>
                      <option value="Honorer">Honorer</option>
                    </select>
                    <input type="text" name="sk_tugas_${tutor._id}" placeholder="Ditugaskan sebagai..." style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: ${baseSize * 0.9}px;">
                  </div>
                `).join('') : '<p style="color: #64748b; font-size: ${baseSize}px; margin: 0;">Belum ada data tutor. Silakan tambah tutor terlebih dahulu.</p>'}
              </div>
            </div>

            <div style="margin-bottom: 24px;">
              <h3 style="font-size: ${baseSize * 1.2}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 16px 0; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">Isi SK</h3>
              
              <div style="margin-bottom: 16px;">
                <label for="sk_menimbang" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Menimbang</label>
                <textarea id="sk_menimbang" rows="3" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">Bahwa dalam rangka meningkatkan kualitas pendidikan dan pelayanan di lembaga, diperlukan tenaga pendidik dan kependidikan yang profesional dan berkompeten.</textarea>
              </div>
              
              <div style="margin-bottom: 16px;">
                <label for="sk_memperhatikan" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Memperhatikan</label>
                <textarea id="sk_memperhatikan" rows="3" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">1. Hasil rapat pengurus yayasan
2. Kebutuhan tenaga pendidik dan kependidikan
3. Kualifikasi dan kompetensi yang bersangkutan</textarea>
              </div>
            </div>

            <div style="margin-bottom: 24px;">
              <h3 style="font-size: ${baseSize * 1.2}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 16px 0; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">Penandatangan</h3>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                  <label for="sk_ketua_nama" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Nama Ketua Yayasan</label>
                  <input type="text" id="sk_ketua_nama" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label for="sk_ketua_nip" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">NIP/NIK Ketua</label>
                  <input type="text" id="sk_ketua_nip" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
              </div>
            </div>

            <div style="margin-bottom: 24px;">
              <label for="sk_tembusan" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Tembusan (pisahkan dengan enter)</label>
              <textarea id="sk_tembusan" rows="3" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">Kepala Sekolah
Bendahara Yayasan
Arsip</textarea>
            </div>

            <button type="submit" class="btn" style="background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px 32px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">
              üñ®Ô∏è Generate & Cetak SK
            </button>
          </form>
        </div>
      `;
    }

    function generateSK(event) {
      event.preventDefault();

      const nomorUrut = document.getElementById('sk_nomor_urut').value;
      const kodeJenis = document.getElementById('sk_kode_jenis').value;
      const kodeJabatan = document.getElementById('sk_kode_jabatan').value;
      const bulanRomawi = document.getElementById('sk_bulan_romawi').value;
      const tahun = document.getElementById('sk_tahun').value;
      const tentang = document.getElementById('sk_tentang').value;
      const menimbang = document.getElementById('sk_menimbang').value;
      const memperhatikan = document.getElementById('sk_memperhatikan').value;
      const ketuaNama = document.getElementById('sk_ketua_nama').value;
      const ketuaNip = document.getElementById('sk_ketua_nip').value;
      const tembusan = document.getElementById('sk_tembusan').value;

      const selectedPegawai = Array.from(document.querySelectorAll('input[name="sk_pegawai"]:checked'))
        .map(checkbox => {
          const tutor = allData.find(t => t._id === checkbox.value);
          if (!tutor) return null;
          
          const statusSelect = document.querySelector(`select[name="sk_status_${tutor._id}"]`);
          const tugasInput = document.querySelector(`input[name="sk_tugas_${tutor._id}"]`);
          
          return {
            ...tutor,
            status_kepegawaian: statusSelect ? statusSelect.value : 'Tetap',
            ditugaskan_sebagai: tugasInput ? tugasInput.value : tutor.jabatan
          };
        })
        .filter(Boolean);

      if (selectedPegawai.length === 0) {
        showToast('Silakan pilih minimal 1 pegawai', 'error');
        return;
      }

      const settings = getSettings();
      const nomorSK = `${nomorUrut}/SK-${kodeJenis}.${kodeJabatan}/YAMTASYI/${bulanRomawi}/${tahun}`;
      
      const printArea = document.getElementById('printArea');
      
      printArea.innerHTML = `
        <div style="width: 210mm; height: 297mm; padding: 15mm 20mm; font-family: 'Times New Roman', Times, serif; background: white; position: relative; box-sizing: border-box; overflow: hidden;">
          <!-- Header -->
          <div style="display: flex; align-items: flex-start; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid #000;">
            <div style="flex-shrink: 0; margin-right: 12px;">
              ${settings.logo_url ? `<img src="${settings.logo_url}" alt="Logo" style="height: 50px;" onerror="this.style.display='none';">` : ''}
            </div>
            <div style="flex: 1; text-align: center;">
              <h2 style="margin: 0 0 2px 0; font-size: 14px; font-weight: bold; text-transform: uppercase;">${settings.nama_lembaga || 'YAYASAN MAHAD TARBIYATUNNASYIIN'}</h2>
              <p style="margin: 1px 0; font-size: 9px;">${settings.alamat_lembaga || 'Paculgowang Diwek Jombang'}</p>
              <p style="margin: 1px 0; font-size: 9px;">Telp: ${settings.telp_lembaga || '-'} | Email: ${settings.email_lembaga || '-'}</p>
            </div>
          </div>

          <!-- Judul -->
          <div style="text-align: center; margin: 10px 0 8px 0;">
            <h1 style="margin: 0 0 4px 0; font-size: 15px; font-weight: bold; letter-spacing: 1px;">SURAT KEPUTUSAN</h1>
            <p style="margin: 0; font-size: 10px; font-weight: bold;">KETUA YAYASAN MAHAD TARBIYATUNNASYIIN PACULGOWANG DIWEK JOMBANG</p>
          </div>

          <!-- Nomor SK -->
          <div style="text-align: center; margin: 8px 0;">
            <p style="margin: 0; font-size: 11px; font-weight: bold;">Nomor: ${nomorSK}</p>
          </div>

          <!-- Tentang -->
          <div style="text-align: center; margin: 8px 0;">
            <p style="margin: 0; font-size: 11px; font-weight: bold;">TENTANG</p>
            <p style="margin: 2px 0; font-size: 11px; font-weight: bold; text-transform: uppercase;">${tentang}</p>
          </div>

          <!-- Pembukaan -->
          <div style="text-align: center; margin: 8px 0;">
            <p style="margin: 0; font-size: 10px; font-weight: bold;">KETUA YAYASAN MAHAD TARBIYATUNNASYIIN</p>
          </div>

          <!-- Menimbang -->
          <div style="margin: 8px 0; font-size: 10px; line-height: 1.4;">
            <table style="width: 100%;">
              <tr>
                <td style="width: 100px; vertical-align: top; font-weight: bold;">Menimbang</td>
                <td style="width: 8px; vertical-align: top;">:</td>
                <td style="text-align: justify;">${menimbang}</td>
              </tr>
            </table>
          </div>

          <!-- Memperhatikan -->
          <div style="margin: 8px 0; font-size: 10px; line-height: 1.4;">
            <table style="width: 100%;">
              <tr>
                <td style="width: 100px; vertical-align: top; font-weight: bold;">Memperhatikan</td>
                <td style="width: 8px; vertical-align: top;">:</td>
                <td style="text-align: justify;">${memperhatikan.split('\n').join('<br>')}</td>
              </tr>
            </table>
          </div>

          <!-- Memutuskan -->
          <div style="text-align: center; margin: 10px 0 8px 0;">
            <p style="margin: 0; font-size: 11px; font-weight: bold;">MEMUTUSKAN</p>
          </div>

          <div style="margin: 8px 0; font-size: 10px; line-height: 1.4;">
            <table style="width: 100%;">
              <tr>
                <td style="width: 100px; vertical-align: top; font-weight: bold;">Menetapkan</td>
                <td style="width: 8px; vertical-align: top;">:</td>
                <td></td>
              </tr>
            </table>
          </div>

          <div style="margin: 8px 0 8px 110px; font-size: 10px; line-height: 1.4;">
            <p style="margin: 0 0 6px 0;"><strong>KESATU</strong> : Mengangkat dan menugaskan nama-nama yang tersebut di bawah ini sebagai ${tentang.toLowerCase()}:</p>
          </div>

          <!-- Tabel Pegawai -->
          <table style="width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 9px;">
            <thead>
              <tr style="background: #f0f0f0;">
                <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 25px;">No</th>
                <th style="border: 1px solid #000; padding: 4px; text-align: left;">Nama</th>
                <th style="border: 1px solid #000; padding: 4px; text-align: left;">TTL</th>
                <th style="border: 1px solid #000; padding: 4px; text-align: left;">Alamat</th>
                <th style="border: 1px solid #000; padding: 4px; text-align: left; width: 80px;">Pendidikan</th>
                <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 50px;">Status</th>
                <th style="border: 1px solid #000; padding: 4px; text-align: left;">Ditugaskan Sebagai</th>
              </tr>
            </thead>
            <tbody>
              ${selectedPegawai.map((pegawai, index) => {
                const ttl = pegawai.tempat_lahir && pegawai.tanggal_lahir 
                  ? `${pegawai.tempat_lahir}, ${pegawai.tanggal_lahir}` 
                  : '-';
                const alamat = pegawai.alamat || '-';
                const pendidikan = pegawai.pendidikan_terakhir || '-';
                
                return `
                  <tr>
                    <td style="border: 1px solid #000; padding: 4px; text-align: center;">${index + 1}</td>
                    <td style="border: 1px solid #000; padding: 4px;">${pegawai.nama_tutor}</td>
                    <td style="border: 1px solid #000; padding: 4px;">${ttl}</td>
                    <td style="border: 1px solid #000; padding: 4px;">${alamat}</td>
                    <td style="border: 1px solid #000; padding: 4px;">${pendidikan}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: center;">${pegawai.status_kepegawaian}</td>
                    <td style="border: 1px solid #000; padding: 4px;">${pegawai.ditugaskan_sebagai}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>

          <div style="margin: 8px 0 8px 110px; font-size: 10px; line-height: 1.4;">
            <p style="margin: 0 0 6px 0;"><strong>KEDUA</strong> : Surat Keputusan ini berlaku sejak tanggal ditetapkan dengan ketentuan apabila di kemudian hari terdapat kekeliruan dalam penetapan ini akan diadakan perbaikan sebagaimana mestinya.</p>
          </div>

          <!-- Penutup -->
          <div style="margin-top: 15px; display: flex; justify-content: space-between; font-size: 10px;">
            <div style="width: 45%;"></div>
            <div style="width: 45%; text-align: center;">
              <p style="margin: 0 0 3px 0;">Ditetapkan di : Jombang</p>
              <p style="margin: 0 0 3px 0;">Pada Tanggal : ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
              <p style="margin: 10px 0 3px 0; font-weight: bold;">Ketua Yayasan,</p>
              <div style="height: 40px;"></div>
              <p style="margin: 0 0 2px 0; font-weight: bold; text-decoration: underline;">${ketuaNama}</p>
              ${ketuaNip ? `<p style="margin: 0; font-size: 9px;">NIP/NIK. ${ketuaNip}</p>` : ''}
            </div>
          </div>

          <!-- Tembusan -->
          ${tembusan ? `
            <div style="margin-top: 15px; font-size: 9px;">
              <p style="margin: 0 0 4px 0; font-weight: bold;">Tembusan:</p>
              ${tembusan.split('\n').map((item, idx) => `<p style="margin: 1px 0 1px 15px;">${idx + 1}. ${item}</p>`).join('')}
            </div>
          ` : ''}
        </div>
      `;
      
      printArea.style.display = 'block';
      window.print();
      printArea.style.display = 'none';
    }

    function renderTutors(container) {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const tutors = getTutors();

      container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="font-size: ${baseSize * 2}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0;">Manajemen Tutor</h2>
          <div style="display: flex; gap: 12px;">
            <button onclick="exportTutorsToExcel()" class="btn" style="background: ${config.accent_color || defaultConfig.accent_color}; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">
              üì• Ekspor ke Excel
            </button>
            <button onclick="showAddTutorForm()" class="btn" style="background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">
              + Tambah Tutor
            </button>
          </div>
        </div>

        <div id="tutorsList"></div>
        <div id="tutorFormModal" style="display: none;"></div>
      `;

      renderTutorsList();
    }

    function renderTutorsList() {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const tutors = getTutors();

      const listContainer = document.getElementById('tutorsList');
      
      if (tutors.length === 0) {
        listContainer.innerHTML = `
          <div style="background: white; padding: 48px; border-radius: 12px; text-align: center; color: #64748b; font-size: ${baseSize}px;">
            Belum ada data tutor. Silakan tambah tutor terlebih dahulu.
          </div>
        `;
        return;
      }

      listContainer.innerHTML = `
        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: ${config.secondary_color || defaultConfig.secondary_color};">
                <th style="padding: 16px; text-align: left; font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">Nama Tutor</th>
                <th style="padding: 16px; text-align: left; font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">NIP</th>
                <th style="padding: 16px; text-align: left; font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">Jabatan</th>
                <th style="padding: 16px; text-align: left; font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">Kelas</th>
                <th style="padding: 16px; text-align: left; font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">No. Telepon</th>
                <th style="padding: 16px; text-align: left; font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">Pendidikan</th>
                <th style="padding: 16px; text-align: center; font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">Aksi</th>
              </tr>
            </thead>
            <tbody>
              ${tutors.map(tutor => `
                <tr style="border-top: 1px solid #e2e8f0;">
                  <td style="padding: 16px; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.nama_tutor}</td>
                  <td style="padding: 16px; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.nip || '-'}</td>
                  <td style="padding: 16px; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.jabatan}</td>
                  <td style="padding: 16px; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.kelas || '-'}</td>
                  <td style="padding: 16px; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.no_telp || '-'}</td>
                  <td style="padding: 16px; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.pendidikan_terakhir || '-'}</td>
                  <td style="padding: 16px; text-align: center;">
                    <button onclick="showTutorDetail('${tutor._id}')" style="background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 6px 16px; border: none; border-radius: 6px; font-size: ${baseSize * 0.9}px; cursor: pointer; margin-right: 8px;">Detail</button>
                    <button onclick="deleteTutor('${tutor._id}')" style="background: #ef4444; color: white; padding: 6px 16px; border: none; border-radius: 6px; font-size: ${baseSize * 0.9}px; cursor: pointer;">Hapus</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function showAddTutorForm() {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const modal = document.getElementById('tutorFormModal');
      const classes = getClasses();
      
      modal.style.display = 'block';
      modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 20px;">
          <div style="background: white; padding: 32px; border-radius: 12px; max-width: 700px; width: 90%; margin: auto;">
            <h3 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 24px 0;">Tambah Tutor Baru</h3>
            
            <form id="addTutorForm" onsubmit="handleAddTutor(event)">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div style="grid-column: 1 / -1;">
                  <label for="nama_tutor" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Nama Tutor</label>
                  <input type="text" id="nama_tutor" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label for="nip" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">NIP</label>
                  <input type="text" id="nip" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label for="jabatan" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Jabatan</label>
                  <div style="position: relative;">
                    <input type="text" id="jabatan" required readonly onclick="toggleJabatanDropdown()" placeholder="Pilih jabatan..." style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px; cursor: pointer; background: white;">
                    <div id="jabatanDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #cbd5e1; border-radius: 8px; margin-top: 4px; max-height: 300px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Kepala Sekolah" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Kepala Sekolah</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Komite" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Komite</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Sekretaris" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Sekretaris</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Bendahara" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Bendahara</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Admin" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Admin</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Operator" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Operator</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Waka Kurikulum" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Waka Kurikulum</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Waka Kesiswaan" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Waka Kesiswaan</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Bidang Humas" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Bidang Humas</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Bidang Perlengkapan & Kebersihan" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Bidang Perlengkapan & Kebersihan</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Ketua TBM" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Ketua TBM</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Penyelenggara" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Penyelenggara</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Wali Kelas" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Wali Kelas</span>
                        </label>
                      </div>
                      <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Guru Mata Pelajaran" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Guru Mata Pelajaran</span>
                        </label>
                      </div>
                      <div style="padding: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                          <input type="checkbox" value="Guru BK" onchange="updateJabatanSelection()" style="width: 16px; height: 16px; cursor: pointer;">
                          <span style="font-size: ${baseSize * 0.95}px;">Guru BK</span>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div>
                  <label for="kelas_tutor" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Kelas (Opsional)</label>
                  <select id="kelas_tutor" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                    <option value="">Pilih Kelas...</option>
                    ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                  </select>
                </div>
                
                <div>
                  <label for="pendidikan_terakhir" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Pendidikan Terakhir</label>
                  <input type="text" id="pendidikan_terakhir" placeholder="Contoh: S1 Pendidikan Matematika" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label for="no_telp_tutor" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">No. Telepon</label>
                  <input type="tel" id="no_telp_tutor" placeholder="Contoh: 081234567890" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label for="tempat_lahir_tutor" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Tempat Lahir</label>
                  <input type="text" id="tempat_lahir_tutor" placeholder="Contoh: Jombang" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label for="tanggal_lahir_tutor" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Tanggal Lahir</label>
                  <input type="date" id="tanggal_lahir_tutor" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div style="grid-column: 1 / -1;">
                  <label for="alamat_tutor" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Alamat</label>
                  <textarea id="alamat_tutor" rows="2" placeholder="Alamat lengkap tutor" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;"></textarea>
                </div>
              </div>
              
              <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button type="submit" class="btn" style="flex: 1; background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">Simpan</button>
                <button type="button" onclick="closeTutorForm()" style="flex: 1; background: #64748b; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">Batal</button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    function closeTutorForm() {
      document.getElementById('tutorFormModal').style.display = 'none';
    }

    function handleAddTutor(event) {
      event.preventDefault();

      const tutorData = {
        type: 'tutor',
        nama_tutor: document.getElementById('nama_tutor').value,
        nip: document.getElementById('nip').value,
        jabatan: document.getElementById('jabatan').value,
        kelas: document.getElementById('kelas_tutor').value,
        tempat_lahir: document.getElementById('tempat_lahir_tutor').value,
        tanggal_lahir: document.getElementById('tanggal_lahir_tutor').value,
        alamat: document.getElementById('alamat_tutor').value,
        pendidikan_terakhir: document.getElementById('pendidikan_terakhir').value,
        no_telp: document.getElementById('no_telp_tutor').value,
        created_at: new Date().toISOString()
      };

      const result = createRecord(tutorData);
      
      if (result.success) {
        showToast('Tutor berhasil ditambahkan', 'success');
        closeTutorForm();
        renderTutorsList();
      } else {
        showToast('Gagal menambahkan tutor', 'error');
      }
    }

    function deleteTutor(id) {
      const tutor = allData.find(t => t._id === id);
      if (!tutor) return;

      const result = deleteRecord(tutor);
      
      if (result.success) {
        showToast('Tutor berhasil dihapus', 'success');
        renderTutorsList();
      } else {
        showToast('Gagal menghapus tutor', 'error');
      }
    }

    function renderUpload(container) {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      
      container.innerHTML = `
        <h2 style="font-size: ${baseSize * 2}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 24px 0;">Upload Data Siswa</h2>
        
        <div style="background: white; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 800px;">
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: ${baseSize * 1.3}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 12px 0;">Format File Excel</h3>
            <p style="font-size: ${baseSize}px; color: #64748b; margin: 0 0 16px 0;">File Excel harus memiliki kolom berikut (minimal):</p>
            <div style="background: ${config.secondary_color || defaultConfig.secondary_color}; padding: 16px; border-radius: 8px; font-family: monospace; font-size: ${baseSize * 0.9}px;">
              <div style="margin-bottom: 4px;"><strong>NIS | Nama | Kelas | Jenis Kelamin</strong></div>
              <div style="color: #64748b; margin-top: 8px;">Kolom opsional:</div>
              <div style="color: #64748b;">Tempat Lahir | Tanggal Lahir | Alamat | Nama Ayah | Nama Ibu | No Telp</div>
            </div>
          </div>

          <div style="margin-bottom: 24px;">
            <label style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Pilih File Excel (.xlsx)</label>
            <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: block; width: 100%; padding: 12px; border: 2px dashed ${config.primary_color || defaultConfig.primary_color}; border-radius: 8px; font-size: ${baseSize}px; cursor: pointer; background: white;">
          </div>

          <button id="uploadBtn" class="btn" style="background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px 32px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
            <span>Upload & Proses Data</span>
          </button>

          <div id="uploadResult" style="margin-top: 24px;"></div>
        </div>
      `;

      document.getElementById('uploadBtn').addEventListener('click', handleFileUpload);
    }

    async function handleFileUpload() {
      const fileInput = document.getElementById('excelFile');
      const uploadBtn = document.getElementById('uploadBtn');
      const resultDiv = document.getElementById('uploadResult');
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;

      if (!fileInput.files || !fileInput.files[0]) {
        showToast('Silakan pilih file Excel terlebih dahulu', 'error');
        return;
      }

      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<div class="loading-spinner"></div><span>Memproses...</span>';

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onerror = function() {
        resultDiv.innerHTML = `
          <div style="padding: 16px; background: #ef4444; color: white; border-radius: 8px; font-size: ${baseSize}px;">
            ‚ùå Gagal membaca file. Silakan coba lagi.
          </div>
        `;
        showToast('Gagal membaca file', 'error');
        fileInput.value = '';
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<span>Upload & Proses Data</span>';
      };

      reader.onload = async function(e) {
        try {
          if (typeof XLSX === 'undefined') {
            resultDiv.innerHTML = `
              <div style="padding: 16px; background: #ef4444; color: white; border-radius: 8px; font-size: ${baseSize}px;">
                ‚ùå Library Excel belum dimuat. Silakan refresh halaman dan coba lagi.
              </div>
            `;
            fileInput.value = '';
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<span>Upload & Proses Data</span>';
            return;
          }

          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
            resultDiv.innerHTML = `
              <div style="padding: 16px; background: #ef4444; color: white; border-radius: 8px; font-size: ${baseSize}px;">
                ‚ùå File Excel tidak memiliki sheet. Pastikan file valid.
              </div>
            `;
            fileInput.value = '';
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<span>Upload & Proses Data</span>';
            return;
          }

          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const rawData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '', raw: false });
          
          if (!rawData || rawData.length === 0) {
            resultDiv.innerHTML = `
              <div style="padding: 16px; background: #ef4444; color: white; border-radius: 8px; font-size: ${baseSize}px;">
                ‚ùå File Excel kosong. Silakan upload file yang berisi data.
              </div>
            `;
            fileInput.value = '';
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<span>Upload & Proses Data</span>';
            return;
          }
          
          let headerRowIndex = -1;
          let headerMapping = {};
          let detectedHeaders = [];
          
          for (let i = 0; i < Math.min(15, rawData.length); i++) {
            const row = rawData[i];
            const prevRow = i > 0 ? rawData[i - 1] : [];
            const combinedRow = row.map((cell, idx) => {
              const current = (cell || '').toString().trim();
              const previous = (prevRow[idx] || '').toString().trim();
              return current || previous;
            });
            
            const rowStr = combinedRow.join('|').toLowerCase();
            
            if ((rowStr.includes('nis') || rowStr.includes('nisn')) && 
                (rowStr.includes('nama') || rowStr.includes('kelas'))) {
              headerRowIndex = i;
              detectedHeaders = combinedRow;
              
              combinedRow.forEach((cell, colIndex) => {
                const cellStr = cell.toLowerCase().trim();
                
                if ((cellStr.includes('nis') || cellStr.includes('nisn') || cellStr.includes('induk')) && 
                    !cellStr.includes('nama') && !headerMapping.nis) {
                  headerMapping.nis = colIndex;
                }
                if (cellStr.includes('nama') && !cellStr.includes('orang') && !cellStr.includes('ayah') && 
                    !cellStr.includes('ibu') && !headerMapping.nama) {
                  headerMapping.nama = colIndex;
                }
                if ((cellStr.includes('kelas') || cellStr.includes('tingkat') || cellStr.includes('rombel')) && 
                    !headerMapping.kelas) {
                  headerMapping.kelas = colIndex;
                }
                if ((cellStr.includes('kelamin') || cellStr.includes('gender') || cellStr === 'l/p' || cellStr === 'jk') && 
                    !headerMapping.jenisKelamin) {
                  headerMapping.jenisKelamin = colIndex;
                }
                if (cellStr.includes('tempat') && cellStr.includes('lahir') && !headerMapping.tempatLahir) {
                  headerMapping.tempatLahir = colIndex;
                }
                if ((cellStr.includes('tanggal') || cellStr.includes('tgl')) && cellStr.includes('lahir') && !headerMapping.tanggalLahir) {
                  headerMapping.tanggalLahir = colIndex;
                }
                if (cellStr.includes('alamat') && !cellStr.includes('email') && !headerMapping.alamat) {
                  headerMapping.alamat = colIndex;
                }
                if (cellStr.includes('ayah') && !headerMapping.namaAyah) {
                  headerMapping.namaAyah = colIndex;
                }
                if (cellStr.includes('ibu') && !headerMapping.namaIbu) {
                  headerMapping.namaIbu = colIndex;
                }
                if ((cellStr.includes('telp') || cellStr.includes('hp') || cellStr.includes('telepon') || cellStr.includes('phone')) && !headerMapping.noTelp) {
                  headerMapping.noTelp = colIndex;
                }
              });
              break;
            }
          }
          
          if (headerRowIndex >= 0) {
            resultDiv.innerHTML = `
              <div style="padding: 16px; background: #dbeafe; color: #1e40af; border-radius: 8px; font-size: ${baseSize * 0.9}px; margin-bottom: 16px;">
                <strong>üìã Header ditemukan di baris ${headerRowIndex + 1}</strong><br>
                Kolom terdeteksi: ${Object.keys(headerMapping).length} kolom<br>
                Data akan dibaca mulai baris ${headerRowIndex + 2}
              </div>
            `;
          } else {
            resultDiv.innerHTML = `
              <div style="padding: 16px; background: #fef3c7; color: #92400e; border-radius: 8px; font-size: ${baseSize * 0.9}px; margin-bottom: 16px;">
                <strong>‚ö†Ô∏è Header tidak ditemukan!</strong><br>
                Pastikan file Excel memiliki kolom: <strong>NIS, Nama, Kelas</strong>
              </div>
            `;
            fileInput.value = '';
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<span>Upload & Proses Data</span>';
            return;
          }
          
          const jsonData = rawData.slice(headerRowIndex + 1).filter(row => {
            return row.some(cell => cell && cell.toString().trim() !== '');
          });

          let successCount = 0;
          let errorCount = 0;
          let skippedCount = 0;

          for (let i = 0; i < jsonData.length; i++) {
            const row = jsonData[i];
            const nis = (row[headerMapping.nis] || '').toString().trim();
            const nama = (row[headerMapping.nama] || '').toString().trim();
            const kelas = (row[headerMapping.kelas] || '').toString().trim();
            const jenisKelamin = headerMapping.jenisKelamin !== undefined 
              ? (row[headerMapping.jenisKelamin] || '').toString().trim() 
              : '';
            const tempatLahir = headerMapping.tempatLahir !== undefined 
              ? (row[headerMapping.tempatLahir] || '').toString().trim() 
              : '';
            const tanggalLahir = headerMapping.tanggalLahir !== undefined 
              ? (row[headerMapping.tanggalLahir] || '').toString().trim() 
              : '';
            const alamat = headerMapping.alamat !== undefined 
              ? (row[headerMapping.alamat] || '').toString().trim() 
              : '';
            const namaAyah = headerMapping.namaAyah !== undefined 
              ? (row[headerMapping.namaAyah] || '').toString().trim() 
              : '';
            const namaIbu = headerMapping.namaIbu !== undefined 
              ? (row[headerMapping.namaIbu] || '').toString().trim() 
              : '';
            const noTelp = headerMapping.noTelp !== undefined 
              ? (row[headerMapping.noTelp] || '').toString().trim() 
              : '';

            if (!nis || !nama || !kelas) {
              skippedCount++;
              continue;
            }

            const existingStudent = allData.find(s => s.type === 'student' && s.nis === nis);
            if (existingStudent) {
              skippedCount++;
              continue;
            }

            const studentData = {
              type: 'student',
              nis: nis,
              nama: nama,
              kelas: kelas,
              jenis_kelamin: jenisKelamin,
              tempat_lahir: tempatLahir,
              tanggal_lahir: tanggalLahir,
              alamat: alamat,
              nama_ayah: namaAyah,
              nama_ibu: namaIbu,
              no_telp: noTelp,
              foto_url: '',
              created_at: new Date().toISOString()
            };

            const result = createRecord(studentData);
            if (result.success) {
              successCount++;
            } else {
              errorCount++;
            }
          }

          resultDiv.innerHTML += `
            <div style="padding: 16px; background: ${successCount > 0 ? (config.accent_color || defaultConfig.accent_color) : '#ef4444'}; color: white; border-radius: 8px; font-size: ${baseSize}px; margin-top: 16px;">
              ${successCount > 0 ? `‚úÖ Berhasil mengupload ${successCount} siswa baru dari ${jsonData.length} baris data` : '‚ùå Tidak ada data yang berhasil diupload'}
              ${skippedCount > 0 ? `<br>‚ÑπÔ∏è ${skippedCount} data dilewati (duplikat atau tidak lengkap)` : ''}
              ${errorCount > 0 ? `<br>‚ö†Ô∏è ${errorCount} data gagal diproses` : ''}
            </div>
          `;

          if (successCount > 0) {
            showToast(`Berhasil mengupload ${successCount} siswa`, 'success');
            renderCurrentView();
          } else {
            showToast('Tidak ada data yang berhasil diupload', 'error');
          }
          
          fileInput.value = '';
        } catch (error) {
          console.error('Upload error:', error);
          resultDiv.innerHTML = `
            <div style="padding: 16px; background: #ef4444; color: white; border-radius: 8px; font-size: ${baseSize}px;">
              ‚ùå Gagal memproses file: ${error.message || 'Error tidak diketahui'}
            </div>
          `;
          showToast('Gagal memproses file Excel', 'error');
          fileInput.value = '';
        } finally {
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = '<span>Upload & Proses Data</span>';
        }
      };

      reader.readAsArrayBuffer(file);
    }

    function renderStudents(container) {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const students = getStudents();
      const classes = getClasses();

      container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="font-size: ${baseSize * 2}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0;">Data Siswa (${students.length})</h2>
          <div style="display: flex; gap: 12px;">
            <button onclick="showUploadPhotoForm()" class="btn" style="background: ${config.accent_color || defaultConfig.accent_color}; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">
              üì∑ Upload Foto Siswa
            </button>
            <button onclick="showAddStudentForm()" class="btn" style="background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">
              + Tambah Siswa
            </button>
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color}; margin-right: 12px;">Filter Kelas:</label>
          <select id="classFilter" onchange="filterStudentsByClass(this.value)" style="padding: 8px 16px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
            <option value="">Semua Kelas (${students.length})</option>
            ${classes.map(c => {
              const count = students.filter(s => s.kelas === c).length;
              return `<option value="${c}">${c} (${count})</option>`;
            }).join('')}
          </select>
        </div>

        <div id="studentsList"></div>
        <div id="studentFormModal" style="display: none;"></div>
        <div id="studentDetailModal" style="display: none;"></div>
        <div id="uploadPhotoModal" style="display: none;"></div>
      `;

      renderStudentsList();
    }

    function filterStudentsByClass(kelas) {
      selectedClass = kelas;
      renderStudentsList();
    }

    function renderStudentsList() {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const students = getStudents();
      const filteredStudents = selectedClass ? students.filter(s => s.kelas === selectedClass) : students;

      const listContainer = document.getElementById('studentsList');
      
      if (filteredStudents.length === 0) {
        listContainer.innerHTML = `
          <div style="background: white; padding: 48px; border-radius: 12px; text-align: center; color: #64748b; font-size: ${baseSize}px;">
            Belum ada data siswa. Silakan upload data atau tambah siswa manual.
          </div>
        `;
        return;
      }

      listContainer.innerHTML = `
        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: ${config.secondary_color || defaultConfig.secondary_color};">
                <th style="padding: 16px; text-align: left; font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">NIS</th>
                <th style="padding: 16px; text-align: left; font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">Nama</th>
                <th style="padding: 16px; text-align: left; font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">Kelas</th>
                <th style="padding: 16px; text-align: left; font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">Jenis Kelamin</th>
                <th style="padding: 16px; text-align: center; font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">Aksi</th>
              </tr>
            </thead>
            <tbody>
              ${filteredStudents.map(student => `
                <tr style="border-top: 1px solid #e2e8f0;">
                  <td style="padding: 16px; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${student.nis}</td>
                  <td style="padding: 16px; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${student.nama}</td>
                  <td style="padding: 16px; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${student.kelas}</td>
                  <td style="padding: 16px; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${student.jenis_kelamin}</td>
                  <td style="padding: 16px; text-align: center;">
                    <button onclick="showStudentDetail('${student._id}')" style="background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 6px 16px; border: none; border-radius: 6px; font-size: ${baseSize * 0.9}px; cursor: pointer; margin-right: 8px;">Detail</button>
                    <button onclick="deleteStudent('${student._id}')" style="background: #ef4444; color: white; padding: 6px 16px; border: none; border-radius: 6px; font-size: ${baseSize * 0.9}px; cursor: pointer;">Hapus</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function convertGoogleDriveUrl(url) {
      if (!url) return '';
      
      // Jika sudah format direct link, return as is
      if (url.includes('drive.google.com/uc?')) {
        return url;
      }
      
      // Extract file ID dari berbagai format Google Drive URL
      let fileId = '';
      
      // Format: https://drive.google.com/file/d/FILE_ID/view
      const match1 = url.match(/\/file\/d\/([^\/]+)/);
      if (match1) {
        fileId = match1[1];
      }
      
      // Format: https://drive.google.com/open?id=FILE_ID
      const match2 = url.match(/[?&]id=([^&]+)/);
      if (match2) {
        fileId = match2[1];
      }
      
      // Jika berhasil extract file ID, convert ke direct link
      if (fileId) {
        return `https://drive.google.com/uc?export=view&id=${fileId}`;
      }
      
      // Jika bukan Google Drive atau format tidak dikenali, return original
      return url;
    }

    function showStudentDetail(id) {
      const student = allData.find(s => s._id === id);
      if (!student) return;

      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const modal = document.getElementById('studentDetailModal');
      const photoUrl = convertGoogleDriveUrl(student.foto_url);
      
      modal.style.display = 'block';
      modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 20px;">
          <div style="background: white; padding: 32px; border-radius: 12px; max-width: 800px; width: 90%; margin: auto;">
            <h3 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 24px 0;">Data Lengkap Siswa</h3>
            
            <div style="display: grid; grid-template-columns: 150px 1fr; gap: 24px; margin-bottom: 24px;">
              <div>
                ${photoUrl ? 
                  `<img src="${photoUrl}" alt="Foto ${student.nama}" class="foto-preview" onerror="this.src=''; this.alt='Foto tidak tersedia'; this.style.display='none';">` :
                  `<div style="width: 120px; height: 160px; background: ${config.secondary_color || defaultConfig.secondary_color}; border: 2px solid #cbd5e1; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #64748b; font-size: ${baseSize * 0.8}px; text-align: center;">Tidak ada foto</div>`
                }
              </div>
              
              <div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div>
                    <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">NIS</label>
                    <div style="font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">${student.nis}</div>
                  </div>
                  
                  <div>
                    <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Nama Lengkap</label>
                    <div style="font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">${student.nama}</div>
                  </div>
                  
                  <div>
                    <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Kelas</label>
                    <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${student.kelas}</div>
                  </div>
                  
                  <div>
                    <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Jenis Kelamin</label>
                    <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${student.jenis_kelamin || '-'}</div>
                  </div>
                </div>
              </div>
            </div>
            
            <div style="border-top: 1px solid #e2e8f0; padding-top: 24px; margin-top: 24px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                  <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Tempat Lahir</label>
                  <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${student.tempat_lahir || '-'}</div>
                </div>
                
                <div>
                  <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Tanggal Lahir</label>
                  <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${student.tanggal_lahir || '-'}</div>
                </div>
                
                <div style="grid-column: 1 / -1;">
                  <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Alamat</label>
                  <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${student.alamat || '-'}</div>
                </div>
                
                <div>
                  <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Nama Ayah</label>
                  <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${student.nama_ayah || '-'}</div>
                </div>
                
                <div>
                  <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Nama Ibu</label>
                  <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${student.nama_ibu || '-'}</div>
                </div>
                
                <div>
                  <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">No. Telepon</label>
                  <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${student.no_telp || '-'}</div>
                </div>
              </div>
            </div>
            
            <div style="margin-top: 24px; display: flex; gap: 12px;">
              <button onclick="editStudent('${student._id}')" style="flex: 1; background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">Edit Data</button>
              <button onclick="printStudentCard('${student._id}')" style="flex: 1; background: ${config.accent_color || defaultConfig.accent_color}; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">Cetak Kartu</button>
              <button onclick="closeStudentDetail()" style="flex: 1; background: #64748b; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">Tutup</button>
            </div>
          </div>
        </div>
      `;
    }

    function closeStudentDetail() {
      document.getElementById('studentDetailModal').style.display = 'none';
    }

    function editStudent(id) {
      const student = allData.find(s => s._id === id);
      if (!student) return;

      closeStudentDetail();
      showAddStudentForm(student);
    }

    function printStudentCard(id) {
      const student = allData.find(s => s._id === id);
      if (!student) return;

      const settings = getSettings();
      const printArea = document.getElementById('printArea');
      const photoUrl = convertGoogleDriveUrl(student.foto_url);
      
      printArea.innerHTML = `
        <div style="width: 210mm; height: 297mm; padding: 15mm 20mm; font-family: 'Times New Roman', Times, serif; position: relative; background: white; box-sizing: border-box; overflow: hidden;">
          <div style="position: absolute; top: 15mm; right: 20mm;">
            ${settings.logo_url ? `<img src="${settings.logo_url}" alt="Logo" style="height: 40px;" onerror="this.style.display='none';">` : ''}
          </div>
          
          <h1 style="text-align: center; font-size: 16px; font-weight: bold; margin: 0 0 15px 0; letter-spacing: 1px;">IDENTITAS PESERTA DIDIK</h1>
          
          <div style="border: 1px solid #000; padding: 12px; margin-bottom: 10px;">
            <h3 style="font-size: 11px; font-weight: bold; margin: 0 0 8px 0; border-bottom: 1px solid #000; padding-bottom: 4px;">A. DATA PRIBADI SISWA</h3>
            
            <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
              <tr>
                <td style="width: 180px; padding: 3px 0; vertical-align: top;">Nama Peserta Didik</td>
                <td style="width: 8px; vertical-align: top;">:</td>
                <td style="padding: 3px 0; font-weight: bold;">${student.nama}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">NISN / NIS</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.nis}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Tempat, Tanggal Lahir</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.tempat_lahir || '-'}, ${student.tanggal_lahir || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Jenis Kelamin</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.jenis_kelamin || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Agama</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.agama || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Pendidikan Sebelumnya</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.pendidikan_sebelumnya || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Alamat Peserta Didik</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.alamat || '-'}</td>
              </tr>
            </table>
          </div>
          
          <div style="border: 1px solid #000; padding: 12px; margin-bottom: 10px;">
            <h3 style="font-size: 11px; font-weight: bold; margin: 0 0 8px 0; border-bottom: 1px solid #000; padding-bottom: 4px;">B. DATA ORANG TUA</h3>
            
            <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
              <tr>
                <td style="width: 180px; padding: 3px 0; vertical-align: top;">Nama Ayah</td>
                <td style="width: 8px; vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.nama_ayah || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Pekerjaan Ayah</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.pekerjaan_ayah || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Nama Ibu</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.nama_ibu || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Pekerjaan Ibu</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.pekerjaan_ibu || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Alamat Orang Tua</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.alamat_ortu || student.alamat || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Desa / Kelurahan</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.desa || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Kecamatan</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.kecamatan || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Kabupaten / Kota</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.kabupaten || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Provinsi</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.provinsi || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">No. Telepon / HP</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.no_telp || '-'}</td>
              </tr>
            </table>
          </div>
          
          <div style="border: 1px solid #000; padding: 12px; margin-bottom: 15px;">
            <h3 style="font-size: 11px; font-weight: bold; margin: 0 0 8px 0; border-bottom: 1px solid #000; padding-bottom: 4px;">C. DATA WALI (Jika Ada)</h3>
            
            <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
              <tr>
                <td style="width: 180px; padding: 3px 0; vertical-align: top;">Nama Wali</td>
                <td style="width: 8px; vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.nama_wali || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Pekerjaan Wali</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.pekerjaan_wali || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Alamat Wali</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.alamat_wali || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 3px 0; vertical-align: top;">Pendidikan Wali</td>
                <td style="vertical-align: top;">:</td>
                <td style="padding: 3px 0;">${student.pendidikan_wali || '-'}</td>
              </tr>
            </table>
          </div>
          
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 20px;">
            <div style="width: 100px;">
              ${photoUrl ? 
                `<img src="${photoUrl}" alt="Foto ${student.nama}" style="width: 100px; height: 130px; object-fit: cover; border: 2px solid #000;" onerror="this.src=''; this.alt='Foto tidak tersedia'; this.style.display='none';">` :
                `<div style="width: 100px; height: 130px; border: 2px solid #000; display: flex; align-items: center; justify-content: center; font-size: 9px; text-align: center; color: #666;">Pas Foto<br>3 x 4</div>`
              }
            </div>
            
            <div style="text-align: center; font-size: 10px; min-width: 180px;">
              <p style="margin: 0 0 3px 0;">${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
              <p style="margin: 0 0 3px 0;">Kepala Sekolah,</p>
              <div style="height: 45px;"></div>
              <p style="margin: 0 0 2px 0; font-weight: bold; text-decoration: underline;">${settings.nama_kepsek || '___________________'}</p>
              <p style="margin: 0; font-size: 9px;">NIP. ${settings.nip_kepsek || '___________________'}</p>
            </div>
          </div>
        </div>
      `;
      
      printArea.style.display = 'block';
      window.print();
      printArea.style.display = 'none';
    }

    function showAddStudentForm(existingStudent = null) {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const modal = document.getElementById('studentFormModal');
      const classes = getClasses();
      
      modal.style.display = 'block';
      modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 20px;">
          <div style="background: white; padding: 32px; border-radius: 12px; max-width: 700px; width: 90%; margin: auto;">
            <h3 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 24px 0;">${existingStudent ? 'Edit' : 'Tambah'} Siswa</h3>
            
            <form id="addStudentForm" onsubmit="handleAddStudent(event, ${existingStudent ? `'${existingStudent._id}'` : 'null'})">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                  <label for="nis" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">NIS *</label>
                  <input type="text" id="nis" value="${existingStudent?.nis || ''}" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label for="nama" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Nama Lengkap *</label>
                  <input type="text" id="nama" value="${existingStudent?.nama || ''}" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label for="kelas" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Kelas *</label>
                  ${classes.length > 0 ? 
                    `<select id="kelas" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                      <option value="">Pilih Kelas...</option>
                      ${classes.map(c => `<option value="${c}" ${existingStudent?.kelas === c ? 'selected' : ''}>${c}</option>`).join('')}
                      <option value="__custom__">+ Kelas Baru</option>
                    </select>` :
                    `<input type="text" id="kelas" value="${existingStudent?.kelas || ''}" required placeholder="Contoh: 10 IPA 1" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">`
                  }
                </div>
                
                <div>
                  <label for="jenis_kelamin" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Jenis Kelamin</label>
                  <select id="jenis_kelamin" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                    <option value="">Pilih...</option>
                    <option value="Laki-laki" ${existingStudent?.jenis_kelamin === 'Laki-laki' ? 'selected' : ''}>Laki-laki</option>
                    <option value="Perempuan" ${existingStudent?.jenis_kelamin === 'Perempuan' ? 'selected' : ''}>Perempuan</option>
                  </select>
                </div>
                
                <div>
                  <label for="tempat_lahir" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Tempat Lahir</label>
                  <input type="text" id="tempat_lahir" value="${existingStudent?.tempat_lahir || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label for="tanggal_lahir" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Tanggal Lahir</label>
                  <input type="date" id="tanggal_lahir" value="${existingStudent?.tanggal_lahir || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div style="grid-column: 1 / -1;">
                  <label for="alamat" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Alamat</label>
                  <textarea id="alamat" rows="2" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">${existingStudent?.alamat || ''}</textarea>
                </div>
                
                <div>
                  <label for="nama_ayah" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Nama Ayah</label>
                  <input type="text" id="nama_ayah" value="${existingStudent?.nama_ayah || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label for="nama_ibu" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Nama Ibu</label>
                  <input type="text" id="nama_ibu" value="${existingStudent?.nama_ibu || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label for="no_telp" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">No. Telepon</label>
                  <input type="tel" id="no_telp" value="${existingStudent?.no_telp || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label for="foto_url" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">URL Foto</label>
                  <input type="url" id="foto_url" value="${existingStudent?.foto_url || ''}" placeholder="https://..." style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  <p style="font-size: ${baseSize * 0.85}px; color: #64748b; margin: 4px 0 0 0;">üí° Tip: Gunakan nama file sesuai NISN (contoh: ${existingStudent?.nis || 'NISN'}.jpg)</p>
                </div>
              </div>
              
              <div style="border-top: 2px solid #e2e8f0; padding-top: 20px; margin-top: 20px;">
                <h4 style="font-size: ${baseSize * 1.1}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 16px 0;">Data Tambahan (Opsional)</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div>
                    <label for="agama" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Agama</label>
                    <select id="agama" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                      <option value="">Pilih...</option>
                      <option value="Islam" ${existingStudent?.agama === 'Islam' ? 'selected' : ''}>Islam</option>
                      <option value="Kristen" ${existingStudent?.agama === 'Kristen' ? 'selected' : ''}>Kristen</option>
                      <option value="Katolik" ${existingStudent?.agama === 'Katolik' ? 'selected' : ''}>Katolik</option>
                      <option value="Hindu" ${existingStudent?.agama === 'Hindu' ? 'selected' : ''}>Hindu</option>
                      <option value="Buddha" ${existingStudent?.agama === 'Buddha' ? 'selected' : ''}>Buddha</option>
                      <option value="Konghucu" ${existingStudent?.agama === 'Konghucu' ? 'selected' : ''}>Konghucu</option>
                    </select>
                  </div>
                  
                  <div>
                    <label for="pendidikan_sebelumnya" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Pendidikan Sebelumnya</label>
                    <input type="text" id="pendidikan_sebelumnya" value="${existingStudent?.pendidikan_sebelumnya || ''}" placeholder="Contoh: SMP Negeri 1" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  </div>
                  
                  <div>
                    <label for="pekerjaan_ayah" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Pekerjaan Ayah</label>
                    <input type="text" id="pekerjaan_ayah" value="${existingStudent?.pekerjaan_ayah || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  </div>
                  
                  <div>
                    <label for="pekerjaan_ibu" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Pekerjaan Ibu</label>
                    <input type="text" id="pekerjaan_ibu" value="${existingStudent?.pekerjaan_ibu || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  </div>
                  
                  <div>
                    <label for="desa" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Desa / Kelurahan</label>
                    <input type="text" id="desa" value="${existingStudent?.desa || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  </div>
                  
                  <div>
                    <label for="kecamatan" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Kecamatan</label>
                    <input type="text" id="kecamatan" value="${existingStudent?.kecamatan || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  </div>
                  
                  <div>
                    <label for="kabupaten" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Kabupaten / Kota</label>
                    <input type="text" id="kabupaten" value="${existingStudent?.kabupaten || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  </div>
                  
                  <div>
                    <label for="provinsi" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Provinsi</label>
                    <input type="text" id="provinsi" value="${existingStudent?.provinsi || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  </div>
                  
                  <div>
                    <label for="nama_wali" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Nama Wali</label>
                    <input type="text" id="nama_wali" value="${existingStudent?.nama_wali || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  </div>
                  
                  <div>
                    <label for="pekerjaan_wali" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Pekerjaan Wali</label>
                    <input type="text" id="pekerjaan_wali" value="${existingStudent?.pekerjaan_wali || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  </div>
                  
                  <div>
                    <label for="alamat_wali" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Alamat Wali</label>
                    <input type="text" id="alamat_wali" value="${existingStudent?.alamat_wali || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  </div>
                  
                  <div>
                    <label for="pendidikan_wali" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Pendidikan Wali</label>
                    <input type="text" id="pendidikan_wali" value="${existingStudent?.pendidikan_wali || ''}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  </div>
                </div>
              </div>
              
              <div style="margin-top: 24px; display: flex; gap: 12px;">
                <button type="submit" class="btn" style="flex: 1; background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">Simpan</button>
                <button type="button" onclick="closeStudentForm()" style="flex: 1; background: #64748b; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">Batal</button>
              </div>
            </form>
          </div>
        </div>
      `;

      if (classes.length > 0) {
        document.getElementById('kelas').addEventListener('change', function(e) {
          if (e.target.value === '__custom__') {
            const customKelas = window.prompt('Masukkan nama kelas baru:');
            if (customKelas) {
              e.target.innerHTML = `<option value="${customKelas}" selected>${customKelas}</option>` + e.target.innerHTML;
            } else {
              e.target.value = '';
            }
          }
        });
      }
    }

    function closeStudentForm() {
      document.getElementById('studentFormModal').style.display = 'none';
    }

    function handleAddStudent(event, id = null) {
      event.preventDefault();

      const studentData = {
        type: 'student',
        nis: document.getElementById('nis').value,
        nama: document.getElementById('nama').value,
        kelas: document.getElementById('kelas').value,
        jenis_kelamin: document.getElementById('jenis_kelamin').value,
        tempat_lahir: document.getElementById('tempat_lahir').value,
        tanggal_lahir: document.getElementById('tanggal_lahir').value,
        alamat: document.getElementById('alamat').value,
        nama_ayah: document.getElementById('nama_ayah').value,
        nama_ibu: document.getElementById('nama_ibu').value,
        no_telp: document.getElementById('no_telp').value,
        foto_url: document.getElementById('foto_url').value,
        agama: document.getElementById('agama').value,
        pendidikan_sebelumnya: document.getElementById('pendidikan_sebelumnya').value,
        pekerjaan_ayah: document.getElementById('pekerjaan_ayah').value,
        pekerjaan_ibu: document.getElementById('pekerjaan_ibu').value,
        desa: document.getElementById('desa').value,
        kecamatan: document.getElementById('kecamatan').value,
        kabupaten: document.getElementById('kabupaten').value,
        provinsi: document.getElementById('provinsi').value,
        nama_wali: document.getElementById('nama_wali').value,
        pekerjaan_wali: document.getElementById('pekerjaan_wali').value,
        alamat_wali: document.getElementById('alamat_wali').value,
        pendidikan_wali: document.getElementById('pendidikan_wali').value,
        created_at: new Date().toISOString()
      };

      let result;
      if (id) {
        const existing = allData.find(s => s._id === id);
        if (existing) {
          Object.assign(existing, studentData);
          existing._id = existing._id;
          result = updateRecord(existing);
        }
      } else {
        result = createRecord(studentData);
      }
      
      if (result && result.success) {
        showToast(`Siswa berhasil ${id ? 'diupdate' : 'ditambahkan'}`, 'success');
        closeStudentForm();
        renderStudentsList();
      } else {
        showToast(`Gagal ${id ? 'mengupdate' : 'menambahkan'} siswa`, 'error');
      }
    }

    function deleteStudent(id) {
      const student = allData.find(s => s._id === id);
      if (!student) return;

      const result = deleteRecord(student);
      
      if (result.success) {
        showToast('Siswa berhasil dihapus', 'success');
        renderStudentsList();
      } else {
        showToast('Gagal menghapus siswa', 'error');
      }
    }

    function renderKTA(container) {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const students = getStudents();
      const classes = getClasses();

      container.innerHTML = `
        <h2 style="font-size: ${baseSize * 2}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 24px 0;">Cetak Kartu Tanda Anggota (KTA)</h2>
        
        <div style="background: white; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 900px;">
          <p style="font-size: ${baseSize}px; color: #64748b; margin: 0 0 24px 0;">Cetak Kartu Tanda Anggota untuk siswa. Pilih siswa atau cetak per kelas.</p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
            <div>
              <label for="ktaClass" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Filter Kelas</label>
              <select id="ktaClass" onchange="filterKTAByClass(this.value)" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                <option value="">Semua Kelas</option>
                ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
              </select>
            </div>
            
            <div>
              <label for="ktaStudent" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Pilih Siswa (Opsional)</label>
              <select id="ktaStudent" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                <option value="">Semua Siswa di Kelas</option>
                ${students.map(s => `<option value="${s._id}">${s.nama} (${s.kelas})</option>`).join('')}
              </select>
            </div>
          </div>

          <div style="display: flex; gap: 12px;">
            <button onclick="generateKTA()" class="btn" style="flex: 1; background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px 32px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">
              üñ®Ô∏è Cetak KTA
            </button>
            <button onclick="previewKTA()" class="btn" style="flex: 1; background: ${config.accent_color || defaultConfig.accent_color}; color: white; padding: 12px 32px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">
              üëÅÔ∏è Preview KTA
            </button>
          </div>

          <div id="ktaPreview" style="margin-top: 24px; display: none;"></div>
        </div>
      `;
    }

    function filterKTAByClass(kelas) {
      const studentSelect = document.getElementById('ktaStudent');
      const students = kelas ? getStudents().filter(s => s.kelas === kelas) : getStudents();
      
      studentSelect.innerHTML = `
        <option value="">Semua Siswa ${kelas ? 'di Kelas ' + kelas : ''}</option>
        ${students.map(s => `<option value="${s._id}">${s.nama} (${s.kelas})</option>`).join('')}
      `;
    }

    function previewKTA() {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const studentId = document.getElementById('ktaStudent').value;
      const ktaClass = document.getElementById('ktaClass').value;
      const previewDiv = document.getElementById('ktaPreview');
      
      let students = [];
      if (studentId) {
        const student = allData.find(s => s._id === studentId);
        if (student) students = [student];
      } else if (ktaClass) {
        students = getStudents().filter(s => s.kelas === ktaClass);
      } else {
        students = getStudents();
      }

      if (students.length === 0) {
        showToast('Tidak ada siswa yang dipilih', 'error');
        return;
      }

      const settings = getSettings();
      
      previewDiv.style.display = 'block';
      previewDiv.innerHTML = `
        <h3 style="font-size: ${baseSize * 1.2}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 16px 0;">Preview KTA (${students.length} siswa)</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
          ${students.slice(0, 6).map(student => generateKTACard(student, settings, config, baseSize, false)).join('')}
        </div>
        ${students.length > 6 ? `<p style="font-size: ${baseSize * 0.9}px; color: #64748b; margin-top: 16px; text-align: center;">Menampilkan 6 dari ${students.length} KTA. Klik "Cetak KTA" untuk mencetak semua.</p>` : ''}
      `;
    }

    function generateKTA() {
      const studentId = document.getElementById('ktaStudent').value;
      const ktaClass = document.getElementById('ktaClass').value;
      
      let students = [];
      if (studentId) {
        const student = allData.find(s => s._id === studentId);
        if (student) students = [student];
      } else if (ktaClass) {
        students = getStudents().filter(s => s.kelas === ktaClass);
      } else {
        students = getStudents();
      }

      if (students.length === 0) {
        showToast('Tidak ada siswa yang dipilih', 'error');
        return;
      }

      const settings = getSettings();
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const printArea = document.getElementById('printArea');
      
      printArea.innerHTML = `
        <div style="width: 210mm; padding: 10mm; font-family: Arial, sans-serif;">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8mm; row-gap: 10mm;">
            ${students.map(student => generateKTACard(student, settings, config, baseSize, true)).join('')}
          </div>
        </div>
      `;
      
      printArea.style.display = 'block';
      window.print();
      printArea.style.display = 'none';
    }

    function generateKTACard(student, settings, config, baseSize, forPrint) {
      const cardWidth = forPrint ? '85mm' : '100%';
      const cardHeight = forPrint ? '54mm' : 'auto';
      const fontSize = forPrint ? '8.5px' : `${baseSize * 0.85}px`;
      const titleSize = forPrint ? '12px' : `${baseSize * 1.1}px`;
      const photoSize = forPrint ? '70px' : '80px';
      const photoUrl = convertGoogleDriveUrl(student.foto_url);
      
      return `
        <div style="width: ${cardWidth}; height: ${cardHeight}; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%); border-radius: 16px; padding: 0; box-shadow: 0 8px 24px rgba(0,0,0,0.25); position: relative; overflow: hidden; ${forPrint ? 'page-break-inside: avoid;' : ''}">
          <!-- Decorative Background -->
          <div style="position: absolute; top: -20px; right: -20px; width: 120px; height: 120px; background: rgba(255,255,255,0.08); border-radius: 50%;"></div>
          <div style="position: absolute; bottom: -30px; left: -30px; width: 140px; height: 140px; background: rgba(255,255,255,0.06); border-radius: 50%;"></div>
          <div style="position: absolute; top: 50%; right: 10px; width: 60px; height: 60px; background: rgba(255,255,255,0.05); border-radius: 50%; transform: translateY(-50%);"></div>
          
          <!-- Decorative Lines -->
          <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #fbbf24, #f59e0b, #fbbf24);"></div>
          <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #fbbf24, #f59e0b, #fbbf24);"></div>
          
          <!-- Header with Logo and Title -->
          <div style="background: rgba(255,255,255,0.98); padding: ${forPrint ? '8px 12px' : '10px 14px'}; display: flex; align-items: center; gap: ${forPrint ? '10px' : '12px'}; border-bottom: 3px solid #fbbf24; position: relative; z-index: 1;">
            ${settings.logo_url ? `<img src="${settings.logo_url}" alt="Logo" style="height: ${forPrint ? '45px' : '50px'}; width: auto; object-fit: contain; flex-shrink: 0;" onerror="this.style.display='none';">` : ''}
            <div style="flex: 1; text-align: center;">
              <p style="margin: 0 0 2px 0; font-size: ${forPrint ? '7px' : `${baseSize * 0.7}px`}; color: #64748b; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase;">Dinas Pendidikan Dan Kebudayaan</p>
              <h3 style="margin: 0; font-size: ${titleSize}; font-weight: 800; color: #1e3a8a; line-height: 1.2; letter-spacing: 0.3px; text-transform: uppercase;">${settings.nama_lembaga || 'NAMA LEMBAGA'}</h3>
              <p style="margin: 2px 0 0 0; font-size: ${forPrint ? '7.5px' : `${baseSize * 0.75}px`}; color: #64748b; font-weight: 600; letter-spacing: 1px;">KARTU TANDA ANGGOTA</p>
            </div>
          </div>
          
          <!-- Content -->
          <div style="background: linear-gradient(135deg, rgba(71,85,105,0.15) 0%, rgba(100,116,139,0.2) 50%, rgba(71,85,105,0.25) 100%); padding: ${forPrint ? '10px 12px' : '12px 14px'}; position: relative; z-index: 1; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
            <!-- Watermark Logo -->
            ${settings.logo_url ? `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.12; z-index: 0; pointer-events: none;"><img src="${settings.logo_url}" alt="" style="width: ${forPrint ? '100px' : '120px'}; height: auto;" onerror="this.parentElement.style.display='none';"></div>` : ''}
            
            <div style="display: flex; gap: ${forPrint ? '10px' : '12px'}; align-items: start; flex: 1; position: relative; z-index: 1;">
              <!-- Photo with Frame -->
              <div style="flex-shrink: 0; position: relative;">
                <div style="padding: 3px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 8px;">
                  ${photoUrl ? 
                    `<img src="${photoUrl}" alt="Foto ${student.nama}" style="width: ${photoSize}; height: ${forPrint ? '93px' : '106px'}; object-fit: cover; border: 2px solid white; border-radius: 6px; display: block;" onerror="this.src=''; this.alt=''; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div style="display: none; width: ${photoSize}; height: ${forPrint ? '93px' : '106px'}; background: #f1f5f9; border: 2px solid white; border-radius: 6px; align-items: center; justify-content: center; font-size: ${forPrint ? '9px' : `${baseSize * 0.75}px`}; color: #94a3b8; text-align: center; font-weight: 600;">FOTO<br>3x4</div>` :
                    `<div style="width: ${photoSize}; height: ${forPrint ? '93px' : '106px'}; background: #f1f5f9; border: 2px solid white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: ${forPrint ? '9px' : `${baseSize * 0.75}px`}; color: #94a3b8; text-align: center; font-weight: 600;">FOTO<br>3x4</div>`
                  }
                </div>
              </div>
              
              <!-- Info -->
              <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: space-between;">
                <div>
                  <div style="background: linear-gradient(135deg, #1e3a8a, #3b82f6); padding: ${forPrint ? '4px 8px' : '5px 10px'}; border-radius: 6px; margin-bottom: ${forPrint ? '6px' : '8px'};">
                    <div style="font-size: ${forPrint ? '7px' : `${baseSize * 0.7}px`}; color: rgba(255,255,255,0.9); font-weight: 600; margin-bottom: 1px;">NISN</div>
                    <div style="font-size: ${forPrint ? '10px' : `${baseSize * 0.95}px`}; color: white; font-weight: 800; letter-spacing: 0.5px; font-family: 'Courier New', monospace;">${student.nis}</div>
                  </div>
                  
                  <table style="width: 100%; font-size: ${fontSize}; color: #1e293b;">
                    <tr>
                      <td style="padding: ${forPrint ? '2px 0' : '3px 0'}; vertical-align: top; width: ${forPrint ? '42px' : '48px'}; font-weight: 700; color: #475569;">Nama</td>
                      <td style="padding: ${forPrint ? '2px 0' : '3px 0'}; vertical-align: top; width: 5px; font-weight: 700;">:</td>
                      <td style="padding: ${forPrint ? '2px 0' : '3px 0'}; vertical-align: top; font-weight: 800; color: #1e3a8a; line-height: 1.3;">${student.nama.length > 22 ? student.nama.substring(0, 22) + '...' : student.nama}</td>
                    </tr>
                    <tr>
                      <td style="padding: ${forPrint ? '2px 0' : '3px 0'}; vertical-align: top; font-weight: 600; color: #475569;">Kelas</td>
                      <td style="padding: ${forPrint ? '2px 0' : '3px 0'}; vertical-align: top;">:</td>
                      <td style="padding: ${forPrint ? '2px 0' : '3px 0'}; vertical-align: top; font-weight: 700; color: #0f172a;">${student.kelas}</td>
                    </tr>
                    <tr>
                      <td style="padding: ${forPrint ? '2px 0' : '3px 0'}; vertical-align: top; font-weight: 600; color: #475569;">TTL</td>
                      <td style="padding: ${forPrint ? '2px 0' : '3px 0'}; vertical-align: top;">:</td>
                      <td style="padding: ${forPrint ? '2px 0' : '3px 0'}; vertical-align: top; font-size: ${forPrint ? '7.5px' : `${baseSize * 0.8}px`}; line-height: 1.3;">${student.tempat_lahir || '-'}, ${student.tanggal_lahir || '-'}</td>
                    </tr>
                    <tr>
                      <td style="padding: ${forPrint ? '2px 0' : '3px 0'}; vertical-align: top; font-weight: 600; color: #475569;">Alamat</td>
                      <td style="padding: ${forPrint ? '2px 0' : '3px 0'}; vertical-align: top;">:</td>
                      <td style="padding: ${forPrint ? '2px 0' : '3px 0'}; vertical-align: top; font-size: ${forPrint ? '7px' : `${baseSize * 0.75}px`}; line-height: 1.3;">${student.alamat ? (student.alamat.length > 45 ? student.alamat.substring(0, 45) + '...' : student.alamat) : '-'}</td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- Footer with Barcode -->
            <div style="margin-top: ${forPrint ? '8px' : '10px'}; padding-top: ${forPrint ? '6px' : '8px'}; border-top: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: end; gap: ${forPrint ? '8px' : '10px'};">
              <div style="flex: 0 0 auto;">
                <div style="font-size: ${forPrint ? '6.5px' : `${baseSize * 0.65}px`}; color: #64748b; font-weight: 600; margin-bottom: 2px;">Berlaku s/d:</div>
                <div style="font-size: ${forPrint ? '8px' : `${baseSize * 0.8}px`}; font-weight: 700; color: #1e3a8a;">${new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' })}</div>
              </div>
              
              <!-- Barcode NISN -->
              <div style="flex: 0 0 auto; text-align: center; background: white; padding: ${forPrint ? '3px 6px' : '4px 8px'}; border: 1px solid #cbd5e1; border-radius: 4px;">
                <svg width="${forPrint ? '60' : '70'}" height="${forPrint ? '20' : '24'}" style="display: block;">
                  ${generateBarcode(student.nis, forPrint)}
                </svg>
                <div style="font-size: ${forPrint ? '5.5px' : `${baseSize * 0.6}px`}; color: #475569; font-weight: 600; margin-top: 1px; font-family: 'Courier New', monospace;">${student.nis}</div>
              </div>
              
              <div style="flex: 1; text-align: right; min-width: 0;">
                <div style="font-size: ${forPrint ? '6px' : `${baseSize * 0.6}px`}; color: #64748b; margin-bottom: ${forPrint ? '16px' : '20px'};">Kepala Sekolah</div>
                <div style="font-size: ${forPrint ? '6.5px' : `${baseSize * 0.7}px`}; font-weight: 700; color: #1e3a8a; border-top: 1px solid #1e3a8a; padding-top: 2px; display: inline-block; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${settings.nama_kepsek || '________'}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateBarcode(text, forPrint) {
      // Simple barcode generator (Code 39 style bars)
      const width = forPrint ? 60 : 70;
      const height = forPrint ? 20 : 24;
      const barWidth = width / (text.length * 2);
      
      let bars = '';
      for (let i = 0; i < text.length; i++) {
        const x = i * barWidth * 2;
        const isEven = i % 2 === 0;
        bars += `<rect x="${x}" y="0" width="${barWidth}" height="${height}" fill="${isEven ? '#1e3a8a' : '#3b82f6'}"/>`;
      }
      
      return bars;
    }

    function renderPrintAttendance(container) {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const classes = getClasses();

      container.innerHTML = `
        <h2 style="font-size: ${baseSize * 2}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 24px 0;">Cetak Absensi Manual</h2>
        
        <div style="background: white; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 800px;">
          <p style="font-size: ${baseSize}px; color: #64748b; margin: 0 0 24px 0;">Cetak daftar absensi dengan kotak centang untuk absensi manual menggunakan bolpoin.</p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
            <div>
              <label for="printClass" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Pilih Kelas</label>
              <select id="printClass" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                <option value="">-- Pilih Kelas --</option>
                ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
              </select>
            </div>
            
            <div>
              <label for="printMonth" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Bulan</label>
              <input type="month" id="printMonth" value="${new Date().toISOString().slice(0, 7)}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
            </div>
          </div>

          <button onclick="generatePrintableAttendance()" class="btn" style="background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px 32px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">
            üñ®Ô∏è Cetak Daftar Absensi
          </button>
        </div>
      `;
    }

    function generatePrintableAttendance() {
      const printClass = document.getElementById('printClass').value;
      const printMonth = document.getElementById('printMonth').value;

      if (!printClass) {
        showToast('Silakan pilih kelas terlebih dahulu', 'error');
        return;
      }

      const students = getStudents().filter(s => s.kelas === printClass);
      if (students.length === 0) {
        showToast('Tidak ada siswa di kelas ini', 'error');
        return;
      }

      const settings = getSettings();
      const tutors = getTutors();
      const waliKelas = tutors.find(t => t.kelas === printClass && t.jabatan === 'Wali Kelas');

      const [year, month] = printMonth.split('-');
      const monthName = new Date(year, month - 1).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
      const daysInMonth = new Date(year, month, 0).getDate();

      const printArea = document.getElementById('printArea');
      
      printArea.innerHTML = `
        <div style="width: 297mm; padding: 15mm; font-family: Arial, sans-serif; font-size: 11px;">
          <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px;">
            ${settings.logo_url ? `<img src="${settings.logo_url}" alt="Logo" style="height: 50px; margin-bottom: 8px;" onerror="this.style.display='none';">` : ''}
            <h2 style="margin: 3px 0; font-size: 16px;">${settings.nama_lembaga || 'NAMA LEMBAGA'}</h2>
            <p style="margin: 2px 0; font-size: 10px;">${settings.alamat_lembaga || ''}</p>
            <p style="margin: 2px 0; font-size: 10px;">Telp: ${settings.telp_lembaga || '-'} | Email: ${settings.email_lembaga || '-'}</p>
          </div>
          
          <h3 style="text-align: center; margin: 15px 0; font-size: 14px;">DAFTAR HADIR SISWA</h3>
          
          <table style="width: 100%; margin-bottom: 15px; font-size: 11px;">
            <tr>
              <td style="width: 100px;">Kelas</td>
              <td style="width: 10px;">:</td>
              <td style="font-weight: bold;">${printClass}</td>
              <td style="width: 100px; text-align: right;">Bulan</td>
              <td style="width: 10px;">:</td>
              <td style="font-weight: bold;">${monthName}</td>
            </tr>
            <tr>
              <td>Wali Kelas</td>
              <td>:</td>
              <td>${waliKelas?.nama_tutor || '___________________'}</td>
              <td style="text-align: right;">Jumlah Siswa</td>
              <td>:</td>
              <td style="font-weight: bold;">${students.length} siswa</td>
            </tr>
          </table>
          
          <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
            <thead>
              <tr style="background: #f0f0f0;">
                <th rowspan="2" style="border: 1px solid #000; padding: 6px; width: 30px;">No</th>
                <th rowspan="2" style="border: 1px solid #000; padding: 6px; width: 80px;">NIS</th>
                <th rowspan="2" style="border: 1px solid #000; padding: 6px; text-align: left;">Nama Siswa</th>
                <th colspan="${daysInMonth}" style="border: 1px solid #000; padding: 6px;">Tanggal</th>
                <th rowspan="2" style="border: 1px solid #000; padding: 6px; width: 30px;">H</th>
                <th rowspan="2" style="border: 1px solid #000; padding: 6px; width: 30px;">S</th>
                <th rowspan="2" style="border: 1px solid #000; padding: 6px; width: 30px;">I</th>
                <th rowspan="2" style="border: 1px solid #000; padding: 6px; width: 30px;">A</th>
              </tr>
              <tr style="background: #f0f0f0;">
                ${Array.from({ length: daysInMonth }, (_, i) => `<th style="border: 1px solid #000; padding: 3px; width: 18px;">${i + 1}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${students.map((student, index) => `
                <tr>
                  <td style="border: 1px solid #000; padding: 6px; text-align: center;">${index + 1}</td>
                  <td style="border: 1px solid #000; padding: 6px;">${student.nis}</td>
                  <td style="border: 1px solid #000; padding: 6px;">${student.nama}</td>
                  ${Array.from({ length: daysInMonth }, () => `<td style="border: 1px solid #000; padding: 3px; height: 20px;"></td>`).join('')}
                  <td style="border: 1px solid #000; padding: 3px;"></td>
                  <td style="border: 1px solid #000; padding: 3px;"></td>
                  <td style="border: 1px solid #000; padding: 3px;"></td>
                  <td style="border: 1px solid #000; padding: 3px;"></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          <div style="margin-top: 15px; font-size: 10px;">
            <p style="margin: 3px 0;"><strong>Keterangan:</strong></p>
            <p style="margin: 3px 0;">H = Hadir | S = Sakit | I = Izin | A = Alpha</p>
            <p style="margin: 3px 0;">Beri tanda centang (‚úì) atau titik (‚Ä¢) pada kolom tanggal sesuai status kehadiran</p>
          </div>
          
          <div style="margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; font-size: 11px;">
            <div>
              <p style="margin: 3px 0;">Mengetahui,</p>
              <p style="margin: 3px 0;">Kepala Sekolah</p>
              <div style="height: 50px;"></div>
              <p style="margin: 3px 0; font-weight: bold;">${settings.nama_kepsek || '___________________'}</p>
              <p style="margin: 3px 0;">NIP. ${settings.nip_kepsek || '___________________'}</p>
            </div>
            
            <div style="text-align: right;">
              <p style="margin: 3px 0;">${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
              <p style="margin: 3px 0;">Wali Kelas ${printClass}</p>
              <div style="height: 50px;"></div>
              <p style="margin: 3px 0; font-weight: bold;">${waliKelas?.nama_tutor || '___________________'}</p>
              <p style="margin: 3px 0;">NIP. ${waliKelas?.nip || '___________________'}</p>
            </div>
          </div>
        </div>
      `;
      
      printArea.style.display = 'block';
      window.print();
      printArea.style.display = 'none';
    }



    function showUploadPhotoForm() {
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const modal = document.getElementById('uploadPhotoModal');
      const students = getStudents();
      
      modal.style.display = 'block';
      modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 20px;">
          <div style="background: white; padding: 32px; border-radius: 12px; max-width: 600px; width: 90%; margin: auto;">
            <h3 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 16px 0;">Upload Foto Siswa</h3>
            
            <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 16px; margin-bottom: 24px; border-radius: 8px;">
              <p style="font-size: ${baseSize * 0.9}px; color: #92400e; margin: 0 0 8px 0; font-weight: 600;">üí° Tips Upload Foto:</p>
              <ul style="font-size: ${baseSize * 0.85}px; color: #92400e; margin: 0; padding-left: 20px;">
                <li>Gunakan nama file sesuai <strong>NISN siswa</strong> (contoh: 0012345678.jpg)</li>
                <li>Upload foto ke layanan hosting gambar (Google Drive, Imgur, dll)</li>
                <li>Pastikan link foto bisa diakses publik</li>
                <li>Format yang didukung: JPG, PNG</li>
              </ul>
            </div>
            
            <form id="uploadPhotoForm" onsubmit="handleUploadPhoto(event)">
              <div style="margin-bottom: 16px;">
                <label for="photo_nis" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Pilih Siswa (NISN)</label>
                <select id="photo_nis" required style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                  <option value="">-- Pilih Siswa --</option>
                  ${students.map(s => `<option value="${s.nis}">${s.nis} - ${s.nama}</option>`).join('')}
                </select>
              </div>
              
              <div style="margin-bottom: 16px;">
                <label for="photo_url_input" style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">URL Foto</label>
                <input type="url" id="photo_url_input" required placeholder="https://example.com/foto/0012345678.jpg" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: ${baseSize}px;">
                <p style="font-size: ${baseSize * 0.85}px; color: #64748b; margin: 4px 0 0 0;">Paste URL foto yang sudah diupload ke hosting</p>
              </div>
              
              <div id="photoPreview" style="margin-bottom: 16px; display: none;">
                <label style="display: block; font-size: ${baseSize}px; font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Preview Foto</label>
                <img id="previewImage" src="" alt="Preview" style="max-width: 200px; max-height: 250px; border: 2px solid #cbd5e1; border-radius: 8px;">
              </div>
              
              <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button type="button" onclick="previewPhoto()" style="flex: 1; background: #64748b; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">üëÅÔ∏è Preview</button>
                <button type="submit" class="btn" style="flex: 1; background: ${config.primary_color || defaultConfig.primary_color}; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">üíæ Simpan Foto</button>
                <button type="button" onclick="closeUploadPhotoForm()" style="flex: 1; background: #ef4444; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">Batal</button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    function closeUploadPhotoForm() {
      document.getElementById('uploadPhotoModal').style.display = 'none';
    }

    function previewPhoto() {
      const photoUrl = document.getElementById('photo_url_input').value;
      const previewDiv = document.getElementById('photoPreview');
      const previewImg = document.getElementById('previewImage');
      
      if (!photoUrl) {
        showToast('Masukkan URL foto terlebih dahulu', 'error');
        return;
      }
      
      previewImg.src = photoUrl;
      previewDiv.style.display = 'block';
      
      previewImg.onerror = function() {
        showToast('Gagal memuat foto. Periksa URL foto Anda', 'error');
        previewDiv.style.display = 'none';
      };
    }

    function handleUploadPhoto(event) {
      event.preventDefault();
      
      const nis = document.getElementById('photo_nis').value;
      const photoUrl = document.getElementById('photo_url_input').value;
      
      const student = allData.find(s => s.type === 'student' && s.nis === nis);
      
      if (!student) {
        showToast('Siswa tidak ditemukan', 'error');
        return;
      }
      
      student.foto_url = photoUrl;
      const result = updateRecord(student);
      
      if (result.success) {
        showToast('Foto siswa berhasil disimpan', 'success');
        closeUploadPhotoForm();
      } else {
        showToast('Gagal menyimpan foto siswa', 'error');
      }
    }

    window.switchView = switchView;
    window.toggleSettingsMenu = toggleSettingsMenu;
    window.handleSaveSettings = handleSaveSettings;
    window.showAddNoteForm = showAddNoteForm;
    window.closeNoteForm = closeNoteForm;
    window.handleAddNote = handleAddNote;
    window.deleteNote = deleteNote;
    function showTutorDetail(id) {
      const tutor = allData.find(t => t._id === id);
      if (!tutor) return;

      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const modal = document.getElementById('tutorFormModal');
      
      modal.style.display = 'block';
      modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 20px;">
          <div style="background: white; padding: 32px; border-radius: 12px; max-width: 700px; width: 90%; margin: auto;">
            <h3 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${config.text_color || defaultConfig.text_color}; margin: 0 0 24px 0;">Detail Tutor</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
              <div>
                <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Nama Lengkap</label>
                <div style="font-size: ${baseSize}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color};">${tutor.nama_tutor}</div>
              </div>
              
              <div>
                <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">NIP</label>
                <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.nip || '-'}</div>
              </div>
              
              <div>
                <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Jabatan</label>
                <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.jabatan}</div>
              </div>
              
              <div>
                <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Kelas</label>
                <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.kelas || '-'}</div>
              </div>
              
              <div>
                <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Tempat Lahir</label>
                <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.tempat_lahir || '-'}</div>
              </div>
              
              <div>
                <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Tanggal Lahir</label>
                <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.tanggal_lahir || '-'}</div>
              </div>
              
              <div style="grid-column: 1 / -1;">
                <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Alamat</label>
                <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.alamat || '-'}</div>
              </div>
              
              <div>
                <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">Pendidikan Terakhir</label>
                <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.pendidikan_terakhir || '-'}</div>
              </div>
              
              <div>
                <label style="display: block; font-size: ${baseSize * 0.85}px; color: #64748b; margin-bottom: 4px;">No. Telepon</label>
                <div style="font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">${tutor.no_telp || '-'}</div>
              </div>
            </div>
            
            <div style="display: flex; gap: 12px;">
              <button onclick="closeTutorForm()" style="flex: 1; background: #64748b; color: white; padding: 12px; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer;">Tutup</button>
            </div>
          </div>
        </div>
      `;
    }

    window.showAddTutorForm = showAddTutorForm;
    window.showTutorDetail = showTutorDetail;
    window.closeTutorForm = closeTutorForm;
    window.handleAddTutor = handleAddTutor;
    window.deleteTutor = deleteTutor;
    window.generateSK = generateSK;
    window.filterStudentsByClass = filterStudentsByClass;
    window.showAddStudentForm = showAddStudentForm;
    window.closeStudentForm = closeStudentForm;
    window.handleAddStudent = handleAddStudent;
    window.deleteStudent = deleteStudent;
    window.showStudentDetail = showStudentDetail;
    window.closeStudentDetail = closeStudentDetail;
    window.editStudent = editStudent;
    window.printStudentCard = printStudentCard;
    window.showUploadPhotoForm = showUploadPhotoForm;
    window.closeUploadPhotoForm = closeUploadPhotoForm;
    window.previewPhoto = previewPhoto;
    window.handleUploadPhoto = handleUploadPhoto;
    window.generatePrintableAttendance = generatePrintableAttendance;
    window.filterKTAByClass = filterKTAByClass;
    window.previewKTA = previewKTA;
    window.generateKTA = generateKTA;

    // Multi-select jabatan functions
    function toggleJabatanDropdown() {
      const dropdown = document.getElementById('jabatanDropdown');
      if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      }
    }

    function updateJabatanSelection() {
      const checkboxes = document.querySelectorAll('#jabatanDropdown input[type="checkbox"]:checked');
      const selected = Array.from(checkboxes).map(cb => cb.value);
      const input = document.getElementById('jabatan');
      
      if (selected.length === 0) {
        input.value = '';
      } else if (selected.length === 1) {
        input.value = selected[0];
      } else {
        input.value = selected.join(', ');
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('jabatanDropdown');
      const input = document.getElementById('jabatan');
      
      if (dropdown && input && dropdown.style.display === 'block') {
        if (!dropdown.contains(event.target) && event.target !== input) {
          dropdown.style.display = 'none';
        }
      }
    });

    window.toggleJabatanDropdown = toggleJabatanDropdown;
    window.updateJabatanSelection = updateJabatanSelection;

    function exportTutorsToExcel() {
      const tutors = getTutors();
      
      if (tutors.length === 0) {
        showToast('Tidak ada data tutor untuk diekspor', 'error');
        return;
      }

      if (typeof XLSX === 'undefined') {
        showToast('Library Excel belum dimuat. Silakan refresh halaman', 'error');
        return;
      }

      // Prepare data for export
      const exportData = tutors.map((tutor, index) => ({
        'No': index + 1,
        'Nama Tutor': tutor.nama_tutor,
        'NIP': tutor.nip || '-',
        'Jabatan': tutor.jabatan,
        'Kelas': tutor.kelas || '-',
        'Tempat Lahir': tutor.tempat_lahir || '-',
        'Tanggal Lahir': tutor.tanggal_lahir || '-',
        'Alamat': tutor.alamat || '-',
        'Pendidikan Terakhir': tutor.pendidikan_terakhir || '-',
        'No. Telepon': tutor.no_telp || '-'
      }));

      // Create worksheet
      const ws = XLSX.utils.json_to_sheet(exportData);

      // Set column widths
      ws['!cols'] = [
        { wch: 5 },   // No
        { wch: 25 },  // Nama Tutor
        { wch: 18 },  // NIP
        { wch: 30 },  // Jabatan
        { wch: 12 },  // Kelas
        { wch: 15 },  // Tempat Lahir
        { wch: 15 },  // Tanggal Lahir
        { wch: 35 },  // Alamat
        { wch: 25 },  // Pendidikan Terakhir
        { wch: 15 }   // No. Telepon
      ];

      // Create workbook
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Data Tutor');

      // Generate filename with timestamp
      const settings = getSettings();
      const timestamp = new Date().toISOString().slice(0, 10);
      const filename = `Data_Tutor_${settings.nama_lembaga || 'Lembaga'}_${timestamp}.xlsx`;

      // Download file
      XLSX.writeFile(wb, filename);

      showToast(`Data ${tutors.length} tutor berhasil diekspor`, 'success');
    }

    window.exportTutorsToExcel = exportTutorsToExcel;

    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99d46a71a49ffd69',t:'MTc2MjkzMzU4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>